<!-- Import Polymer -->
<link defer rel="import" href="../../bower_components/polymer/polymer.html" />

<!-- Import style module -->
<link defer rel="import" href="../../css/px-catalog-styles.html" />
<link defer rel="import" href="../../bower_components/px-theme/px-theme-styles.html" />

<!-- Import external dependencies -->
<link async rel="import" href="../../bower_components/iron-collapse/iron-collapse.html" />
<link async rel="import" href="../../bower_components/iron-ajax/iron-ajax.html" />
<link async rel="import" href="../../bower_components/app-route/app-route.html" />
<link defer rel="import" href="../../bower_components/app-route/app-location.html" />
<link async rel="import" href="../../bower_components/px-spinner/px-spinner.html" />
<link async rel="import" href="../../bower_components/px-toggle/px-toggle.html" />
<link defer rel="import" href="../../bower_components/px-icon-set/px-icon-set-navigation.html">
<link defer rel="import" href="../../bower_components/px-icon-set/px-icon.html">
<link defer rel="import" href="../../bower_components/px-demo/px-demo-theme-switcher.html">
<link defer rel="import" href="../../bower_components/app-layout/app-drawer/app-drawer.html">
<link defer rel="import" href="../../bower_components/iron-media-query/iron-media-query.html">

<!-- Import local dependencies -->
<link async rel="import" href="../px-catalog-router/px-catalog-router.html" />
<link async rel="import" href="../px-catalog-sidebar/px-sb.html" />

<dom-module id="px-catalog">
  <template>
    <style include="px-theme-styles" is="custom-style"></style>
    <style include="px-catalog-styles" is="custom-style"></style>

    <style>
      .catalog__spinner {
        position: absolute;
        z-index: 999;
        width: 100%;
        height: 100%;
        background: #fff;
      }
      .dark-theme {
        background: #23343F;
      }
      #spinner px-spinner {
        margin-left: auto;
        margin-right: auto;
      }
    </style>

    <!-- Communicates the state of dark theme toggle to child iframes -->
    <px-demo-theme-switcher-parent origin="https://www.predix-ui.com" is-dark-theme="{{darkTheme}}" child-frame="{{childFrame}}"></px-demo-theme-switcher-parent>

    <!-- Load the navigation JSON file -->
    <iron-ajax
        auto
        url="navigation.json"
        last-response="{{navJSON}}">
    </iron-ajax>

    <!-- Media query to update the nav width on landscape-size screens. The
         Shady DOM shim won't re-evaluate the --app-nav-width style variable
         in a media query in our CSS; this query helps force an update. -->
    <iron-media-query query="(min-width: 450px)" query-matches="{{isLandscapeUp}}"></iron-media-query>
    <!-- Media query to fix nav open on desktop-up screens -->
    <iron-media-query query="(min-width: 1024px)" query-matches="{{isDesktopUp}}"></iron-media-query>

    <!-- Catch the route and send it to `app-route` to munge the path -->
    <app-location
        route="{{_route}}"
        query-params="{{_queryParams}}"
        path="{{_path}}"
        use-hash-as-path>
    </app-location>
    <!-- Fetch the base route information we need (type/name) and assign to `route` -->
    <app-route
        route="{{_route}}"
        pattern="/:type/:name"
        data="{{route}}"
        tail="{{_routeTail}}">
    </app-route>
    <!-- Pass the routing data to the custom router to handle state and redirects -->
    <px-catalog-router
        raw-route="{{_route}}"
        raw-path="{{_path}}"
        query-params="{{_queryParams}}"
        app-path="{{route}}"
        app-tail="{{_routeTail.path}}"
        active-name="{{activeName}}"
        active-type="{{activeType}}"
        frame-url="{{frameUrl}}"
        nav-JSON="{{navJSON}}"
        dark-theme="{{darkTheme}}">
    </px-catalog-router>

      <!-- CATALOG HEADER -->
      <div class="catalog-header">
        <!-- Menu button -->
        <div class="menu-button" on-tap="toggleMenu">
          <px-icon icon="[[_getMenuIcon(menuOpened)]]"></px-icon>
        </div>
        <!-- Logo -->
        <div class="logo">
          <picture class="logo__picture">
            <source srcset="../../img/px-dev-logo.webp" class="logo__image" type="image/webp">
            <source srcset="../../img/px-dev-logo.png"  class="logo__image" type="image/png">
            <img src="../../img/px-dev-logo.png" class="logo__image" alt="Predix Developer Network">
            <span class="logo__text">Predix Design System</span>
          </picture>
        </div>
        <!-- Theme toggle -->
        <div class="theme-toggle">
          <span class="theme-toggle__text">Dark Theme</span>
          <px-toggle size="small" checked="{{darkTheme}}" role="button" aria-pressed="false"></px-toggle>
        </div>
      </div>

      <!-- CATALOG PAGE -->
      <div class="catalog-page">
        <div class="catalog-page__spinner" active$="[[spinnerActive]]">
          <px-spinner size="150"></px-spinner>
        </div>
        <iframe class="catalog-page__iframe" src="../../pages/home.html" id="frameEl" name="iframe_a" allowfullscreen data-name$="[[name]]" data-type$="[[type]]" title="Main Documentation Content"></iframe>
      </div>

      <!-- CATALOG NAV -->
      <app-drawer class="catalog-nav" align="left" disable-swipe opened="{{menuOpened}}" persistent="[[isDesktopUp]]">
        <div class="catalog-nav__tree">
          <px-sb initial-nav="[[navJSON]]" active-name="{{activeName}}" active-type="{{activeType}}"></px-sb>
        </div>
      </app-drawer>

  </template>
  <script>
    Polymer({
      is: 'px-catalog',

      properties: {
        /**
         * The URL for the currently active iFrame. If nothing is set, defaults
         * to the catalog homepage.
         *
         * @type {String}
         */
        frameUrl: {
          type: String,
          value: '../../pages/home.html',
          observer: '_handleFrameUrlChanged'
        },

        /**
         * Set to `true` to show the spinner. Set to `false` to hide the spinner.
         *
         * @type {Boolean}
         */
        spinnerActive: {
          type: Boolean,
          value: true
        },

        /**
         * The navigation represented as JSON, loaded by an `iron-ajax` element
         * from the `navigation.json` file.
         *
         * @type {Object}
         */
        navJSON: {
          type: Object
        },

        /**
         * The active page name, from the sidebar (e.g. 'px-sass-doc')
         *
         * @type {String}
         */
        activeName: {
          type: String,
          observer: '_updateTitle'
        },

        /**
         * The active page type, from the sidebar (e.g. 'component')
         *
         * @type {String}
         */
        activeType: {
          type: String,
          observer: '_updateTitle'
        },

        /**
         * Place to hang iframe loading poller
         *
         * @type {Object}
         */
        _loadingPoller: {
          type: Object
        },

        /**
         * Whether to enable the dark theme for each component.
         */
        darkTheme: {
          type: Boolean,
          observer: '_handleDarkThemeChanged'
        },

        /**
         * Opens and closes the menu. The menu should remain open all the time
         * on desktop-up viewports.
         */
        menuOpened: {
          type: Boolean,
          value: false
        },

        /**
         * Automatically set to true when the viewport becomes larger than
         * desktop size.
         */
        isDesktopUp: {
          type: Boolean,
          observer: '_desktopBreakpointHit'
        },

        /**
         * Automatically set to true when the viewport becomes larger than
         * mobile landscape size (when the phone is on its side).
         */
        isLandscapeUp: {
          type: Boolean,
          observer: '_landscapeBreakpointHit'
        },

        /**
         * Reference to the child iFrame element, used to bind for communications
         * about theme changes.
         */
        childFrame: {
          type: HTMLElement
        }
      },

      listeners: {
        'px-sb-list-selected-item-changed': '_handleListItemChanged',
        'frameEl.load' : '_handleFrameLoad'
      },

      /**
       * Update the title in the <head> to match the active page.
       */
      _updateTitle: function() {
        this.debounce('update-title', function() {
          var type = this._formatType(this.activeType || '');
          var name = this._formatName(this.activeName || '');
          if (name || type) {
            document.title = 'Predix Design System' + (type.length ? ' ' + type : '') + (name.length ? '  | ' + name : '');
          }
        }, 100);
      },

      /**
       * Takes a URL routing `type` value, splits and capitalizes words.
       *
       * For example:
       * 'css' would become 'CSS'
       * 'components' would become 'Components'
       * 'new-thing' would become 'New Thing'
       *
       * @param {String} type
       * @return {String} Formatted string
       */
      _formatType: function(type) {
        if (!type || !type.length) {return '';}

        // CSS is a special case, capitalize it and return
        if (type === 'css') {return 'CSS';}

        return type
        // Split on '-' char
          .split('-')
        // Capitalize first letter
          .map(function(part){ return this._capitalizeFirstLetter(part); }.bind(this))
        // Join with a space
          .join(' ');
      },

      /**
       * Takes a URL routing `name` value, cleans up the words and capitalizes.
       *
       * For example:
       * 'px-app-nav' would become 'App Nav'
       * 'components' would become 'Components'
       * 'new-thing' would become 'New Thing'
       *
       * @param {String} type
       * @return {String} Formatted string
       */
      _formatName: function(name) {
        if (!name || !name.length) {return '';}

        return name
        // Split on '-' char
          .split('-')
        // Remove 'px' (['px','app','nav'] -> ['app','nav'])
          .filter(function(part){ return part !== 'px'; })
        // Capitalize first letter
          .map(function(part){ return this._capitalizeFirstLetter(part); }.bind(this))
        // Join with a space
          .join(' ');
      },

      /**
       * Capitalizes the first character of a string if it is a letter.
       *
       * @param {String} str - 'hello'
       * @return {String} - 'Hello'
       */
      _capitalizeFirstLetter: function(str) {
        return str.substring(0,1).toUpperCase() + str.substring(1);
      },

      /**
       * When the URL the iFrame should show is updated, sync the new URL with
       * the iFrame on the page.
       */
      _handleFrameUrlChanged: function(newUrl) {
        var frame = this.$.frameEl;
        if ((typeof newUrl === 'string') && frame) {
          // Try to get the frame location
          var frameLocation = window.frames['iframe_a'].location;
          // If the location is blank, this is a first load and we can assume
          // the current page is `iframe.src`'s normalized pathname'
          var currentPath = (frameLocation.pathname !== 'blank') ? frameLocation.pathname : this._normalizePath(frame.src);
          // Normalize the new path
          var newPath = this._normalizePath(newUrl);

          if (currentPath !== newPath) {
            // Replace location like this so we don't add an entry to the
            // history stack. The router will do that for us.
            window.frames['iframe_a'].location.replace(newUrl);
            // Activate the spinner
            this.set('spinnerActive', true);
          }
        }
      },

      /**
       * Given a relative or absolute URL, returns the normalized pathname.
       *
       * Example:
       *
       *     _normalizePath('../../pages/home.html');
       *     //=> '/pages/home.html'
       *
       *     _normalizePath('http://predix-ui.com/px-component/px-component/')
       *     //=> '/px-component/px-component/'
       *
       * @param {String} url
       * @return {String}
       */
      _normalizePath: function(url) {
        var linkTag = document.createElement('a');
        linkTag.href = url;
        return linkTag.pathname || '';
      },


      /**
       * If a new page is selected and the viewport is smaller than desktop,
       * ensures the menu is closed.
       */
      _handleListItemChanged: function() {
        if (!this.isDesktopUp && this.menuOpened) {
          this.menuOpened = false;
        }
      },

      /**
       * When the viewport expands to desktop-up, ensure the menu is opened.
       * When the viewport shrinks to desktop-down, ensure the menu is closed.
       */
      _desktopBreakpointHit: function(isDesktopUp) {
        if (isDesktopUp && !this.menuOpened) {
          this.menuOpened = true;
        }
        else if (!isDesktopUp && this.menuOpened) {
          this.menuOpened = false;
        }
      },

      /**
       * A media query is used in the CSS to change the app-drawer component's
       * --app-drawer-width style variable. In Shady DOM that variable will not
       * be automatically re-evaluated when the screen size changes. When the
       * screen moves above or below that breakpoint, the app-drawer will be
       * forced to update its style variables.
       */
      _landscapeBreakpointHit: function(newVal, oldVal) {
        if (typeof newVal === 'boolean' && typeof oldVal === 'boolean') {
          var drawer = Polymer.dom(this.root).querySelector('app-drawer');
          if (drawer !== null && drawer.updateStyles) {
            drawer.updateStyles();
          }
        }
      },

      _getMenuIcon: function(menuOpened) {
        if (menuOpened) {
          return 'px-nav:close';
        }
        else {
          return 'px-nav:hamburger';
        }
      },

      toggleMenu: function() {
        this.menuOpened = !this.menuOpened;
      },

      /**
       * When the frame finishes loading, ensure the spinner is hidden.
       */
      _handleFrameLoad: function() {
        var url = this.frameUrl;
        var countNoOfTimesFailedToFindDemoEl = 0;
        if(url.indexOf('/pages/') < 0){
          clearInterval(this._loadingPoller);
          this._loadingPoller = setInterval(checkComponentDemoAttached.bind(this), 250);
          function checkComponentDemoAttached() {
            var led = this.$.frameEl.contentDocument.body.querySelector('local-element-demo');
            if(led && led.isAttached){
              this._clearSpinner();
              clearInterval(this._loadingPoller);
            };
            if(!led){
              countNoOfTimesFailedToFindDemoEl += 1;
              if (countNoOfTimesFailedToFindDemoEl === 10){
                // we didn't find the demo element in 2.5 seconds clear the spinner anyway.
                this._clearSpinner();
                clearInterval(this._loadingPoller);
              }
            }
          };
        } else{
          this._clearSpinner();
        }

        // Update the child frame
        this.childFrame = this.$.frameEl;
      },

      _clearSpinner: function(){
        if (this.spinnerActive) {
          this.spinnerActive = false;
        }
      },

      /**
      * Sets the background color of the spinner background based on the darkTheme toggle.
      */
      _handleDarkThemeChanged: function(newValue) {
        this.toggleClass('dark-theme', newValue, this.$.spinner);
        this.fire('px-dark-theme-changed', {"darkTheme": newValue});
      }
    });
  </script>
</dom-module>
