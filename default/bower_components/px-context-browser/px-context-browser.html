<html><head><link rel="import" href="../polymer/polymer.html"><link rel="import" href="../web-animations-js/web-animations-next-lite.min.html"><link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html"><link rel="import" href="../iron-a11y-keys/iron-a11y-keys.html"><link rel="import" href="../iron-media-query/iron-media-query.html"><link rel="import" href="../iron-dropdown/iron-dropdown.html"><link rel="import" href="../px-app-helpers/px-app-asset/px-app-asset-behavior-graph.html"><link rel="import" href="../px-app-helpers/px-app-asset/px-app-asset-behavior-selectable.html"><link rel="import" href="../px-app-helpers/px-app-asset/px-app-asset-behavior-activatable.html"><link rel="import" href="../px-app-helpers/px-app-asset/px-app-asset-behavior-favoritable.html"><link rel="import" href="../app-localize-behavior/app-localize-behavior.html"><link rel="import" href="css/px-context-browser-styles.html"><link rel="import" href="css/px-context-browser-animations-styles.html"><link rel="import" href="px-context-browser-panel.html"><link rel="import" href="px-context-browser-header.html"><link rel="import" href="px-context-browser-item.html"><link rel="import" href="px-context-browser-columns.html"><link rel="import" href="px-context-browser-filter.html"><link rel="import" href="px-context-browser-contextual-notification.html"><link rel="import" href="px-context-browser-favorited-temp.html"></head><body><dom-module id="px-context-browser"><template><style include="px-context-browser-styles"></style><style include="px-context-browser-animations-styles"></style><template is="dom-if" if="[[_collapseQueryIsValid(collapseAt)]]"><iron-media-query query$="(max-width: {{_getCollapseQuery(collapseAt)}})" query-matches="{{_belowCollapseSize}}"></iron-media-query></template><array-selector id="selector" items="[[__context.columns]]" selected="{{__activeContext}}"></array-selector><px-context-browser-favorited-temp id="favoritedCop" favorited-behavior-element="[[__this]]" favorited="[[favorited]]" current-favorited="{{currentFavorited}}" opened="[[opened]]" favorited-opened="[[favoritedOpened]]"></px-context-browser-favorited-temp><div class="backdrop" visible$="[[_isCollapseOpened(collapsed, opened, favoritedOpened)]]"></div><iron-dropdown id="dropdown" no-overlap="" horizontal-offset="-15" vertical-align="[[_getDropdownVerticalAlign(collapsed)]]" horizontal-align="[[_getDropdownHorizontalAlign(collapsed)]]" opened="{{opened}}" position-target="[[_getPositionTarget(_positionTarget, collapsed)]]" on-iron-overlay-canceled="_handleBrowserCanceled" on-iron-overlay-opened="_handleBrowserOpened" on-iron-overlay-closed="_handleBrowserClosed"><px-context-browser-panel id="panel" slot="dropdown-content" has-header$="[[_isNotNull(active)]]" collapsed$="[[collapsed]]" show-loading-bar="[[loading]]"><px-context-browser-header id="header" slot="header" active$="[[_isNotNull(active)]]" label="[[_getItemProp(active, keys.label)]]" on-tap="_handleHeaderTapped" can-select="[[_isItemSelectable(active)]]" can-favorite="[[_showFavoritedAndItemFavoritable(showFavorited, active)]]" favorited="[[_isItemFavorited(active, favorited, favorited.*)]]" collapsed$="[[collapsed]]"></px-context-browser-header><px-context-browser-filter slot="filter" active$="[[showFilter]]" filter="{{filter}}" filtering="{{filtering}}" placeholder="[[localize('Filter')]]"></px-context-browser-filter><px-context-browser-columns slot="columns" active="[[__context.activeIndex]]" visible-count$="[[__activeContext.visibleCount]]" collapsed$="[[collapsed]]"><template is="dom-repeat" items="[[__context.columns]]" as="column"><div column$="[[column.index]]" class="column" slot="columns"><template is="dom-repeat" items="[[column.items]]" as="item" forcolumn="[[column.index]]" on-dom-change="_updateVisibleCount" filter="{{_getColumnFilter(column.index, filter, keys.label, filtering)}}"><px-context-browser-item label="[[_getItemProp(item, keys.label)]]" breadcrumbs="[[_getFavoritedItemPath(item)]]" selected="[[_isItemSelected(item, selected)]]" favorited="[[_isItemFavorited(item, favorited, favorited.*)]]" can-select="[[_isItemSelectable(item)]]" can-favorite="[[_showFavoritedAndItemFavoritable(showFavorited, item)]]" can-open="[[_isItemOpenable(showArrow, item)]]" on-tap="_handleItemTapped" tabindex="0" collapsed$="[[collapsed]]"></px-context-browser-item></template></div></template></px-context-browser-columns></px-context-browser-panel></iron-dropdown><iron-dropdown id="favoritedDropdown" no-overlap="" horizontal-offset="-15" vertical-align="[[_getDropdownVerticalAlign(collapsed)]]" horizontal-align="[[_getDropdownHorizontalAlign(collapsed)]]" opened="{{favoritedOpened}}" position-target="[[_getPositionTarget(_favoritedPositionTarget, collapsed)]]" on-iron-overlay-canceled="_handleFavoritedBrowserCanceled"><px-context-browser-panel id="favoritedPanel" slot="dropdown-content" collapsed$="[[collapsed]]" show-loading-bar="[[favoritedSyncing]]"><template is="dom-if" if="[[!_showFavoritedEmptyState(favorited, favorited.*)]]"><px-context-browser-filter slot="filter" active$="[[showFilter]]" filter="{{favoritedFilter}}" filtering="{{filtering}}" placeholder="[[localize('Filter')]]"></px-context-browser-filter><template is="dom-if" if="[[favoritedSyncFailed]]"><px-context-browser-contextual-notification slot="contextual-notification"></px-context-browser-contextual-notification></template><px-context-browser-columns slot="columns" active="0" visible-count$="[[_favoritedVisibleCount]]" collapsed$="[[collapsed]]"><div column="0" class="column" slot="columns"><template is="dom-repeat" id="favoritedRepeater" items="[[favorited]]" as="item" forcolumn="0" on-dom-change="_updateVisibleCountFavorited" filter="{{_getColumnFilterFavorited(favoritedFilter, keys.label, filtering)}}"><px-context-browser-item label="[[_getItemProp(item, keys.label)]]" breadcrumbs="[[_getFavoritedItemPath(item)]]" selected="[[_isItemSelected(item, selected)]]" favorited="[[_isItemFavorited(item, currentFavorited)]]" can-select="[[_isItemSelectable(item)]]" can-favorite="[[_showFavoritedAndItemFavoritable(showFavorited, item)]]" can-open="[[_isItemOpenable(showArrow, item)]]" on-tap="_handleItemTapped" tabindex="0" collapsed$="[[collapsed]]" style-as-favorite="" visible="[[favoritedOpened]]"></px-context-browser-item></template></div></px-context-browser-columns></template><template is="dom-if" if="[[_showFavoritedEmptyState(favorited, favorited.*)]]"><template is="dom-if" if="[[favoritedSyncFailed]]"><px-context-browser-contextual-notification slot="contextual-notification"></px-context-browser-contextual-notification></template><div slot="columns" class="context-browser-favorites--empty__container"><px-icon icon="px-nav:favorite" class="context-browser-favorites--empty__icon"></px-icon><div class="context-browser-favorites--empty__text regular">[[localize("You don't have any favorites yet.")]]</div><div class="context-browser-favorites--empty__subtext zeta">[[localize("To favorite a context\, click on the star while viewing a context in the context browser.")]]</div></div></template></px-context-browser-panel></iron-dropdown></template></dom-module><script>(function(){Polymer({is:'px-context-browser',behaviors:[PxAppBehavior.AssetGraph,PxAppBehavior.AssetSelectable,PxAppBehavior.AssetActivatable,PxAppBehavior.AssetFavoritable,Polymer.IronResizableBehavior,Polymer.AppLocalizeBehavior],properties:{showFavorited:{type:Boolean,value:!0,reflectToAttribute:!0},showArrow:{type:Boolean,value:!1},showFilter:{type:Boolean,value:!1},filter:{type:String,notify:!0},favoritedFilter:{type:String,notify:!0},loadingTimeout:{type:Number,value:5e3,observer:'_handleLoadingTimeoutChanged'},loading:{type:Boolean,value:!1,readOnly:!0},openTrigger:{type:HTMLElement,observer:'_openTriggerChanged'},favoritedTrigger:{type:HTMLElement,observer:'_favoritedTriggerChanged'},opened:{type:Boolean,notify:!0,observer:'_handleInitialOpenedValue'},favoritedOpened:{type:Boolean,notify:!0,reflectToAttribute:!0},keepOpen:{type:Boolean},collapseAt:{type:Number},collapsed:{type:Boolean,value:!1,reflectToAttribute:!0},favoritedSyncFailed:{type:Boolean,value:!1,notify:!0},favoritedSyncing:{type:Boolean,value:!1},language:{type:String,value:'en'},useKeyIfMissing:{type:Boolean,value:!0},resources:{type:Object,value:function(){return{en:{"You don't have any favorites yet.":'You don\'t have any favorites yet.',"To favorite a context, click on the star while viewing a context in the context browser.":'To favorite a context, click on the star while viewing a context in the context browser.',Filter:'Filter'}}}},_positionTarget:{type:HTMLElement},_panelEl:{type:HTMLElement},__rootColumn:{type:Object,computed:'_getRootColumn(__rootItems)'},__context:{type:Array,value:function(){return{columns:null,activeIndex:null}},computed:'_getColumns(activeMeta, __rootColumn)'},__activeContext:{type:Object},_belowCollapseSize:{type:Boolean,observer:'_handleBelowCollapseSizeChanged'},_cancelFilterFocus:{type:Boolean,value:!1},_favoritedVisibleCount:{type:Number},__this:HTMLElement},observers:['clearFilter(__context.activeIndex)','clearFilter(showFilter)','_linkActiveContext(__context.activeIndex)','_updateActiveLoading(activeMeta.item)','_updateCancelFilterFocus(__context.activeIndex)'],listeners:{"px-app-asset-children-updated":'_handleChildrenChanged',"iron-resize":'_handleResize',"px-context-browser-filter-focused":'_handleFilterFocused'},_handleFilterFocused(a){if(this._cancelFilterFocus){const b=Polymer.dom(a).rootTarget;b.blurFilter()}},_updateCancelFilterFocus(a){this.showFilter&&this.opened&&this.collapsed&&0===a&&(console.log('start cancel'),this._cancelFilterFocus=!0,this._cancelFilterFocusTask&&(this.cancelAsync(this._cancelFilterFocusTask),this._cancelFilterFocusTask=null),this._cancelFilterFocusTask=this.async(function(){console.log('stop cancel'),this._cancelFilterFocus=!1,this._cancelFilterFocusTask=null},200))},_collapseQueryIsValid(a){return!('number'!==typeof a)||('string'!==typeof a||'px'!==a.slice(-2)||isNaN(parseInt(a))?!1:!0)},_isCollapseOpened(a,b,c){return a&&(b||c)},_handleResize(a){this._positionTarget&&a&&Polymer.dom(a).rootTarget===this&&window.requestAnimationFrame(function(){setTimeout(function(){this.$.dropdown.refit()}.bind(this))}.bind(this))},created(){this._resetActiveTask=null,this._squashNextResetActiveTask=null,this._childLoadingHandler=null,this._cancelFilterFocusTask=null},ready(){this._favoritedCop=this.$.favoritedCop,this.__this=this},attached(){this._panelElement=Polymer.dom(this.root).querySelector('#panel')},detached(){this._panelElement=null},_getCollapseQuery(a){return'number'===typeof a?a+'px':('string'!==typeof a||'px'!==a.slice(-2))&&isNaN(parseInt(a))?void 0:a},_handleBelowCollapseSizeChanged(a){a&&!this.collapsed&&(this.collapsed=!0),!a&&this.collapsed&&(this.collapsed=!1)},_setLoadingStatus(a,b){this.set(`__context.columns.${a}.loading`,b)},_updateActiveLoading(a){if(this.loading&&this.cancelLoading(!1),a){const b=!this._assetGraph.isTerminal(a)&&!this._assetGraph.hasChildren(a);b&&this._startLoading(a,this._assetGraph.getPath(a))}},_handleLoadingTimeout(){this.cancelLoading(!0)},_handleChildrenChanged(a){const{item:b,path:c,children:d,isTerminal:e,hasChildren:f}=a.detail;if(this.activeMeta&&this.activeMeta.item&&this.activeMeta.item===b){let a=`__context.columns.${this.__context.activeIndex}.items`;this.set(a,[]),this.set(a,d),this.cancelLoading(!0)}else if(this.__context&&Array.isArray(this.__context.columns)&&null===b){let a=`__context.columns.0.items`;this.set(a,[]),this.set(a,d)}else if(this.__context&&Array.isArray(this.__context.columns)&&1<this.__context.columns.length)for(let a=1;a<this.__context.columns.length;a++)if(this.__context.columns[a].parent===b){let b=`__context.columns.${a}.items`;this.set(b,[]),this.set(b,d)}},_startLoading(a,b){if('number'!==typeof this.loadingTimeout||0>this.loadingTimeout)throw new Error(`px-context-browser expects the \`loadingTimeout\` property to be a non-negative number. The following invalid value was given:
          ${this.loadingTimeout}`);this._setLoading(!0),this.fire('px-app-asset-children-requested',{item:a,path:b}),'number'===typeof this.loadingTimeout&&0<this.loadingTimeout&&(this._childLoadingHandler=this.async(this._handleLoadingTimeout.bind(this,a),this.loadingTimeout))},cancelLoading(a){this._childLoadingHandler&&(this.cancelAsync(this._childLoadingHandler),this._childLoadingHandler=null),this.loading&&this._setLoading(!1),a&&this.activeMeta&&this.activeMeta.item&&!this._assetGraph.hasChildren(this.activeMeta.item)&&this.activate(this.activeMeta.parent,'LOADING_CANCELLED')},_handleLoadingTimeoutChanged(){this.loading&&this.cancelLoading()},clearFilter(){this.filter=''},_getColumnFilter(a,b,c,d){if(!d||this.__context.activeIndex!==a)return null;let e=b.toLowerCase();return this._doesItemMatchFilter.bind(this,e,c)},_getColumnFilterFavorited(a,b,c){if(!c)return null;let d=a.toLowerCase();return this._doesItemMatchFilter.bind(this,d,b)},_doesItemMatchFilter(a,b,c){return!!c[b]&&-1<c[b].toLowerCase().indexOf(a)},_linkActiveContext(a){this.__context.columns&&'number'===typeof a&&this.$.selector.select(this.__context.columns[a])},_updateVisibleCount(a){if(this.__context&&'number'===typeof this.__context.activeIndex){const b=Polymer.dom(a).rootTarget,c=b.forcolumn,d=b.renderedItemCount;'number'!==typeof d||this.set(`__context.columns.${c}.visibleCount`,d)}},_updateVisibleCountFavorited(){if(this.favoritedOpened){const a=Polymer.dom(this.root).querySelector('#favoritedRepeater');if(!a)return;const b=a.renderedItemCount;if('number'!==typeof b)return;this._favoritedVisibleCount=b}},_getColumns(a,b){const{item:c,path:d}=a;if(Array.isArray(this.__context.columns)||(this.__context.columns=[b]),!Array.isArray(d)&&Array.isArray(this.__context.columns)&&this.__context.columns[0]!==b&&(this.__context.columns=[b]),!Array.isArray(d))return Object.assign({},this.__context,{activeIndex:0});const e=this.__context.columns.slice(0);let f;for(let g=0;g<d.length;g++){if(e[g+1]&&e[g+1].parent===c){f=g+1;break}e[g+1]=Object.assign({},e[g+1]?e[g+1]:{},{index:g+1,parent:d[g],items:this._assetGraph.hasChildren(d[g])?this._assetGraph.getChildren(d[g]):[],visibleCount:null})}return Object.assign({},this.__context,{columns:e,activeIndex:'number'===typeof f?f:d.length})},_getRootColumn(a){return{index:0,parent:null,items:a,visibleCount:null}},_openTriggerChanged(a,b){b&&b instanceof HTMLElement&&this._openTriggerTapped&&b.removeEventListener('trigger-tapped',this._openTriggerTapped),a&&a instanceof HTMLElement&&(this._positionTarget=a,this._openTriggerTapped=()=>{this._handleOpenTriggerTapped()},a.addEventListener('trigger-tapped',this._openTriggerTapped,!1))},_favoritedTriggerChanged(a,b){b&&b instanceof HTMLElement&&this._favoritedTriggerTapped&&b.removeEventListener('trigger-tapped',this._favoritedTriggerTapped),a&&a instanceof HTMLElement&&(this._favoritedPositionTarget=a,this._favoritedTriggerTapped=()=>{this._handleFavoritedTriggerTapped()},a.addEventListener('trigger-tapped',this._favoritedTriggerTapped,!1))},_handleOpenTriggerTapped(){this.opened?this.$.dropdown.close():(this.favoritedOpened=!1,this.opened=!0)},_handleFavoritedTriggerTapped(){this.favoritedOpened?this.$.favoritedDropdown.close():(this.opened=!1,this.favoritedOpened=!0,Polymer.Element?Polymer.RenderStatus.afterNextRender(this,()=>{this._updateVisibleCountFavorited()}):requestAnimationFrame(()=>{setTimeout(()=>{this._updateVisibleCountFavorited()})}))},_handleBrowserCanceled(a){if(this.openTrigger){const b=Polymer.dom(a.detail).path;-1<b.indexOf(this.openTrigger)&&a.preventDefault()}},_handleFavoritedBrowserCanceled(a){if(this.favoritedTrigger){const b=Polymer.dom(a.detail).path;-1<b.indexOf(this.favoritedTrigger)&&a.preventDefault()}},_handleBrowserOpened(){this._squashNextResetActiveTask&&(this._squashNextResetActiveTask=null),this._resetActiveTask?(this.cancelAsync(this._resetActiveTask),this._resetActiveTask=null):this._resetActive()},_handleBrowserClosed(){return this._squashNextResetActiveTask?void(this._squashNextResetActiveTask=null):void(this._resetActiveTask&&(this.cancelAsync(this._resetActiveTask),this._resetActiveTask=null),this._resetActiveTask=this.async(this._resetActive.bind(this),5e3))},_resetActive(){!this.selected&&this.active?this.activate(null,'DOM_EVENT'):this.selected&&this.active!==this.selectedMeta.parent&&this.activate(this.selectedMeta.parent,'DOM_EVENT')},_handleInitialOpenedValue(a,b){'boolean'===typeof a&&'undefined'==typeof b&&(this._squashNextResetActiveTask=!0)},_getDropdownVerticalAlign(a){return a?'bottom':'top'},_getDropdownHorizontalAlign(a){return a?'right':'left'},_getPositionTarget(a,b){return b||!(a instanceof HTMLElement)?window:a},_handleItemTapped(a){a.stopPropagation();const b=Polymer.dom(a).path,c=this._findActionInPath(b),d=a.model.item;if('string'===typeof c&&0<c.length&&'object'===typeof d){const a=this._assetGraph.isTerminal(d);a||'activate'!==c?'select'===c||a&&'activate'===c?(this.select(d,'DOM_EVENT'),!this.keepOpen&&this.$.dropdown.close()):'favorite'===c&&this._favoritedCop.handleItemTapped(d):this.activate(d,'DOM_EVENT')}},_getFavoritedItemPath(a){if(a&&'object'===typeof a){const b=this._assetGraph.getPath(a);let c=[];return b.forEach(function(a){c.push(a.label)}),c.slice(0,-1)}return null},_handleHeaderTapped(a){const b=Polymer.dom(a).path,c=this._findActionInPath(b);('string'!==typeof c||0<c.length)&&('back'===c?this.activate(this.activeMeta.parent,'DOM_EVENT'):'select'===c?(this.select(this.active,'DOM_EVENT'),this.keepOpen||this.$.dropdown.close()):'favorite'===c?Array.isArray(this.favorited)&&-1===this.favorited.indexOf(this.active)?this.favorite(this.active,'DOM_EVENT'):this.defavorite(this.active,'DOM_EVENT'):void 0)},_findActionInPath(a){let b;for(let c=0;c<a.length;c++)if(a[c]instanceof Node&&a[c].hasAttribute&&a[c].hasAttribute('asset-action')){b=a[c].getAttribute('asset-action');break}return b},_isItemSelected(a,b){return'object'===typeof b&&b===a},_isItemFavorited(a,b){return'object'===typeof b&&Array.isArray(b)&&-1<b.indexOf(a)},_isItemVisible(a){return!0===a.visible},_isItemOpenable(a,b){return a&&!this._assetGraph.isTerminal(b)},_isItemSelectable(a){return a&&this._assetGraph.isSelectable(a)},_isItemFavoritable(a){return a&&this._assetGraph.isSelectable(a)},_isNotNull(a){return'undefined'!==typeof a&&null!==a},_showFavoritedAndItemFavoritable(a,b){return a&&this._isItemFavoritable(b)},_showFavoritedEmptyState(a){return!a||!Array.isArray(a)||0===a.length},_getItemProp(a,b){return a&&'object'===typeof a&&'string'===typeof b&&a.hasOwnProperty(b)?a[b]:null}}),'function'!=typeof Object.assign&&(Object.assign=function(a){'use strict';if(null==a)throw new TypeError('Cannot convert undefined or null to object');for(var b,c=Object(a),d=1;d<arguments.length;d++)if(b=arguments[d],null!=b)for(var e in b)Object.prototype.hasOwnProperty.call(b,e)&&(c[e]=b[e]);return c})})();</script></body></html>