<html><head><link rel="import" href="../polymer/polymer.html"><link rel="import" href="../px-icon-set/px-icon-set.html"><link rel="import" href="px-vis-behavior-common.html"><link rel="import" href="px-vis-behavior-d3.html"><link rel="import" href="px-vis-behavior-axis-drag.html"><link rel="import" href="css/px-vis-styles.html"></head><body><dom-module id="px-vis-axis-interaction-space"><template><style include="px-vis-styles"></style></template></dom-module><script>Polymer({is:'px-vis-axis-interaction-space',behaviors:[PxVisBehavior.observerCheck,PxVisBehaviorD3.svg,PxVisBehaviorD3.axes,PxVisBehavior.commonMethods,PxVisBehavior.dataset,PxVisBehavior.mutedSeries,PxVisBehavior.combinedMutedSeries,PxVisBehaviorD3.selectedDomain,PxVisBehaviorD3.domainUpdate,PxVisBehaviorD3.radialAxisConfig,PxVisBehavior.radial,PxVisBehaviorD3.dynamicRedraw,PxVisBehaviorDrag.parallelAxisDrag,PxVisBehaviorDrag.cartesianDrag,PxVisBehavior.categories,PxVisBehavior.completeSeriesConfig,PxVisBehavior.applyActionConfig,PxVisBehaviorD3.cursorIcon,PxVisBehaviorD3.axisOrientation,PxVisBehavior.updateStylesOverride,PxVisBehavior.extentsData,PxVisBehavior.brushDomains,PxVisBehavior.timeDomain],properties:{dimension:{type:String},_brushElem:{type:Object},_brushD3:{type:Object},_previousRange:{type:Array},_brush:{type:Object},brushToRemove:{type:Boolean,value:!1},dragContainerElem:{type:HTMLElement},cartesianDragBehavior:{type:Boolean,value:!1},dragBehavior:{type:Object},specialActionsList:{type:Array,value:function(){return['callAxisMute','callAxisDrag','startZooming','startLasso']}},brushActions:{type:Object,value:function(){return{callAxisMute:'muted',startZooming:'zoom',startLasso:'lasso'}}},actionMapping:{type:Object,readOnly:!0,value:function(){return{callAxisMute:'_startMute',callAxisDrag:'_enableDrag',calcTooltipData:'_calcTooltipData',calcCrosshairData:'_calcCrosshairData',calcTooltipAndCrosshairData:'_calcTooltipAndCrosshairData',resetTooltipAndCrosshairData:'_resetTooltipAndCrosshairData',resetTooltip:'_resetTooltipData',resetCrosshair:'_resetCrosshairData',startZooming:'_startZoom',startPanning:'_startPanning',stopPanning:'_stopPanning',startLasso:'_startLasso'}}},actionConfig:{type:Object,value:function(){return{mousedown:null,mouseup:null,mouseout:'resetTooltip',mousemove:'calcTooltipData'}}},smallerSide:{type:Number,value:0},_isDirty:{type:Boolean,value:!1},_panningLastVal:{type:Number},_unselectedBrushHolder:{type:Object},_continuousBrush:{type:Boolean,value:!1}},observers:['drawElement(svg, margin.* , height, domainChanged)','_showBrushes(brushDomains.*, actionConfig.*, domainChanged)','_showUnselectedBrushes(actionConfig.*, domainChanged)','_setupActions(actionConfig.*)','_setDragBehavior(cartesianDragBehavior, dragContainerElem)','_drawCursorIconAndGroup(svg, iconType)','_setBrushStyles(_stylesUpdated)'],attached:function(){this._isDirty&&(this.drawElement(),this._isDirty=!1)},detached:function(){this._doesD3HaveValues(this._brushD3)&&(this.deleteAndClearBrush(),this._brushD3.remove(),this._brushD3=null),this._isDirty=!0},_setDragBehavior:function(){this.hasUndefinedArguments(arguments)||(this.cartesianDragBehavior?this.createCartesianDrag():this.createParallelAxisDrag())},drawElement:function(){this.hasUndefinedArguments(arguments)||this.debounce('_axisBrush',function(){if(null!==this.domainChanged&&this.svg){var a=this._calcRange();this._doesD3HaveValues(this._brushD3)?this._resizeBrush(a):(this._unselectedBrushHolder=this.svg.append('g').attr('id','unselected-brushes'),this._createBrush(a)),this._translateBrush(),this._styleBrushSelection()}},10)},_calcRange:function(){var a=this.radial?[[-10,this.centerOffset],[10,this.height]]:[[-10,0],[10,Math.max(this.height-this.margin.top-this.margin.bottom,1)]];return a[1][0]=a[1][0]>a[0][0]?a[1][0]:a[0][0],a[1][1]=a[1][1]>a[0][1]?a[1][1]:a[0][1],a},_createBrush:function(a){var c=this.svg.append('g').attr('class','interaction');c.call(this._brush=Px.d3.brushY().extent(a).filter(function(){return 1}).on('start.brush',this.brushstart.bind(this)).on('brush.brush',this.brushActive.bind(this)).on('end.brush',this.brushEnd.bind(this))),this._brushD3=c,this._brushElem=c.node(),this._setBrushStyles(),this._setupActions()},_resizeBrush:function(a){this._brushD3.call(this._brush.extent(a).on('start.brush',this.brushstart.bind(this)).on('end.brush',this.brushEnd.bind(this)))},_setBrushStyles:function(){this.hasUndefinedArguments(arguments)||this._doesD3HaveValues(this._brushD3)&&this._brushD3.selectAll('rect.selection').attr('fill',this._checkThemeVariable('--px-vis-axis-brush-fill-color','rgb(0,0,0)')).attr('fill-opacity',this._checkThemeVariable('--px-vis-axis-brush-fill-opacity',0.3)).attr('stroke',this._checkThemeVariable('--px-vis-axis-brush-outline-color','rgb(50,50,50)'))},_translateBrush:function(){var a=Math.max,b=0,c=0;switch(this.orientation){case'bottom':b=a(this.height-this.margin.bottom-this.margin.top,0);break;case'right':c=a(this.width-this.margin.left-this.margin.right,0);}this._brushD3.attr('transform','translate('+c+','+b+')')},_styleBrushSelection:function(){this.brushToRemove&&'callAxisMute'===this.actionConfig.mousedown?this._brushD3.selectAll('rect.selection').attr('stroke-dasharray','5, 5'):this._brushD3.selectAll('rect.selection').attr('stroke-dasharray',null)},_setupActions:function(){if(!this.hasUndefinedArguments(arguments)&&this._doesD3HaveValues(this._brushD3)){this._disableAllAction(),this._brushD3.selectAll('rect').attr('cursor','crosshair').on('mousemove.cursor',this._updateCursor.bind(this)).on('mouseout.cursor',this._hideCursor.bind(this)),this._brushD3.selectAll('rect').on('mouseenter.sizing',function(){this.dispatchEvent(new CustomEvent('px-vis-tooltip-sizing-request',{bubbles:!0,composed:!0}))}.bind(this));var a=this._setupSpecialActions();this._setupRegularActions(this._brushD3,this._brushElem,a)}},_setupSpecialActions:function(){var a=!1,b=null,c=null;return-1===this.specialActionsList.indexOf(this.actionConfig.mousedown)?-1!==this.specialActionsList.indexOf(this.actionConfig.mouseup)&&(a=!0,b='mouseup'):(a=!0,b='mousedown'),a&&(c=this.actionConfig[b],this[this.actionMapping[c]]()),a},_disableActions:function(){this._brushD3.on('mousedown',null).on('mouseup',null).on('mousemove',null).on('mouseout',null)},_disableBrush:function(){this._brushD3.call(this._brush.filter(function(){return 0}))},_startMute:function(){this.extentsAction='mute',this._continuousBrush=!1,this._disableBrush(),this._enableBrush()},_startZoom:function(){this.extentsAction='zoom',this._continuousBrush=!1,this._disableBrush(),this._enableBrush()},_startLasso:function(){this.extentsAction='lasso',this._continuousBrush=!0,this._disableBrush(),this._enableBrush()},_enableBrush:function(){this._brushD3.call(this._brush.filter(function(){return 1}).on('start.brush',this.brushstart.bind(this)).on('brush.brush',this.brushActive.bind(this)).on('end.brush',this.brushEnd.bind(this))),this._brushD3.select('rect.overlay').attr('cursor','crosshair'),this._brushD3.select('rect.selection').attr('cursor','move'),this._brushD3.selectAll('rect.handle').attr('cursor','ns-resize')},_disableDrag:function(){return this.dragBehavior?void this._brushD3.call(this.dragBehavior.filter(function(){return 0})):void console.warn('Drag behavior not configured')},_enableDrag:function(){return this.dragBehavior?void(this._brushD3.call(this.dragBehavior.filter(function(){return 1})),this._brushD3.selectAll('rect').attr('cursor','move')):void console.warn('Drag behavior not configured')},_disableAllAction:function(){this._disableBrush(),this._disableDrag(),this._disableActions()},_startPanning:function(){0===Px.d3.event.button&&(this.set('extentsAction','pan'),this._resetTooltipData(),Px.d3.select(document).on('mouseup.action',this._stopPanning.bind(this)),Px.d3.select(document).on('mousemove.action',this._updatePanning.bind(this)),this._panningLastVal=Px.d3.mouse(this._brushElem)[1],this.dispatchEvent(new CustomEvent('px-vis-interaction-space-start-panning',{bubbles:!0,composed:!0})))},_updatePanning:function(){var a=Px.d3.mouse(this._brushElem),b=this._panningLastVal-a[1],c={dimension:this.dimension,action:this.extentsAction,extents:[]},d=this._getRange();this.radial?(c.extents.push(d[0]+b),c.extents.push(d[1]+b)):(c.extents.push(d[1]+b),c.extents.push(d[0]+b)),this._panningLastVal=a[1],this.dispatchEvent(new CustomEvent('px-vis-axis-interaction-space-extents-data',{bubbles:!0,composed:!0,detail:c}))},_stopPanning:function(){Px.d3.select(document).on('mouseup.action',null),Px.d3.select(document).on('mousemove.action',null),this.dispatchEvent(new CustomEvent('px-vis-interaction-space-stop-panning',{bubbles:!0,composed:!0}))},_getRange:function(){var a;return a='function'===typeof this.y?this.y.range():this.y[this.dimension].range(),a},_resetTooltipAndCrosshairData:function(){this._resetTooltipData(),this._resetCrosshairData()},_calcTooltipAndCrosshairData:function(){this._calcTooltip=!0,this._calcCrosshair=!0,this._calcHoverData()},_calcTooltipData:function(){this._calcTooltip=!0,this._calcCrosshair=!1,this._calcHoverData()},_calcCrosshairData:function(){this._calcTooltip=!1,this._calcCrosshair=!0,this._calcHoverData()},_calcHoverData:function(){var a=Px.d3.mouse(this._brushElem);this.debounce('axisMouseMove',function(){this._calcSerieData(this.dimension,a)},10)},_resetTooltipData:function(){var a={axis:null,yVal:null,mouse:null,time:null,dataset:null,series:[],color:null,tooltipConfig:null};window.setTimeout(function(){this.set('tooltipData',a),this.fire('px-vis-axis-interaction-space-reset-tooltip',a)}.bind(this),11)},_resetCrosshairData:function(){var a={rawData:[],timeStamps:[]};window.setTimeout(function(){this.set('crosshairData',a),this.generatingCrosshairData=!1,this.fire('px-vis-axis-interaction-space-reset-crosshair',a)}.bind(this),11)},_calcSerieData:function(a,b){for(var c,d,e=Number.MAX_VALUE,f={distance:e,minDistance:e,rawData:[],timeStamps:[]},g=0;g<this.chartData.length;g++)this.combinedMutedSeries[this.chartData[g][this.seriesKey]]||this._searchData(a,b[1],f,this.chartData[g]);this._calcTooltip&&(c=this._createTooltipData(a,b,f),this.set('tooltipData',c),this.fire('px-vis-axis-interaction-space-tooltip-data',c)),this._calcCrosshair&&(d=this._createCrosshairData(f),this.generatingCrosshairData=!0,this.set('crosshairData',d),this.fire('px-vis-axis-interaction-space-crosshair-data',d))},_searchData:function(a,b,c,e){this.y.domain()[0]>e[a]||e[a]>this.y.domain()[1]||this.timeDomain&&this.timeDomain.x&&(e[this.seriesKey]<this.timeDomain.x[0]||e[this.seriesKey]>this.timeDomain.x[1])||(c.distance=Math.abs(~~this.y(e[a])-b),c.distance<c.minDistance?(c.minDistance=c.distance,c.rawData=[e],c.timeStamps=[e[this.seriesKey]]):c.distance===c.minDistance&&(c.rawData.push(e),c.timeStamps.push(e[this.seriesKey])))},_createTooltipData:function(a,b,c){var d=this._createSingleDataset(a,b,c.rawData[0]);d.additionalPoints=[];for(var e=1;e<c.rawData.length;e++)d.additionalPoints.push(this._createSingleDataset(a,b,c.rawData[e]));return d},_createSingleDataset:function(a,b,c){var e,f={},g={};return f[a]={},f[a].color=this.categoryKey&&c[this.categoryKey]&&this.completeSeriesConfig[c[this.categoryKey]]?this.completeSeriesConfig[c[this.categoryKey]].color:this.completeSeriesConfig[this.seriesKey].color,f[a].name=this.completeSeriesConfig[a]&&this.completeSeriesConfig[a].title?this.completeSeriesConfig[a].title:a,f[a].yAxisUnit=this.completeSeriesConfig[a]&&this.completeSeriesConfig[a].yAxisUnit?this.completeSeriesConfig[a].yAxisUnit:'',f[a].y=a,g[a]=c[a],e={axis:a,yVal:c[a],mouse:b,time:c[this.seriesKey],dataset:c,series:[{name:a,value:g}],color:f[a].color,tooltipConfig:f},e},_createCrosshairData:function(a){var b={rawData:a.rawData,timeStamps:a.timeStamps};return b},brushstart:function(){Px.d3.event.sourceEvent&&'end'!==Px.d3.event.sourceEvent.type&&Px.d3.event.sourceEvent.stopPropagation(),this._brushD3.select('rect.selection').attr('width',20)},brushActive:function(){if(this._continuousBrush){var a;Px.d3.brushSelection(this._brushElem)&&(a=Px.d3.brushSelection(this._brushElem));var b={dimension:this.dimension,extents:a,action:this.extentsAction};this.dispatchEvent(new CustomEvent('px-vis-axis-interaction-space-extents-data',{bubbles:!0,composed:!0,detail:b}))}},brushEnd:function(){var a=[];Px.d3.brushSelection(this._brushElem)&&(a=this._checkMinSize(Px.d3.brushSelection(this._brushElem),this._brushD3));var b={dimension:this.dimension,extents:a,action:this.extentsAction};this.clearBrush(),this._enableBrush(),this.dispatchEvent(new CustomEvent('px-vis-axis-interaction-space-extents-data',{bubbles:!0,composed:!0,detail:b}))},_checkMinSize:function(a){if(4>a[1]-a[0]){var b=0>a[0]-4-this.centerOffset?[a[0],a[1]+4]:[a[0]-4,a[1]];return b}return a},_checkBrushSize:function(a){var b=this.y.domain(),c=[a[1],a[0]],d=[];if(b[0]<=c[0]&&b[1]>=c[1])d=this._getNewBrushRange(c[0],c[1]),d=this._checkMinSize(d);else if(b[0]>c[0]&&b[0]<c[1]&&b[1]>=c[1])d=this._getNewBrushRange(b[0],c[1]),d=this._checkMinSize(d);else if(b[0]<=c[0]&&b[1]<c[1]&&b[1]>c[0])d=this._getNewBrushRange(c[0],b[1]),d=this._checkMinSize(d);else return[];return d},_getNewBrushRange:function(a,b){var c=[];return c[0]=this.y(a),c[1]=this.y(b),this.radial?c:[c[1],c[0]]},clearBrush:function(){this._brushD3.call(this._brush.on('start.brush',null).on('end.brush',null)),this._brushD3.call(this._brush.move,null)},deleteAndClearBrush:function(){this.clearBrush(),this.dispatchEvent(new CustomEvent('px-vis-axis-interaction-space-extents-clear',{bubbles:!0,composed:!0,detail:{dimension:this.dimension}}))},_showBrushes:function(){this.hasUndefinedArguments(arguments)||this.debounce('showbrushes',function(){this._showBrushesDebounced()},10)},_showBrushesDebounced:function(){if(!(this._isD3Empty(this._brushD3)||null===this.domainChanged)){this.clearBrush(),this._styleBrushSelection();var a=this.brushActions[this.actionConfig.mousedown];if(a){if(!this.brushDomains[a]||this._isObjEmpty(this.brushDomains[a]))return void this._enableBrush();var b=this.brushDomains[a][this.dimension];if(b&&0<b.length){var c=this._checkBrushSize(b);this._brushD3.call(this._brush.move,c)}this._enableBrush()}}},_showUnselectedBrushes:function(){this.hasUndefinedArguments(arguments)||this.debounce('showUnselectedbrushes',function(){this._showUnselectedBrushesDebounced()},10)},_showUnselectedBrushesDebounced:function(){if(!(this._isD3Empty(this._brushD3)||null===this.domainChanged||this._isObjEmpty(this.brushActions))){var a=this.brushActions[this.actionConfig.mousedown],b=Object.keys(this.brushActions);this._unselectedBrushHolder.html(null),b.forEach(function(b){var c=this.brushActions[b];if(c!==a&&this.brushDomains[c]&&this.brushDomains[c][this.dimension]&&0!==this.brushDomains[c][this.dimension].length){var d=this.brushDomains[c][this.dimension],e=this._checkBrushSize(d),f=this._unselectedBrushHolder.append('g').attr('id','unselected-'+c);f.append('rect').attr('x',-10).attr('width',20).attr('y',e[0]).attr('height',e[1]-e[0]).attr('fill',this._checkThemeVariable('--px-vis-axis-brush-fill-color-unselected-'+c,'rgb(0,0,0)')).attr('fill-opacity',this._checkThemeVariable('--px-vis-axis-brush-fill-opacity-unselected-'+c,0.1)).attr('stroke',this._checkThemeVariable('--px-vis-axis-brush-outline-color-unselected-'+c,''))}}.bind(this))}},_drawCursorIconAndGroup:function(){this.hasUndefinedArguments(arguments)||(!this._cursorGroup&&(this._cursorGroup=this.svg.append('g').attr('display','none').attr('pointer-events','none')),this._drawCursorIcon())},_updateCursor:function(){if(!this._isD3Empty(this._cursorGroup)){var a=Px.d3.mouse(this._brushD3.node());this._cursorGroup.attr('display',null),this._positionCursorIcon(a)}},_hideCursor:function(){this._isD3Empty(this._cursorGroup)||this._isD3Empty(this._icon)||this._cursorGroup.attr('display','none')}});</script></body></html>