<html><head><link rel="import" href="px-vis-behavior-common.html"><link rel="import" href="px-vis-behavior-d3.html"><script>var PxVisBehaviorRenderer=PxVisBehaviorRenderer||{};PxVisBehaviorRenderer.debounceOnPanning={properties:{drawDebounceTime:{type:Object,value:function(){return{chartData:10,filteredChartData:10,highlightData:10,markers:10}}},_oldDrawDebounceTime:{type:Object},debounceOnPanning:{type:Boolean,value:!1}},attached:function(){this.listen(this,'px-vis-interaction-space-start-panning','_panningStarted'),this.listen(this,'px-vis-interaction-space-stop-panning','_panningStopped')},detached:function(){this.unlisten(this,'px-vis-interaction-space-start-panning','_panningStarted'),this.unlisten(this,'px-vis-interaction-space-stop-panning','_panningStopped')},_panningStarted:function(){this.debounceOnPanning||(this._oldDrawDebounceTime=this.drawDebounceTime,this.drawDebounceTime={chartData:0,filteredChartData:0,highlightData:this._oldDrawDebounceTime.highlightData,markers:0})},_panningStopped:function(){this.debounceOnPanning||(this.drawDebounceTime=this._oldDrawDebounceTime)}},PxVisBehaviorRenderer.base=[{properties:{_progressiveRenderingCounter:{type:Object,value:function(){return this._initializeRendererTypeObject(0)}},_canvasTargets:{type:Object,value:function(){return this._initializeRendererTypeObject([])}},_svgTargets:{type:Object,value:function(){return this._initializeRendererTypeObject([])}},rendererMinimumPointsPerFrame:{type:Number,value:50},rendererFrameDurationTarget:{type:Number,value:20},_internalRendererFrameDurationTarget:{type:Number,value:20},rendererFrameCountToAverage:{type:Number,value:3},_previousFramesTiming:{type:Object,value:function(){return this._initializeRendererTypeObject({line:[],scatter:[]})}},_hasBeenDetached:{type:Boolean,value:!1}},observers:['_targetTimingChanged(rendererFrameDurationTarget)'],created:function(){this.listen(this,'px-vis-renderer-register','_registerDrawingElement'),this.listen(this,'px-vis-renderer-update-target-props','_updateTargetProperty')},attached:function(){this.listen(this,'px-vis-highlight-data-changed','_renderHighlight'),this.listen(this,'px-vis-redraw-lines','_renderAllLines'),this._hasBeenDetached&&window.setTimeout(function(){this._renderChartData(),this._renderFilteredChartData(),this._renderMarkers(),this._renderHighlight()}.bind(this),50)},detached:function(){this._progressiveRenderingCounter=this._initializeRendererTypeObject(0),this.unlisten(this,'px-vis-highlight-data-changed','_renderHighlight'),this.unlisten(this,'px-vis-redraw-lines','_renderAllLines'),this._hasBeenDetached=!0},_initializeRendererTypeObject:function(a){return{chartData:a,filteredChartData:JSON.parse(JSON.stringify(a)),highlightData:JSON.parse(JSON.stringify(a)),markers:JSON.parse(JSON.stringify(a))}},_updateTargetProperty:function(a){for(var b,c=a.detail.propertyName,d=a.detail.propertyValue,e=Polymer.dom(a).rootTarget,f=a.detail.rendererType,g=0;g<this._canvasTargets[f].length;g++)b=this._canvasTargets[f][g],b.target===e&&(b[c]=d);a.stopPropagation()},_registerDrawingElement:function(a){var b=Polymer.dom(a);'canvas'===a.detail.renderMode?this._canvasTargets[a.detail.rendererType].push({target:b.rootTarget,type:a.detail.type,priority:a.detail.priority}):this._svgTargets[a.detail.rendererType].push({target:b.rootTarget,type:a.detail.type}),this.listen(b.rootTarget,'px-vis-renderer-unregister','_unregisterDrawingElement'),a.stopPropagation()},_unregisterDrawingElement:function(a){var b=Polymer.dom(a);if('canvas'===a.detail.renderMode){for(var c=0;c<this._canvasTargets[a.detail.rendererType].length;c++)if(b.rootTarget===this._canvasTargets[a.detail.rendererType][c].target){break}-1!==c&&this._canvasTargets[a.detail.rendererType].splice(c,1)}else{for(var c=0;c<this._svgTargets[a.detail.rendererType].length;c++)if(b.rootTarget===this._svgTargets[a.detail.rendererType][c].target){break}-1!==c&&this._svgTargets[a.detail.renderType].splice(c,1)}this.unlisten(b.rootTarget,'px-vis-renderer-unregister','_unregisterDrawingElement'),a.stopPropagation()},_renderSeriesOnTop:function(){if(!this.hasUndefinedArguments(arguments)){for(var a,b=[],c=0;c<this._canvasTargets.chartData.length;c++)this._canvasTargets.chartData[c].target.seriesId===this.serieToRedrawOnTop&&b.push(this._canvasTargets.chartData[c]);for(var c=0;c<this._canvasTargets.filteredChartData.length;c++)this._canvasTargets.filteredChartData[c].target.seriesId===this.serieToRedrawOnTop&&b.push(this._canvasTargets.filteredChartData[c]);if(b.length){var a={lastPointRenderedIndex:null,currentBatchStartIndex:0,renderType:'chartData',canvasTargets:b,svgTargets:this._svgTargets.chartData,canvasToClear:[],drawDebounceTime:0};this._renderData(a)}}},_renderTypedContext:function(a,b){for(var c=[],d=0;d<this._canvasTargets[a].length;d++)c.push(this._canvasTargets[a][d]);c.sort(function(c,a){return Px.d3.ascending(c.priority,a.priority)});var e={lastPointRenderedIndex:null,currentBatchStartIndex:0,renderType:a,canvasTargets:c,svgTargets:this._svgTargets[a],canvasToClear:b,drawDebounceTime:this.drawDebounceTime[a]};if(e.canvasTargets.length)this._renderData(e);else for(var d=0;d<e.canvasToClear.length;d++)e.canvasToClear[d]&&e.canvasToClear[d].pxClearCanvas&&e.canvasToClear[d].pxClearCanvas()},_renderChartData:function(){this.hasUndefinedArguments(arguments)||(this.chartData&&this.chartData.length?this._renderTypedContext('chartData',[this.canvasContext]):this.canvasContext.pxClearCanvas())},_renderFilteredChartData:function(){this.hasUndefinedArguments(arguments)||(this._filteredData&&this._filteredData.length?this._renderTypedContext('filteredChartData',[this.canvasContext]):this.canvasContext.pxClearCanvas())},_renderHighlight:function(){this.hasUndefinedArguments(arguments)||null===this.domainChanged||!this.canvasLayers.highlighter||!this.completeSeriesConfig||this.preventInitialDrawing||this._renderTypedContext('highlightData',[this.canvasLayers.highlighter])},_renderMarkers:function(){this.hasUndefinedArguments(arguments)||this._renderTypedContext('markers',[this.canvasLayers.markers])},_renderAllLines:function(){for(var a,b,c=[],d=this.canvasLayers.highlighter?[this.canvasContext,this.canvasLayers.highlighter]:[this.canvasContext],e=Object.keys(this._canvasTargets),f=0;f<e.length;f++){b=this._canvasTargets[e[f]];for(var g=0;g<b.length;g++)'line'===b[g].type&&c.push(b[g])}a={lastPointRenderedIndex:null,currentBatchStartIndex:0,renderType:'chartData',canvasTargets:c,svgTargets:this._svgTargets.chartData,canvasToClear:d,drawDebounceTime:this.drawDebounceTime.chartData},this._renderData(a)},_renderData:function(a){this.preventInitialDrawing?this._progressiveRenderingCounter[a.renderType]=0:(this._progressiveRenderingCounter[a.renderType]++,0<a.drawDebounceTime?this.debounce(a.renderType,function(){this._renderDataDebounced(a,!0)}.bind(this),a.drawDebounceTime):this._renderDataDebounced(a,!0))},_renderDataDebounced:function(a,b){this.y&&'undefined'!==typeof this.domainChanged&&null!==this.domainChanged&&this._isAttached&&(this.fire('px-vis-chart-canvas-rendering-started',{context:a}),this._initializeCanvasRendering(a,b))},_initializeCanvasRendering:function(a){for(var b=0;b<a.canvasToClear.length;b++)a.canvasToClear[b].pxClearCanvas();if(a.frameIndex=0,a.requestCounter=++this._progressiveRenderingCounter[a.renderType],a.targetIndex=0,a.currentRenderingCounter=0,a.canvasTargets.length){for(var b=0;b<a.canvasTargets.length;b++)a.canvasTargets[b].target.initializeDrawingSession();this._processCanvasRendering(a)}},_processCanvasRendering:function(a){var b=window.performance.now();Px.vis.debug.info(' '),Px.vis.debug.info('STARTIN ONE FRAME'),this._updatePreviousFrameTiming(a,b);a.requestCounter!==this._progressiveRenderingCounter[a.renderType]||(a.currentTarget=this._getCurrentCanvasRenderingTarget(a),a.previousStartTime=b,this._processCanvasOneFrame(a),a.frameIndex++,a.targetIndex>a.canvasTargets.length-1?(this._internalRendererFrameDurationTarget=this.rendererFrameDurationTarget,this.fire('px-vis-chart-canvas-rendering-ended',{context:a})):window.requestAnimationFrame(function(){this._processCanvasRendering(a)}.bind(this)))},_processCanvasOneFrame:function(a){for(var b,c,d=100,e=null;0<d&&a.currentTarget;)e!==a.currentTarget.type&&(b=this._calculatePointsAllowance(a),e=a.currentTarget.type),Px.vis.debug.info('NEW TARGET, torender: '+b+', budget left: '+d),-1===b?(c=this._firstCanvasRender(a),b=100*c.points/c.budgetUsed):c=this._renderTargetToCanvas(b,a,d),a.previousFrameStats.pointsCount[a.currentTarget.type]=a.previousFrameStats.pointsCount[a.currentTarget.type]?a.previousFrameStats.pointsCount[a.currentTarget.type]+c.points:c.points,a.previousFrameStats.totPoints+=c.points,d-=c.budgetUsed,a.currentTarget=this._getCurrentCanvasRenderingTarget(a);Px.vis.debug.info('finished one frame: '+JSON.stringify(a.previousFrameStats)+' in: '+(window.performance.now()-a.previousStartTime))},_updatePreviousFrameTiming:function(a,b){if(a.previousFrameStats)for(var c,d=Object.keys(a.previousFrameStats.pointsCount),e=0;e<d.length;e++)c=d[e],a.previousFrameStats.pointsCount[c]&&(this._previousFramesTiming[a.renderType][c].push({points:a.previousFrameStats.pointsCount[c],duration:(b-a.previousStartTime)*(a.previousFrameStats.pointsCount[c]/a.previousFrameStats.totPoints)}),this._previousFramesTiming[a.renderType][c].length>this.rendererFrameCountToAverage&&this._previousFramesTiming[a.renderType][c].shift(),Px.vis.debug.info('frame '+a.frameIndex+', type: '+c+', render: '+JSON.stringify(this._previousFramesTiming[a.renderType][c][this._previousFramesTiming[a.renderType][c].length-1])));a.previousFrameStats={},a.previousFrameStats.pointsCount={},a.previousFrameStats.totPoints=0},_getCurrentCanvasRenderingTarget:function(a){return a.canvasTargets.length?a.canvasTargets[a.targetIndex]:null},_firstCanvasRender:function(a){var b,c,d,e,f=this._internalRendererFrameDurationTarget-4,g=0,h=window.performance.now(),i=Math.min('scatter'===a.currentTarget.type?200:1e3,a.currentTarget.target.chartData?a.currentTarget.target.chartData.length:0);return i?(this._renderTargetToCanvas(i,a,100),g=i,b=window.performance.now()-h,b<f&&(c=Math.floor(f/b),d=this._renderTargetToCanvas(c*i,a,100),g+=d.points,b=window.performance.now()-h),e=100*(b/f),{points:g,budgetUsed:e}):(a.currentRenderingCounter=0,a.targetIndex++,{points:0,budgetUsed:0})},_renderTargetToCanvas:function(a,b,c){var d,e,f=Math.floor,g=b.currentTarget.target.chartData?b.currentTarget.target.chartData.length-b.currentRenderingCounter:0,h=f(a*c/100);return Px.vis.debug.info('trying to render target with '+h+' points for target of '+a+' with budget of '+c),0<g?(d=b.currentRenderingCounter,e=Math.min(d+h,b.currentTarget.target.chartData.length),b.currentTarget.target.renderOneBatch(d,e)):(d=0,e=0),h>g?(b.currentRenderingCounter=0,b.targetIndex++,Px.vis.debug.info('rendered target '+(e-d)+' points, used budget of '+f(100*(e-d)/a)),{points:e-d,budgetUsed:f(100*(e-d)/a)}):(Px.vis.debug.info('rendered target '+(e-d)+' points, used budget of '+c),b.currentRenderingCounter+=h,{points:e-d,budgetUsed:c})},_calculatePointsAllowance:function(a){var b,c,d,e,f=Math.max,g=Math.floor,h=0,j=0,k=this._previousFramesTiming[a.renderType][a.currentTarget.type];if(0<k.length){for(var l=0;l<k.length;l++)h+=k[l].points,j+=k[l].duration;return b=g(h/k.length),c=j/k.length,d=h/j,e=g(d*this._internalRendererFrameDurationTarget),37>this._internalRendererFrameDurationTarget&&e<1.05*this.rendererMinimumPointsPerFrame&&(this._internalRendererFrameDurationTarget=37),Px.vis.debug.info('calculating points allowance, stats: '+JSON.stringify(k)+' points: '+f(this.rendererMinimumPointsPerFrame,g(d*this._internalRendererFrameDurationTarget))),f(this.rendererMinimumPointsPerFrame,g(d*this._internalRendererFrameDurationTarget))}return-1},_targetTimingChanged:function(){this.set('_internalRendererFrameDurationTarget',this.rendererFrameDurationTarget)}},PxVisBehaviorD3.renderToCanvas,PxVisBehavior.dataset,PxVisBehavior.preventInitialDrawing,PxVisBehavior.isAttached,PxVisBehaviorRenderer.debounceOnPanning,PxVisBehaviorD3.domainUpdateNotify,PxVisBehavior.mutedSeries,PxVisBehavior.completeSeriesConfig];</script></head><body></body></html>