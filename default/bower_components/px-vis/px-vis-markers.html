<html><head><link rel="import" href="../polymer/polymer.html"><link rel="import" href="../px-tooltip/px-tooltip.html"><link rel="import" href="px-vis-behavior-common.html"><link rel="import" href="px-vis-behavior-d3.html"><link rel="import" href="px-vis-scatter-canvas.html"><link rel="import" href="px-vis-markers-tooltip-content.html"></head><body><dom-module id="px-vis-markers"><template><template is="dom-repeat" items="[[_markerTypes]]"><px-vis-scatter-canvas canvas-context="[[canvasContext]]" series-id="[[item]]" clip-path="" chart-data="[[_returnMarkerData(item, _markerData)]]" complete-series-config="[[_markerConfig]]" width="[[width]]" height="[[height]]" margin="[[_returnMargin(margin.*)]]" x="[[x]]" y="[[_returnYScale(item, _topDomain, _bottomDomain)]]" domain-changed="[[_returnDomain(item, _topDomain, _bottomDomain, domainChanged)]]" progressive-rendering-points-per-frame="500" renderer-type="markers"></px-vis-scatter-canvas></template><template id="tooltipIf" is="dom-if" if="[[_showTooltip]]"><px-tooltip id="tooltip" follow-mouse="" delay="50" smart-orientation="" ignore-target-events="" for="[[_canvas]]" mouse-coords="[[_tooltipPosition]]" tooltip-message="[[_ttMessage]]"><px-vis-markers-tooltip-content resources="[[resources]]" marker-config="[[_markerConfig]]" marker-data="[[markerData]]" marker-types="[[_markerTypes]]" language="[[language]]" tooltip-data-result="[[_tooltipDataResult]]"></px-vis-markers-tooltip-content></px-tooltip></template></template></dom-module><script>Polymer({is:'px-vis-markers',behaviors:[PxVisBehavior.observerCheck,PxVisBehavior.sizing,PxVisBehaviorD3.canvasContext,PxVisBehaviorD3.axes,PxVisBehavior.dataset,PxVisBehavior.commonMethods,PxVisBehaviorD3.clipPath,PxVisBehavior.dynamicConfigProperties,PxVisBehavior.markers],properties:{_markerData:{type:Object,computed:'_computeMarkerData(markerData.*, _markerTypes.*)'},_markerConfig:{type:Object,computed:'_computeMarkerConfig(markerConfig.*)'},_markerTypes:{type:Array},_topScale:{type:Function},_bottomScale:{type:Function},_topDomain:{type:Boolean,value:null},_bottomDomain:{type:Boolean,value:null},_canvas:{type:Object,computed:'_getCanvas(canvasContext)'},tooltipDetectionRadius:{type:Number,value:20},_tooltipPosition:{type:Array},resources:{type:Object,value:function(){return{en:{Event:'Event',Timestamp:'Timestamp'}}}},language:{type:String,value:'en'},useKeyIfMissing:{type:Boolean,value:!0},_showTooltip:{type:Boolean,value:!1},_lockTooltip:{type:Boolean,value:!1},_tooltipDataResult:{type:Array},_isSearchingTooltip:{type:Boolean,value:!1}},observers:['_requestCanvasCreation(markerConfig, height, margin.*)','_createScales(height, margin.*, _markerTypes.*)','_redraw(domainChanged)'],_computeMarkerConfig:function(){if(!this.hasUndefinedArguments(arguments)){for(var a,b=Object.keys(this.markerConfig),c=Object.keys(this._defaultMarkerConfig),d={},e=0;e<b.length;e++){a=b[e],d[a]={x:'x',y:a};for(var f=0;f<c.length;f++)d[a][c[f]]=this.markerConfig[a][c[f]]||!1===this.markerConfig[a][c[f]]||0===this.markerConfig[a][c[f]]?this.markerConfig[a][c[f]]:this._defaultMarkerConfig[c[f]];d[a].markerFillOpacity=this._getFillOpacity(this.markerConfig[a].markerFillOpacity,d[a].markerFillOpacity),d[a].tooltipLabel=this._defaultMarkerConfig.tooltipLabel?this._defaultMarkerConfig.tooltipLabel:a}return this.set('_markerTypes',b),d}},_getFillOpacity:function(a,b){return a?a:b?0:1},_computeMarkerData:function(){if(!this.hasUndefinedArguments(arguments)){if(!this.markerData||0===this.markerData.length)return[];for(var a,b,c,d,e=this._prepDataObject(this._markerTypes),f=0;f<this.markerData.length;f++)c=this.markerData[f].time,a=this.markerData[f].label,b=this.markerConfig&&this.markerConfig[a]&&this.markerConfig[a].row?this.markerConfig[a].row:0,d={},d.x=c,d[a]=b,d.originIndex=f,e[a]||(e[a]=[]),e[a].push(d);return e}},_prepDataObject:function(a){for(var b={},c=0;c<a.length;c++)b[a[c]]=[];return b},_requestCanvasCreation:function(){this.hasUndefinedArguments(arguments)||this.set('canvasLayersConfig.markers',{height:this.height,margin:{top:0,bottom:0,left:this.margin.left,right:this.margin.right}})},_createScales:function(){this.hasUndefinedArguments(arguments)||this.debounce('createScalesMarker',function(){this._createScalesDebounced()},10)},_createScalesDebounced:function(){for(var a,b,c,d,e,f=this.margin.top,g=this.height-this.margin.bottom,h={},j={},k=0;k<this._markerTypes.length;k++)e=this._markerTypes[k],row=this.markerConfig[e].row,'bottom'===this.markerConfig[e].location?j[row]=!0:h[row]=!0;b=Object.keys(j),a=Object.keys(h),d=Px.d3.scalePoint().range([g,this.height]).padding(0.5).domain(b),c=Px.d3.scalePoint().range([0,f]).padding(0.5).domain(a),this.set('_bottomScale',d),this.set('_topScale',c),this.set('_bottomDomain',!(null!==this._bottomDomain)||!this._bottomDomain),this.set('_topDomain',!(null!==this._topDomain)||!this._topDomain)},_returnYScale:function(a){return this.hasUndefinedArguments(arguments)?void 0:null!==this._topDomain&&null!==this._bottomDomain?'bottom'===this.markerConfig[a].location?this._bottomScale:this._topScale:void 0},_returnDomain:function(a){return this.hasUndefinedArguments(arguments)?void 0:null!==this._topDomain&&null!==this._bottomDomain&&null!==this.domainChanged?'bottom'===this.markerConfig[a].location?this._bottomDomain:this._topDomain:void 0},_returnMarkerData:function(a){return this.hasUndefinedArguments(arguments)?void 0:this._markerData[a]},_returnMargin:function(){return{top:0,bottom:0,left:this.margin.left,right:this.margin.right}},_redraw:function(){this.hasUndefinedArguments(arguments)||(null!==this._topDomain&&null!==this._bottomDomain&&null!==this.domainChanged&&(this.set('_bottomDomain',!this._bottomDomain),this.set('_topDomain',!this._topDomain)),this._lockTooltip&&(this._lockTooltip=!1,this.$.tooltip&&this.$.tooltip.set('opened',!1)))},_mouseMove:function(){var a={mousePos:Px.d3.mouse(this._canvas),pageX:Px.d3.event.pageX,pageY:Px.d3.event.pageY};this._isSearchingTooltip||null===this._topDomain||(window.requestAnimationFrame(function(){this._searchTooltip(a),this._isSearchingTooltip=!1}.bind(this)),this._isSearchingTooltip=!0)},_searchTooltip:function(a){if(!this._lockTooltip){var b=a.mousePos;if(b[0]>this.margin.left&&b[0]<this.width-this.margin.right&&0<b[1]){adjustedMousePos=[b[0]-this.margin.left,b[1]];var c=this._getRowInfoForMouse(b);if(c.index){for(var d,e,f,g=this._findLabelsForRow(c.index),h=[],j=Px.d3.bisector(function(a){return a.x}.bind(this)).right,k=this.x.domain()[1],l=this.x.domain()[0],m=this.x.invert(adjustedMousePos[0]),n=[],o=0;o<g.length;o++)this._markerData[g[o]]&&this._markerData[g[o]].length&&(h=h.concat(this._markerData[g[o]]));h.length&&(h.sort(function(c,a){return Px.d3.ascending(c.x,a.x)}),e=j(h,m),d=Math.max(0,e?e-1:0),!h[d]||h[d].x<l?f=e:!h[e]||h[e].x>k?f=d:h[e]&&h[e].x-m<m-h[d].x?f=e:h[d]&&(f=d),this._createTooltipData(f,h),this._updateTooltip(b,n,this._tooltipDataResult[0],c,a))}}}},_createTooltipData:function(a,b){var c=[],d=0,e=this._findMarkerType(b[a]),f=b[a];for(f.priority=this.markerConfig[e].priority,c.push(f),d=1;b[a+d]&&b[a].x===b[a+d].x;)e=this._findMarkerType(b[a+d]),this.markerConfig[e].showTooltip&&(f=b[a+d],f.priority=this.markerConfig[e].priority,c.push(f)),d++;for(d=-1;b[a+d]&&b[a].x===b[a+d].x;)e=this._findMarkerType(b[a+d]),this.markerConfig[e].showTooltip&&(f=b[a+d],f.priority=this.markerConfig[e].priority,c.push(f)),d--;c.sort(function(c,a){return Px.d3.descending(c.priority,a.priority)}),this.set('_tooltipDataResult',c)},_updateTooltip:function(a,b,c,d,e){var f=!1;if(c){var g=this._findMarkerType(c);g&&this._markerConfig[g].showTooltip&&(b[0]=this.x(c.x)+this.margin.left,Math.abs(b[0]-a[0])<=this.tooltipDetectionRadius&&(b[0]+=e.pageX-a[0],b[1]=e.pageY-a[1]+d.rowY,this.set('_showTooltip',!0),this._checkForTooltip(),this.$.tooltip.mouseCoords=b,this.$.tooltip.orientation=this._markerConfig[g].tooltipOrientation,this.$.tooltip.opened?this.$.tooltip.setPosition():this.$.tooltip.set('opened',!0),f=!0))}this.$.tooltip&&!f&&this.$.tooltip.opened&&this.$.tooltip.set('opened',!1)},_findMarkerType:function(a){for(var b,c=Object.keys(a),d=0;d<c.length;d++)if(-1!==this._markerTypes.indexOf(c[d])){b=c[d];break}return b},_mouseClick:function(){this.$.tooltip&&this.$.tooltip.visible&&(this._lockTooltip=!this._lockTooltip,!this._lockTooltip&&this.$.tooltip.set('opened',!1))},_mouseLeave:function(){this.$.tooltip&&this.$.tooltip.opened&&!this._lockTooltip&&this.$.tooltip.set('opened',!1)},_checkForTooltip:function(){this.$.tooltip||(this.$.tooltipIf.render(),this.$.tooltip=this.$$('px-tooltip'))},_getRowInfoForMouse:function(a){var b,c,d,e,f,g,h=!!(a[1]<=this.margin.top),i=0;return h?(b=0,c=this._topScale,e=this.margin.top):(b=this.height-this.margin.bottom,c=this._bottomScale,e=this.margin.bottom),d=c.domain(),d.length?(f=e/d.length,i=Math.floor((a[1]-b)/f),g=b+(i+0.5)*f):g=b+e/2,{index:d[i],rowY:g}},_findLabelsForRow:function(a){var b=Object.keys(this.markerConfig),c=[];a=+a;for(var d=0;d<b.length;d++)a!==this.markerConfig[b[d]].row&&(0!==a||this.markerConfig[b[d]].row)||c.push(b[d]);return c},_getCanvas:function(){return this.hasUndefinedArguments(arguments)?void 0:this.canvasContext?(void 0===this._canvas&&(Px.d3.select(this.canvasContext.canvas).on('mousemove.markers',this._mouseMove.bind(this)),Px.d3.select(this.canvasContext.canvas).on('mousedown.markers',this._mouseClick.bind(this)),Px.d3.select(this.canvasContext.canvas).on('mouseleave.markers',this._mouseLeave.bind(this))),this.canvasContext.canvas):void 0}});</script></body></html>