<html><head><link rel="import" href="../polymer/polymer.html"><link rel="import" href="../px-vis/px-vis-behavior-chart.html"><link rel="import" href="../px-vis/px-vis-behavior-common.html"><link rel="import" href="../px-vis/px-vis-behavior-d3.html"><link rel="import" href="../px-vis/px-vis-scale.html"><link rel="import" href="../px-vis/px-vis-svg.html"><link rel="import" href="../px-vis/px-vis-pie.html"><link rel="import" href="../px-vis/px-vis-axis.html"><link rel="import" href="../px-vis/px-vis-tooltip.html"><link rel="import" href="../px-vis/px-vis-interaction-space.html"><link rel="import" href="../px-vis/px-vis-register.html"><link rel="import" href="../px-vis/px-vis-cursor.html"><link rel="import" href="../px-vis/px-vis-clip-path.html"><link rel="import" href="css/px-vis-pie-chart-styles.html"></head><body><dom-module id="px-vis-pie-chart"><template><style include="px-vis-pie-chart-styles"></style><div id="wrapper" class$="[[_chartWrapperClass]]"><div class="flex"><div class$="[[_registerWrapperClass]] [[_getAlignment(chartHorizontalAlignment, chartVerticalAlignment, _registerType)]] safari-flex-fix"><px-tooltip id="tooltip" for="popAnchor" orientation="top" delay="10" follow-mouse=""><div style="display:flex; flex-direction:column; align-items:center"><span>{{_ttTitle}}</span> <span>{{_ttMessage}}</span></div></px-tooltip><px-vis-register id="register" class$="[[_getHideClass(hideRegister)]] u-ml-" type="{{_registerType}}" chart-data="[[_internalRegisterData]]" chart-width="[[width]]" dynamic-menu-config="[[dynamicMenuConfig]]" complete-series-config="[[completeSeriesConfig]]" x-axis-type="pie" y-axis-type="pie" use-percentage="[[usePercentage]]"></px-vis-register><div><div style$="position:relative;width:[[_smallerSide]]px;height:0px;"><px-popover id="popover" style="position:relative" position="relative" popover-title="" orientation="top" hide-overlay="" for="popAnchor"></px-popover><div id="popAnchor"></div></div><px-vis-svg id="svg" width="[[_smallerSide]]" height="[[_smallerSide]]" offset="[[_center]]" svg="{{svg}}" px-svg-elem="{{pxSvgElem}}"></px-vis-svg></div></div><px-vis-pie id="pie" svg="[[svg]]" class="absolute" series-color-list="[[seriesColorList]]" width="[[width]]" height="[[height]]" margin="[[margin]]" radius="[[_radius]]" preserve-data-order="[[preserveDataOrder]]" chart-data="[[_internalChartData]]" muted-series="[[mutedSeries]]" clip-path="[[clipPath]]" complete-series-config="[[completeSeriesConfig]]" inner-radius="[[innerRadius]]" donut="[[donut]]" px-svg-elem="[[pxSvgElem]]" use-percentage="[[usePercentage]]" show-title="[[showTitle]]" total="[[_total]]" empty="[[_empty]]"></px-vis-pie></div></div></template></dom-module><script>Polymer({is:'px-vis-pie-chart',behaviors:[PxVisBehaviorD3.svg,PxVisBehavior.dataset,PxVisBehavior.sizing,PxVisBehavior.completeSeriesConfig,PxVisBehaviorChart.chartCommon,PxVisBehaviorChart.saveImage,PxVisBehaviorChart.chartAutoResize,PxVisBehaviorChart.registerPositioning,PxVisBehaviorChart.circleChart,PxColorsBehavior.getSeriesColors,PxColorsBehavior.dataVisColorTheming,PxVisBehavior.dynamicMenuConfig,PxVisBehaviorChart.actionRequest,PxVisBehavior.updateStylesOverride],properties:{registerConfig:{type:Object,observer:'_registerConfigChanged'},showTitle:{type:Boolean,value:!1},_internalChartData:{type:Array,computed:'_getInternalData(chartData.*, completeSeriesConfig.*, _forceColorsUpdate)'},_internalRegisterData:{type:Array,computed:'_getInternalRegisterData(_internalChartData, maxRegisters, completeSeriesConfig, aggregateOtherRegister, _forceColorsUpdate)'},_total:{type:Number,value:0},donut:{type:Boolean,value:!1},innerRadius:{type:Number,value:0},usePercentage:{type:Boolean,value:!1},_empty:{type:Boolean,value:!1},maxRegisters:{type:Number,value:0},preventResize:{type:Boolean,value:!1},decimalPercentage:{type:Number,value:0},aggregateOtherRegister:{type:Boolean,value:!1},preserveDataOrder:{type:Boolean,value:!1},_colorIndexMapping:{type:Object,value:function(){return{}}},preventColorReuse:{type:Boolean,value:!1},_ttMessage:{type:String,value:''},_ttTitle:{type:String,value:''},title:{type:String,value:'Total'},titleSpacing:{type:Number,value:5},_internalUnits:{type:String,computed:'_computeInternalUnits(_currentConfig, usePercentage)'},_currentConfig:{type:String,computed:'_computeSeriesId(completeSeriesConfig.*)'},_forceColorsUpdate:{type:Number,value:1}},observers:['_xAxisConfigChanged(xAxisConfig.*)','_yAxisConfigChanged(yAxisConfig.*)','_positionChanged(_center, _radius)','_drawTitle(svg, showTitle, title, _total, _internalUnits, titleSpacing)','_resetColors(seriesColorList.*)'],listeners:{"iron-resize":'_onIronResize',"px-vis-pie-centered-on-slice":'_showPopover',"px-vis-pie-mouse-enter-slice":'_showTooltip',"px-vis-pie-slice-clicked":'_hideTooltip',"px-vis-pie-mouse-leave-slice":'_hideTooltip'},ready:function(){this.xAxisType='pie',this.yAxisType='pie',this.includeAllSeries=!0},attached:function(){this._onIronResize(),setTimeout(function(){this.chartData&&0!==this.chartData.length||this.set('_empty',!0)}.bind(this),500)},_tooltipConfigChanged:function(a){this._doesObjHaveValues(a)&&this._applyConfigToElement(this.tooltipConfig,this.$.tooltip)},_registerConfigChanged:function(a){this._doesObjHaveValues(a)&&this._applyConfigToElement(this.registerConfig,this.$.register)},_drawTitle:function(){this.hasUndefinedArguments(arguments)||(this.showTitle?this._titleGroup?(this._titleGroup.select('text.title').text(this.title).attr('transform','translate(0,-'+this.titleSpacing+')'),this._titleGroup.select('text.value').text(this._total+' '+this._currentConfig.xAxisUnit).attr('transform','translate(0,'+this.titleSpacing+')')):(this._titleGroup=this.svg.append('g').attr('class','title-group'),this._titleGroup.append('text').attr('class','title').attr('fill',this._checkThemeVariable('--px-vis-pie-title-color','rgb(0,0,0)')).attr('font-size',this._checkThemeVariable('--px-vis-pie-title-font-size','45px')).style('font-family',this._checkThemeVariable('--px-vis-font-family','')).attr('font-style',this._checkThemeVariable('--px-vis-font-family','')).text(this.title).attr('text-anchor','middle').attr('transform','translate(0,-'+this.titleSpacing+')'),this._titleGroup.append('text').attr('class','value').attr('fill',this._checkThemeVariable('--px-vis-pie-title-value-color','rgb(0,0,0)')).attr('font-size',this._checkThemeVariable('--px-vis-pie-title-value-font-size','45px')).style('font-family',this._checkThemeVariable('--px-vis-font-family','')).attr('font-style',this._checkThemeVariable('--px-vis-font-family','')).text(this._total+' '+this._currentConfig.xAxisUnit).attr('text-anchor','middle').attr('alignment-baseline','hanging').attr('transform','translate(0,'+this.titleSpacing+')')):this._titleGroup&&(this._titleGroup.remove(),this._titleGroup=null))},_getInternalData:function(){if(!this._isObjEmpty(this.completeSeriesConfig)){var a=0,b=this._returnKeys(this.completeSeriesConfig)[0],c=this.completeSeriesConfig[b].x,d=this.completeSeriesConfig[b].y,e=[];if(!this.chartData||0===this.chartData.length)this.set('_total',0),this.set('_empty',!0),this._colorIndexMapping={};else{this.set('_empty',!1);for(var f,g=[],h=0;h<this.chartData.length;h++)f=this._colorIndexMapping[this.chartData[h][d]],a+=this.chartData[h][c],e.push(JSON.parse(JSON.stringify(this.chartData[h]))),f&&!this.preventColorReuse&&(g.push(f),e[h].colorIndex=f);this._colorIndexMapping={};for(var i=0,j=this.seriesColorList.length,h=0;h<e.length;h++){if(!e[h].colorIndex){if(g.length===j||g.length>j)i+=1,i%=j;else for(;-1!==g.indexOf(i);)i+=1;e[h].colorIndex=i,g.push(i)}this._colorIndexMapping[e[h][d]]=e[h].colorIndex}this.set('_total',a.toFixed(this.decimalPercentage));for(var h=0;h<e.length;h++)e[h].percentage=(100*(e[h][c]/a)).toFixed(this.decimalPercentage)}return e}},_getInternalRegisterData:function(a,b,c,d){if(!this.hasUndefinedArguments(arguments)){var e=[];if(!b||1>b){e=a.slice(0).sort(function(c,a){return a.percentage-c.percentage});for(var f=0;f<e.length;f++)e[f].backgroundColor=this._getColor(e[f].colorIndex)}else{var g=this._returnKeys(c)[0],h=this.completeSeriesConfig[g].x,i=this.completeSeriesConfig[g].y,j=a.map(function(a,b){return{index:b,value:a[h]}}),k=0,l=b,m={percentage:0,backgroundColor:this.colors.white};m[h]=0,m[i]='Other',0<b&&d&&(l-=1),j.sort(function(c,a){return a.value-c.value}),j.map(function(b){if(k<l){var c={};c=a[b.index],c.backgroundColor=this._getColor(a[b.index].colorIndex),e.push(c)}else d&&(m[h]+=+a[b.index][h],m.percentage+=+a[b.index].percentage);k++}.bind(this)),d&&e.push(m)}return e}},_applyConfigToElement:function(a,b){if('object'!==typeof a)return void console.error('Configuration object must be valid JSON: '+a);if(!b)return void console.error('Cannot apply config to undefined element');for(var c,d=Object.keys(a),e=0;e<d.length;e++)c=d[e],b.set(c,a[c])},_onIronResize:function(){this.preventResize||this.debounce('ironresize',function(){var a=Math.max,b=this.$.wrapper.getBoundingClientRect(),c=this.$.register.getBoundingClientRect();'horizontal'===this.$.register.type?(this.set('width',a(b.width,0)),this.set('height',a(b.height-c.height,0))):(this.set('width',a(b.width-c.width,0)),this.set('height',a(b.height,0)))},this.debounceResizeTiming)},_repositionTitle:function(){this.$.pie._repositionTitle()},_getAlignment:function(a,b,c){if(!this.hasUndefinedArguments(arguments)){var d='';return'horizontal'===c?(d+='center'===a?'flex--middle ':'right'===a?'flex--bottom ':'flex--top ',d+='center'===b?'flex--center':'bottom'===b?'flex--right':'flex--left'):d+='flex--top',d}},_showPopover:function(a){this.$.popover.popoverTitle=a.detail.datum.data[this._currentConfig.y],this.$.popover.popoverBody=this._getSliceValue(a.detail.datum),this.$.popover.show()},_showTooltip:function(a){this._empty?(this.set('_ttTitle','Empty'),this.set('_ttMessage','')):(this.set('_ttTitle',a.detail.datum.data[this._currentConfig.y]),this.set('_ttMessage',this._getSliceValue(a.detail.datum)));var b=Px.d3.arc().centroid(a.detail.rotatedDatum),c=this.pxSvgElem.getBoundingClientRect();this.$.tooltip.mouseCoords=[b[0]+c.left+this._center[0]+window.window.pageXOffset,b[1]+c.top+this._center[1]+window.window.pageYOffset],this.$.tooltip._show()},_hideTooltip:function(){this.$.tooltip._hide()},_positionChanged:function(){this.isVarNumber(this._center)&&this.isVarNumber(thie._radius)&&(this.$.popover.style.top=this._center[1]-this._radius)},_computeInternalUnits:function(){return this.hasUndefinedArguments(arguments)?void 0:this.usePercentage?'%':this._currentConfig.xAxisUnit},_getSliceValue:function(a){return this.usePercentage?a.data.percentage+this._internalUnits:a.data[this._currentConfig.x]+' '+this._internalUnits},_computeSeriesId:function(a){if(this._doesObjHaveValues(a))return this.completeSeriesConfig[Object.keys(this.completeSeriesConfig)[0]]},_resetColors:function(){this._forceColorsUpdate&&(this._colorIndexMapping={},this.set('_forceColorsUpdate',this._forceColorsUpdate+1))}});</script></body></html>