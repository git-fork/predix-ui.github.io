<html><head><link rel="import" href="../polymer/polymer.html"><link rel="import" href="../px-datetime-common/px-datetime-presets.html"><link rel="import" href="../px-datetime-common/px-datetime-buttons.html"><link rel="import" href="../px-datetime-common/px-datetime-button-behavior.html"><link rel="import" href="../px-datetime-common/px-datetime-range-behavior.html"><link rel="import" href="../px-datetime-field/px-datetime-field.html"><link rel="import" href="../px-calendar-picker/px-calendar-picker.html"><link rel="import" href="../app-localize-behavior/app-localize-behavior.html"><link rel="import" href="css/px-datetime-range-panel-styles.html"></head><body><dom-module id="px-datetime-range-panel"><template><style include="px-datetime-range-panel-styles"></style><div id="rangepickerModal" class="rangepicker__box shadow-temporary"><div class="flex"><div><div class="flex"><div class="u-mr+"><px-calendar-picker id="fromCalendar" hide-next-button="{{_areConsecutiveMonth(fromBaseDate, toBaseDate)}}" block-future-dates="{{blockFutureDates}}" block-past-dates="{{blockPastDates}}" base-date="{{fromBaseDate}}" time-zone="[[timeZone]]" day-week-start-index="[[dayWeekStartIndex]]" resources="[[resources]]" language="[[language]]" formats="[[formats]]" min-date="[[minDate]]" max-date="[[maxDate]]"></px-calendar-picker><template is="dom-if" if="{{!hideTime}}"><div class="flex flex--center u-mt+"><px-datetime-field id="time" class="box__time" moment-obj="{{fromMoment}}" hide-icon="" hide-date="" is-valid="{{_fromTimeIsValid}}" time-format="{{timeFormat}}" time-zone="[[timeZone]]" resources="[[resources]]" language="[[language]]" formats="[[formats]]" min-date="[[minDate]]" max-date="[[maxDate]]"></px-datetime-field></div></template></div><div><px-calendar-picker id="toCalendar" hide-previous-button="{{_areConsecutiveMonth(fromBaseDate, toBaseDate)}}" block-future-dates="{{blockFutureDates}}" block-past-dates="{{blockPastDates}}" base-date="{{toBaseDate}}" time-zone="[[timeZone]]" day-week-start-index="[[dayWeekStartIndex]]" resources="[[resources]]" language="[[language]]" formats="[[formats]]" min-date="[[minDate]]" max-date="[[maxDate]]"></px-calendar-picker><template is="dom-if" if="{{!hideTime}}"><div class$="flex flex--center u-mt+ {{_getFieldClass(showButtons)}}"><px-datetime-field id="time" class="box__time" moment-obj="{{toMoment}}" hide-icon="" hide-date="" is-valid="{{_toTimeIsValid}}" time-format="{{timeFormat}}" time-zone="[[timeZone]]" resources="[[resources]]" language="[[language]]" formats="[[formats]]" min-date="[[minDate]]" max-date="[[maxDate]]"></px-datetime-field></div></template></div></div></div><template is="dom-if" if="{{!hidePresets}}"><px-datetime-presets id="presets" class="flex flex--col u-ml+++ u-mr-" preset-ranges="{{presetRanges}}" resources="[[resources]]" language="[[language]]" formats="[[formats]]"></px-datetime-presets></template></div><template is="dom-if" if="{{showButtons}}"><div class="flex flex--row--rev u-mt+++"><px-datetime-buttons is-submit-button-valid="[[_canApply]]" resources="[[resources]]" language="[[language]]" formats="[[formats]]"></px-datetime-buttons></div></template></div></template></dom-module><script>Polymer({is:'px-datetime-range-panel',behaviors:[PxDatetimeBehavior.Range,PxDatetimeBehavior.Buttons],properties:{fromBaseDate:{type:Object,notify:!0,observer:'_fromBaseDateChanged'},toBaseDate:{type:Object,notify:!0,observer:'_toBaseDateChanged'},hidden:{type:Boolean},hidePresets:{type:Boolean,value:!1},presetRanges:{type:Object,value:function(){var a=Px.moment.tz(this.timeZone);return[{displayText:'Last 7 Days',startDateTime:a.clone().subtract(7,'days').startOf('day'),endDateTime:a.clone().endOf('day')},{displayText:'This Month',startDateTime:a.clone().startOf('month'),endDateTime:a.clone().endOf('month')},{displayText:'Last Month',startDateTime:a.clone().subtract(1,'months').startOf('month'),endDateTime:a.clone().subtract(1,'months').endOf('month')}]}},hideTime:{type:Boolean,value:!1},timeFormat:{type:String,value:'HH:mm:ss A'},_internalSet:{type:Boolean,value:!1},_fromTimeIsValid:{type:Boolean,value:!0},_toTimeIsValid:{type:Boolean,value:!0},timeIsValid:{type:Boolean,computed:'_getTimeIsValid(_fromTimeIsValid, _toTimeIsValid, hideTime)'},_canApply:{type:Boolean,computed:'_canApplyComputed(timeIsValid, fromMoment, toMoment)'}},observers:['_updateFromCalendar(fromMoment)','_updateToCalendar(toMoment)'],listeners:{"px-datetime-button-clicked":'_handleButtonClick'},ready:function(){var a=this._fromPicked.bind(this),b=this._toPicked.bind(this),c=this._presetSelected.bind(this);this.$.fromCalendar.addEventListener('px-date-selected',a),this.$.toCalendar.addEventListener('px-date-selected',b),this.addEventListener('px-preset-selected',c)},_presetSelected:function(a){var b={},c={};b='function'===typeof a.detail.startDateTime?Px.moment.tz(a.detail.startDateTime(),this.timeZone):Px.moment.tz(a.detail.startDateTime,this.timeZone),c='function'===typeof a.detail.endDateTime?Px.moment.tz(a.detail.endDateTime(),this.timeZone):Px.moment.tz(a.detail.endDateTime,this.timeZone),this._internalSet=!0,c.isAfter(b.clone().add(1,'months'),'month')?this.set('toBaseDate',c.clone()):this.set('toBaseDate',b.clone().add(1,'months')),this.set('fromBaseDate',b.clone());var d=this._validatePresetDates(b,c);d&&(this.$.fromCalendar.fromMoment=d.start.clone(),this.$.toCalendar.fromMoment=d.start.clone(),this.set('fromMoment',d.preserveStartTime?this._preserveTime(this.fromMoment,d.start.clone()):d.start.clone()),this.$.fromCalendar.toMoment=d.end.clone(),this.$.toCalendar.toMoment=d.end.clone(),this.set('toMoment',d.preserveEndTime?this._preserveTime(this.toMoment,d.end.clone()):d.end.clone())),this._internalSet=!1},_validatePresetDates:function(a,b){var c=Px.moment.tz(Px.moment(),this.timeZone),d={start:null,end:null,preserveStartTime:!1,preserveEndTime:!1},e=this._validateDateBlock(a,c),f=this._validateDateBlock(b,c);return e.blockFutureValid&&e.blockMaxValid&&f.blockMinValid&&f.blockPastValid?(e.blockPastValid||e.blockMinValid?e.blockPastValid?e.blockMinValid?d.start=a:d.start=this.minDate:(d.start=c,d.preserveStartTime=!0):d.start=c.isAfter(this.minDate)?c:this.minDate,f.blockFutureValid||f.blockMaxValid?f.blockFutureValid?f.blockMaxValid?d.end=b:d.end=this.maxDate:(d.end=c,d.preserveEndTime=!0):d.end=c.isBefore(this.maxDate)?c:this.maxDate,d):null},_validateDateBlock:function(a,b){return{blockFutureValid:!this.blockFutureDates||a.isSameOrBefore(b,'day'),blockPastValid:!this.blockPastDates||a.isSameOrAfter(b,'day'),blockMinValid:!this.minDate||a.isAfter(this.minDate),blockMaxValid:!this.maxDate||a.isBefore(this.maxDate)}},_resetRange:function(a){a.toMoment=null,a.fromMoment=null},_rangeIsSelected:function(){return null!==this.$.fromCalendar.fromMoment&&null!==this.$.toCalendar.toMoment||null!==this.$.fromCalendar.fromMoment&&null!==this.$.fromCalendar.toMoment||null!==this.$.toCalendar.fromMoment&&null!==this.$.toCalendar.toMoment},_fromPicked:function(a){this._internalSet=!0,this._rangeIsSelected()&&this._resetRange(this.$.toCalendar),this.hidePresets||(this.$$('px-datetime-presets').selectedItem=null),null===this.$.fromCalendar.toMoment&&null===this.$.toCalendar.toMoment&&null===this.$.toCalendar.fromMoment?this.set('fromMoment',this._preserveTime(this.fromMoment,a.detail)):this.$.fromCalendar.toMoment?(a.detail.isBefore(this.fromMoment)?(this.set('toMoment',this._preserveTime(this.toMoment,this.fromMoment.clone())),this.set('fromMoment',this._preserveTime(this.fromMoment,a.detail))):this.set('toMoment',this._preserveTime(this.toMoment,a.detail)),this.$.toCalendar.fromMoment=this.fromMoment,this.$.toCalendar.toMoment=this.toMoment):(this.$.toCalendar.toMoment=this.toMoment,this.$.toCalendar.fromMoment=a.detail,this.$.fromCalendar.toMoment=this.toMoment,this.set('fromMoment',this._preserveTime(this.fromMoment,a.detail))),this._internalSet=!1},_toPicked:function(a){this._internalSet=!0,this._rangeIsSelected()&&this._resetRange(this.$.fromCalendar),this.hidePresets||(this.$$('px-datetime-presets').selectedItem=null),this.$.fromCalendar.toMoment||this.$.toCalendar.toMoment||this.$.fromCalendar.fromMoment?this.$.toCalendar.toMoment?(a.detail.isAfter(this.toMoment)?(this.set('fromMoment',this._preserveTime(this.fromMoment,this.toMoment.clone())),this.set('toMoment',this._preserveTime(this.toMoment,a.detail))):this.set('fromMoment',this._preserveTime(this.fromMoment,a.detail)),this.$.toCalendar.toMoment=this.toMoment,this.$.toCalendar.fromMoment=this.fromMoment,this.$.fromCalendar.fromMoment=this.fromMoment,this.$.fromCalendar.toMoment=this.toMoment):(this.$.fromCalendar.toMoment=a.detail,this.$.toCalendar.fromMoment=this.$.fromCalendar.fromMoment,this.$.toCalendar.toMoment=a.detail,this.set('toMoment',this._preserveTime(this.toMoment,a.detail))):this.set('toMoment',this._preserveTime(this.toMoment,a.detail)),this._internalSet=!1},_areConsecutiveMonth:function(a,b){return a&&b&&a.isSame(b.clone().subtract(1,'months'),'month')},_fromBaseDateChanged:function(){null===this.fromBaseDate||(!this._internalSet&&this.fromBaseDate&&this.toBaseDate&&this.fromBaseDate.isSameOrAfter(this.toBaseDate,'month')&&this.set('fromBaseDate',Px.moment.tz(this.toBaseDate,this.timeZone).subtract(1,'month')),this.$.fromCalendar.isAtSelectionLevel&&(this.$.toCalendar.blockDatesBefore=Px.moment.tz(this.fromBaseDate,this.timeZone).add(1,'month').startOf('month')))},_toBaseDateChanged:function(){null===this.toBaseDate||(!this._internalSet&&this.fromBaseDate&&this.toBaseDate&&this.toBaseDate.isSameOrBefore(this.fromBaseDate,'month')&&this.set('toBaseDate',Px.moment.tz(this.fromBaseDate,this.timeZone).add(1,'month')),this.$.toCalendar.isAtSelectionLevel&&(this.$.fromCalendar.blockDatesAfter=Px.moment.tz(this.toBaseDate,this.timeZone).subtract(1,'month').endOf('month')))},_updateFromCalendar:function(){this._internalSet||(this.$.fromCalendar.fromMoment=this.fromMoment,this.$.toCalendar.fromMoment=this.fromMoment,this.fromMoment&&null!==this.fromMoment&&this.set('fromBaseDate',this.fromMoment))},_updateToCalendar:function(){this._internalSet||(this.$.fromCalendar.toMoment=this.toMoment,this.$.toCalendar.toMoment=this.toMoment,this.toMoment&&null!==this.toMoment&&this.set('toBaseDate',this.toMoment))},_canApplyComputed:function(a,b,c){return this._validateRangeOrder(b,c)&&a},_getTimeIsValid:function(a,b,c){return c||a&&b},_getFieldClass:function(a){if(!a)return'u-mb+'},_handleButtonClick:function(a){if(!1===this.hidePresets&&!1===a.detail.action){var b=Polymer.dom(this.root).querySelector('px-datetime-presets');b.selectedItem={}}}});</script></body></html>