<html><head><link rel="import" href="../polymer/polymer.html"><link rel="import" href="../iron-a11y-keys-behavior/iron-a11y-keys-behavior.html"><link rel="import" href="px-datetime-validate.html"><link rel="import" href="px-datetime-behavior.html"><link rel="import" href="css/px-datetime-entry-cell-styles.html"></head><body><dom-module id="px-datetime-entry-cell"><template><style include="px-datetime-entry-cell-styles"></style><input id="dtEntry" order="{{order}}" class="text-input--bare" on-focus="_handleFocus" on-blur="_handleBlur" on-paste="_handlePaste" on-beforepaste="_beforePaste" on-beforecopy="_beforeCopy" on-copy="_handleCopy" disabled="[[_getDisabled(momentFormat)]]" type="[[_getType(_isNumber)]]" pattern$="[[_getPattern(_isNumber)]]" placeholder="[[_placeholderText(momentFormat)]]" on-keypress="_keyPress" max$="[[_max]]" min$="[[_min]]" step="1"></template></dom-module><script>Polymer({is:'px-datetime-entry-cell',behaviors:[PxDatetimeBehavior.SingleMoment,PxDatetimeBehavior.Validate,Polymer.IronA11yKeysBehavior],properties:{momentFormat:{type:String,observer:'_formatChanged'},symbol:{type:String},order:{type:Number,reflectToAttribute:!0},isSelected:{type:Boolean,readOnly:!0,notify:!0,value:!1},_max:{type:Number,computed:'_getMax(momentFormat)'},_min:{type:Number,computed:'_getMin(momentFormat)'},_isNumber:{type:Boolean,computed:'_computeIsNumber(momentFormat)'},_cellLength:{type:Number,value:0}},observers:['_updateInputValue(momentObj, timeZone)'],keyBindings:{right:'_moveFocusForward',left:'_moveFocusBack'},attached:function(){this._addGeneralKeyBindings()},clear:function(){this.$.dtEntry.value=''},setValueFromMoment:function(){this.momentObj?this.$.dtEntry.value=this.momentObj.tz(this.timeZone).format(this.momentFormat):this.clear()},_computeIsNumber:function(a){return!/^(?:a|A|MMM|MMMM|Do|ddd|dddd|Z|ZZ)$/.test(a)},_getPattern:function(){return void 0===this._isNumber?null:this._isNumber?'[0-9]*':null},_getType:function(){return void 0===this._isNumber?void 0:this._isNumber?'tel':'text'},_getDisabled:function(){return'Z'===this.momentFormat||'ZZ'===this.momentFormat},_formatChanged:function(){this.momentFormat!==void 0&&(this._updateInputValue(),this._sizeInputs(),this._cellLength='A'===this.momentFormat||'a'===this.momentFormat?2:'Z'!==this.momentFormat&&'ZZ'!==this.momentFormat?this.momentFormat.length:-1)},_sizeInputs:function(){var a,b=window.getComputedStyle(this.$.dtEntry,null),d=b.getPropertyValue('font-size'),e=b.getPropertyValue('font-family'),f=document.createElement('canvas'),c=f.getContext('2d');return'0px'===d||'0'===d||''===d?void setTimeout(function(){this._sizeInputs()}.bind(this),50):void(c.font=d+' '+e,a=this.$.dtEntry.value?c.measureText(this.$.dtEntry.value.toUpperCase()).width:c.measureText(this.$.dtEntry.placeholder).width,a=Math.ceil(a),this.$.dtEntry.style.width=a+'px')},_addGeneralKeyBindings:function(){'A'===this.momentFormat||'a'===this.momentFormat?(this.addOwnKeyBinding('a p','_toggleAMPM'),this.addOwnKeyBinding('down up','_toggleAMPM'),this.addOwnKeyBinding('backspace del','_preventDeleteDefault')):'Z'!==this.momentFormat&&'ZZ'!==this.momentFormat&&this.addOwnKeyBinding('down up','_wraparound')},_addSeparatorKeyBinding:function(){var a=''===this.symbol.trim()?'space':this.symbol.trim();this.addOwnKeyBinding(a,'_moveFocusForward')},_updateInputValue:function(){this.momentObj!==void 0&&this.timeZone!==void 0&&(this.setValueFromMoment(),this._sizeInputs())},_moveFocusBack:function(){setTimeout(function(){this.fire('px-entry-cell-move',{dir:-1})}.bind(this),10)},_moveFocusForward:function(){setTimeout(function(){this.fire('px-entry-cell-move',{dir:1})}.bind(this),10)},_handleFocus:function(){'Z'!==this.momentFormat&&'ZZ'!==this.momentFormat&&this._setIsSelected(!0),this.fire('px-cell-focused')},_wraparound:function(a){var b=a.detail.combo;dtEntryValue=this.$.dtEntry.value,currentVal=dtEntryValue?parseInt(dtEntryValue):this._min-1,isUpDown=!1,'up'===b?(currentVal++,currentVal=currentVal>this._max?this._min:currentVal,currentVal=currentVal<this._min?this._min:currentVal,this.$.dtEntry.value=currentVal,a.preventDefault()):'down'===b&&(currentVal--,currentVal=currentVal>this._max?this._max:currentVal,currentVal=currentVal<this._min?this._max:currentVal,this.$.dtEntry.value=currentVal,a.preventDefault())},_checkValue:function(){if(this.$.dtEntry.value&&1===this.$.dtEntry.value.length&&/^(?:MM|DD|HH|hh|kk|mm|ss|YY)$/.test(this.momentFormat))this.$.dtEntry.value='0'+this.$.dtEntry.value;else if(this.$.dtEntry.value&&2===this.$.dtEntry.value.length&&'YYYY'===this.momentFormat){var a=Px.moment(this.$.dtEntry.value,'YY');this.$.dtEntry.value=a.format(this.momentFormat)}else if(this.$.dtEntry.value&&'S'===this.momentFormat[0]&&this.$.dtEntry.value.length<this.momentFormat.length){var b=parseInt(this.$.dtEntry.value);b=b.toPrecision(this.momentFormat.length)*Math.pow(10,this.momentFormat.length-this.$.dtEntry.value.length),this.$.dtEntry.value=b.toString()}this._sizeInputs()},_handleBlur:function(a){Polymer.dom(a);this._setIsSelected(!1),this._checkValue(),this.fire('px-cell-blurred')},_toggleAMPM:function(a){a.preventDefault();var b=Polymer.dom(a),c=a.detail.combo;'A'===c||'a'===c?(this._setAMPM('AM'),this._moveFocusForward()):'P'===c||'p'===c?(this._setAMPM('PM'),this._moveFocusForward()):('up'===c||'down'===c)&&('AM'===this.$.dtEntry.value||'am'===this.$.dtEntry.value?this._setAMPM('PM'):this._setAMPM('AM'))},_setAMPM:function(a){var b=Px.moment.tz('01:00:00 '+a,'hh:mm:ss '+this.momentFormat,this.timeZone);this.$.dtEntry.value=b.tz(this.timeZone).format(this.momentFormat)},_preventDeleteDefault:function(a){a.preventDefault(),this.clear()},_placeholderText:function(a){var b={Z:'\xB1xx:xx',ZZ:'\xB1xxxx',X:'epoch time (s)',x:'epoch time (ms)',a:'AM',A:'AM'};return b[a]?b[a]:a},_beforeCopy:function(a){a.clipboardData||this.fire('px-request-datetime-entry-copy',window.clipboardData)},_beforePaste:function(a){a.clipboardData||this.fire('px-request-datetime-entry-paste',window.clipboardData)},_handlePaste:function(a){a.clipboardData&&this.fire('px-request-datetime-entry-paste',a.clipboardData),a.preventDefault()},_handleCopy:function(a){a.clipboardData&&this.fire('px-request-datetime-entry-copy',a.clipboardData),a.preventDefault()},_convertMomentFormat:function(){return{Y:'y',M:'M',D:'d',H:'h',h:'h',k:'h',m:'m',s:'s',X:'s',S:'ms',x:'ms'}[this.momentFormat[0]]},_getMax:function(a){return /^(?:M|MM|h|hh)$/.test(a)?12:/^(?:D|DD)$/.test(a)?31:/^(?:H|HH)$/.test(a)?23:/^(?:k|kk)$/.test(a)?24:/^(?:m|mm|ss|s)$/.test(a)?59:'S'===a?9:'SS'===a?99:'SSS'===a?999:'YY'===a?99:'YYYY'===a?9999:''},_getMin:function(a){return /^(?:YY|YYYY|X|x|H|HH|m|mm|s|ss|S|SS|SSS)$/.test(a)?0:/^(?:M|MM|D|DD|h|hh|k|kk)$/.test(a)?1:''},_keyPress:function(a){if('Backspace'!==a.key&&'Delete'!==a.key&&'Cut'!==a.key&&'Copy'!==a.key&&'ArrowLeft'!==a.key&&'ArrowRight'!==a.key){if(('A'===this.momentFormat||'a'===this.momentFormat)&&!/[aApP]/.test(a.key))return void a.preventDefault();if(this._isNumber&&!/[0-9]/.test(a.key))return void a.preventDefault();-1!==this._cellLength&&this.$.dtEntry.value.length===this._cellLength&&(this.$.dtEntry.value='',this._addSeparatorKeyBinding()),this.$.dtEntry.value.length===this._cellLength-1&&this._moveFocusForward()}}});</script></body></html>