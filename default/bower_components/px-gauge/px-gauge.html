<html><head><link rel="import" href="../polymer/polymer.html"><link rel="import" href="css/px-gauge-styles.html"><link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html"><link rel="import" href="../px-vis/px-vis-behavior-common.html"><link rel="import" href="../px-d3-imports/px-d3-imports-step-one.html"><link rel="import" href="../px-d3-imports/px-d3-imports.html"></head><body><dom-module id="px-gauge"><template><style include="px-gauge-styles"></style><div id="chart"><svg xmlns="http://www.w3.org/2000/svg" id="chartSVG"><g id="chartG"><path class="arc chart-filled"></path><path class="arc chart-empty"></path><path class="needle" transform="rotate(-180)"></path></g></svg></div><div class="text-wrapper text--center"><span class="text-value">{{_valueOfProcess}}</span> <span class="text-unit">{{unit}}</span></div></template></dom-module><script>Polymer({is:'px-gauge',behaviors:[PxVisBehavior.sizing,PxVisBehavior.svgDefinition,Polymer.IronResizableBehavior],properties:{value:{type:Number,value:0},error:{type:Array,value:function(){return[]},notify:!0,observer:'_changeFilledGaugeBarState'},anomaly:{type:Array,value:function(){return[]},notify:!0,observer:'_changeFilledGaugeBarState'},abnormal:{type:Array,value:function(){return[]},notify:!0,observer:'_changeFilledGaugeBarState'},normal:{type:Array,value:function(){return[[0,100]]},notify:!0,observer:'_changeFilledGaugeBarState'},_states:{type:Array,value:function(){return['error','abnormal','anomaly','normal']},notify:!0,observer:'_changeFilledGaugeBarState'},min:{type:Number,value:0},max:{type:Number,value:100},unit:{type:String,value:''},_valueOfProcess:{type:Number,value:0,notify:!0},barWidth:{type:Number,value:0,notify:!0},_actualBarWidth:{type:Number,computed:'_computeActualBarWidth(barWidth, width)',observer:'_barWidthChanged'},_calculatedValue:{type:Number,value:0,computed:'_computeValue(value, min, max)',observer:'_valueChanged'},margin:{type:Object,value:function(){return{top:0,right:0,bottom:10,left:0}}},preventResize:{type:Boolean,value:!1},_filledBarArc:{type:Object},_emptyBarArc:{type:Object},_targetPerc:{type:Number,value:0}},observers:['_drawChart(width, height, _chart)'],listeners:{"iron-resize":'_onIronResize'},attached:function(){this.set('svg',Px.d3.select(this.$$('#chartSVG'))),this.set('_chart',this.svg.select('#chartG')),this.notifyResize()},_onIronResize:function(){this.debounce('ironresize',function(){if(!this.preventResize){var a=this.$.chart.getBoundingClientRect();if(!a.width)return void window.requestAnimationFrame(function(){this.async(this.notifyResize,1)}.bind(this));this.set('width',Math.max(a.width,0)),this.set('height',this.width/2)}},100)},_computeValue:function(){return(this.value-this.min)/(this.max-this.min)},_computeActualBarWidth:function(){return parseInt(parseInt(this.barWidth||0)||50*this.width/300)},_d3Select:function(a){return Px.d3.select(this.$$(a))},_percToDeg:function(a){return 360*a},_percToRad:function(a){return this._degToRad(this._percToDeg(a))},_degToRad:function(a){return a*Math.PI/180},_valueChanged:function(){this._chart&&this._moveTo(this._calculatedValue)},_barWidthChanged:function(){this._drawChart(),this._chart&&this._moveTo(this._calculatedValue)},_drawChart:function(){this.svg&&this.debounce('_drawChartDebounced',function(){this._drawChartDebounced(),this._moveTo(this._calculatedValue)},310)},_drawChartDebounced:function(){this.svg.attr('width',this.width+this.margin.left+this.margin.right),this.svg.attr('height',this.height+this.margin.top+this.margin.bottom),this._chart.attr('transform','translate('+(this.width+this.margin.left)/2+', '+(this.height+this.margin.top)+')'),this._calculateGaugeBarsArc(),this._adjustFontSize(),this._generateNeedlePath()},_calculateGaugeBarsArc:function(){var a=this.width/2,b=10;this._filledBarArc=Px.d3.arc().outerRadius(a-b).innerRadius(a-b-this._actualBarWidth),this._emptyBarArc=Px.d3.arc().outerRadius(a-b).innerRadius(a-b-this._actualBarWidth)},_generateNeedlePath:function(){this._chart.select('.needle').attr('d','M 0.114 -'+this.width/60+' c 0 0 0.298 1.273 '+(this.width/2-10)+' '+this.width/90+' c 1.071 0.06 1.091 1.233 -0.035 '+this.width/80+' C '+(this.width/2-10)+' 1.876 1.683 '+this.width/60+' 0.114 '+this.width/60+' Z')},_adjustFontSize:function(){this._d3Select('.text-value').style('font-size',this._actualBarWidth+'px'),this._d3Select('.text-unit').style('font-size',0.8333*this._actualBarWidth+'px')},_repaintGauge:function(){var a=.75,b=this._percToRad(a),c=b+this._percToRad(this._currentPerc/2);this._filledBarArc.startAngle(b).endAngle(c),a+=this._currentPerc/2,b=this._percToRad(a),c=b+this._percToRad((1-this._currentPerc)/2),this._emptyBarArc.startAngle(b).endAngle(c),this._chart.select('.chart-filled').attr('d',this._filledBarArc),this._chart.select('.chart-empty').attr('d',this._emptyBarArc),this._changeFilledGaugeBarState()},_changeFilledGaugeBarState:function(){this._chart&&this._states&&this._states.forEach(function(a){var b=!1,c=this[a];if(c){for(var d,e=0;e<c.length;e++)d=c[e],b||(b=this.value>d[0]&&this.value<=d[1]);this._chart.select('.chart-filled').classed(a,b)}}.bind(this))},_moveTo:function(a){if(this._filledBarArc&&this._emptyBarArc){if(a=a||0,1<a)return;var b=Px.d3.scaleLinear().range([0,1]).domain([0,1]),c=this._targetPerc;this._chart.transition().delay(100).ease(Px.d3.easeCubic).duration(800).select('.needle').tween('progress',function(){return function(d){return this._currentPerc=c+d*(a-c),this.set('_valueOfProcess',(1==d?this.value:parseInt(this.min+this._currentPerc*(this.max-this.min)))||0),this._repaintGauge(),this._d3Select('.needle').attr('transform','rotate('+(-180+180*b(this._currentPerc))+')')}.bind(this)}.bind(this)).on('end',function(){this.set('_targetPerc',a)}.bind(this))}}});</script></body></html>