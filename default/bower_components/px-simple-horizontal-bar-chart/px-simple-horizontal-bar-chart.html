<html><head><link rel="import" href="../polymer/polymer.html"><link rel="import" href="../px-simple-chart-common-behavior/px-simple-chart-common-behavior.html"><link rel="import" href="../px-simple-chart-common-behavior/px-simple-chart-common-behavior-colors.html"><link rel="import" href="css/px-simple-horizontal-bar-chart-styles.html"><script type="text/javascript" src="../es6-promise/es6-promise.min.js"></script><script type="text/javascript" src="../d3/d3.js"></script></head><body><dom-module id="px-simple-horizontal-bar-chart"><template><style include="px-simple-horizontal-bar-chart-styles"></style><svg class="px-simple-horizontal-bar-chart-svg"></svg></template></dom-module><script>Polymer({is:'px-simple-horizontal-bar-chart',behaviors:[PxSimpleChartCommonBehavior.common,PxSimpleChartCommonBehavior.colors],_defaultMeasurements:{_legendBoxSize:12,_legendBoxHeight:12,_legendBoxWidth:3,_legendMargin:5,_legendTextWidth:115,_legendPadding:19,_legendMarginTop:8,_barPadding:2,_minimumBarHeight:10},properties:{chartData:{type:Array,observer:'_drawChart',value:function(){return[29,20,15,18,8,10]}},legendLabels:{type:Array,observer:'_drawChart',value:function(){return['Bar One','Bar Two','Bar Three','Bar Four','Bar Five','Bar Six','Bar Seven','Bar Eight','Bar Nine','Bar Ten','Bar Eleven','Bar Twelve','Bar Thirteen','Bar Fourteen','Bar Fifteen']}},colors:{type:Array,observer:'_drawChart',value:function(){return[]}},barLabels:{type:String,observer:'_drawChart',value:'percentage'},domainMin:{type:Number,observer:'_drawChart',value:0},domainMax:{type:Number,observer:'_drawChart'}},observers:['_drawChart(seriesColorList.*,seriesConfig.*)'],_setDefaultMeasurements:function(){for(var a in this._defaultMeasurements)this[a]=this._defaultMeasurements[a];this._legendColumnWidth=this._legendBoxSize+this._legendMargin+this._legendTextWidth,this._legendItemHeight=this._legendMargin+this._legendBoxSize},_getColor:function(a){return this.colors.length?this._getLocalColor(a):this._getDataVisColor(a)},_getLocalColor:function(a){return 0<=a&&a<this.colors.length?this.colors[a]:this._getColor(Math.abs(this.colors.length-a))},_drawChartDebounced:function(){if(this.chartData&&0<this.chartData.length&&this.svg){this._setDefaultMeasurements(),this._clearSVG(this.svg),this._setDimensions();var a=this._isThereEnoughSpaceForLegend();this._setSizes(a),this._drawSVG(),this._setScales(),this._drawBars(),this._drawLeftLine(),a&&this._drawLegend(),this._addStyleScope(this.svg)}else var b=this,c=setTimeout(function(){b._drawChartDebounced()},100)},_setSizes:function(a){this.chartWidth=this.widthValue-this._getBarLabelWidth();var b=a?this.heightValue-this._getLegendHeight():this.heightValue;this.barHeight=Math.round(b/this.chartData.length)-this._barPadding,this.barHeight<this._minimumBarHeight?console.error('The bar height is too low. In order to improve rendering of the chart, increase the height of the chart or remove data points being charted.'):1>this.barHeight&&console.error('The height of your chart is too low to render the component.');this.chartHeight=(this.barHeight+this._barPadding)*this.chartData.length-this._barPadding},_getBarLabelWidth:function(){return 60},_drawSVG:function(){this.svg.attr('width',this.widthValue).attr('height',this.heightValue)},_setScales:function(){this.domainMax?this.domainMax<d3.max(this.chartData)?(console.error('domainMax input is less than the Max Chart Data'),this.xScale=d3.scale.linear().domain([0,d3.max(this.chartData)]).range([0,this.chartWidth])):this.xScale=d3.scale.linear().domain([this.domainMin,this.domainMax]).range([0,this.chartWidth]):this.xScale=d3.scale.linear().domain([0,d3.max(this.chartData)]).range([0,this.chartWidth])},_getMaxNumberOfColumns:function(){return Math.floor(this.widthValue/this._legendColumnWidth)},_getMaxLegendColumns:function(){var a=Math.floor,b=this._getMaxNumberOfColumns();if(1<=this.chartData.length/b)return a(b);var c=a(this.chartData.length%b);return 0===c?b:c},_getMaxItemsInColumn:function(){return Math.ceil(this.chartData.length/this._getMaxLegendColumns())},_getLegendHeight:function(){return this._getMaxItemsInColumn()*this._legendItemHeight+this._legendMarginTop},_drawLegendBox:function(a,b,c){var d=this.svg.append('rect').attr('class','legend-box').attr('x',a).attr('y',b).attr('width',this._legendBoxWidth).attr('height',this._legendBoxSize).attr('fill',c);return this._addStyleScopeToElement(d),d},_drawLegendLabel:function(a,b,c){var d=this.svg.append('text').attr('class','legend-text').attr('x',a+3).attr('y',b+10).text(c);return this._addStyleScopeToElement(d),d},_drawLegendItem:function(a){var b=this.legendLabels[a],c=this._getColor(a),d=this._getMaxItemsInColumn(),e=this._legendTextWidth,f=Math.floor(a/d),g=f*this._legendColumnWidth,h=this._legendItemHeight*d*f,i=a*this._legendItemHeight+this.chartHeight-h+this._legendMarginTop;typeof i!==Number;var j=this,k=this._shortenText(b,e);k.then(function(a){j._drawLegendBox(g,i,c),j._drawLegendLabel(g+j._legendMargin,i,a)}).catch(function(a){console.log('labelTextPromise rejected:',a)})},_shortenText:function(a,b){var c=this;return new Promise(function(d){var e=c._calculateTextWidth(a,'legend-text');e.then(function(e){if(e<=b)d(a);else{var f=a.substring(0,a.length-4)+'...',g=c._shortenText(f,b);g.then(function(a){d(a)}).catch(function(a){console.log('shortenPromise failed. Reason: ',a)})}}).catch(function(a){console.log('widthPromise failed. Reason: ',a)})})},_getNumberOfColumnsUsed:function(){return Math.ceil(this.chartData.length/this._getMaxItemsInColumn())},_getWidthUsedByLegend:function(){return this._legendColumnWidth*this._getNumberOfColumnsUsed()},_drawLegend:function(){var a,b=this.chartData.length;this.legendLabels.length<this.chartData.length&&console.error('There are not enough legend-labels defined for the chart data.');var c=this.widthValue-this._getWidthUsedByLegend();for(this._legendTextWidth+=Math.floor(c/this._getNumberOfColumnsUsed())-this._legendMargin,this._legendColumnWidth=this._legendBoxSize+this._legendMargin+this._legendTextWidth,a=0;a<b;a++)this._drawLegendItem(a)},_drawBar:function(a,b,c,d,e){this.svg.append('rect').attr('class','bar').attr('x',a).attr('y',b).attr('width',c).attr('height',d).attr('fill',e)},_calculateLabelCenterOffset:function(a){var b=a.height,c=Math.abs(this.barHeight-b),d=c/2-this._barPadding+b;return Math.round(d-0.1*d)},_drawBarLabel:function(a,b,c){var d=this._calculateTextSize(c),e=this.widthValue,f=this;d.then(function(a){var d=a.width,g=f._calculateLabelCenterOffset(a),h=f.svg.append('text').attr('class','bar-label').attr('x',e-d-10).attr('y',b+g).attr('width',d).text(c);f._addStyleScopeToElement(h)}).catch(function(a){console.log('textSizePromise rejected: ',a)})},_sum:function(a){return a.reduce(function(a,b){return a+b})},_getPercent:function(a,b){return Math.round(100*(a/b))},_getPercentAccurate:function(a,b){return Math.round(10*(100*(a/b)))/10},_percentagesNeedFloatingPoint:function(a){var b=this._sum(a),c=0,d=a.length,e=0;for(c=0;c<d;c++)e+=this._getPercent(a[c],b);return 100!==e},_drawBars:function(){var a,b,c,d,e,f=this.chartData.length,g=0,h=this._sum(this.chartData),i=this._isThereEnoughSpaceForBarLabels(),j=this._percentagesNeedFloatingPoint(this.chartData)?this._getPercentAccurate:this._getPercent;for(g;g<f;g++)a=this.chartData[g],textLabel='values'==this.barLabels?a:0==a?a+'%':j(a,h)+'%',b=Math.floor(this.xScale(a)),d=0,c=g*(this.barHeight+this._barPadding),e=this._getColor(g),this._drawBar(d,c,b,this.barHeight,e),i&&this._drawBarLabel(d,c,textLabel)},_drawLeftLine:function(){this.svg.append('line').attr('class','bar-chart-left-line').attr('x1',0).attr('y1',0).attr('x2',0).attr('y2',this.chartHeight)},_minChartHeight:function(a){return a*this.chartData.length+this._legendMarginTop+this._legendItemHeight*this._getMaxItemsInColumn()},_isThereEnoughSpaceForBarLabels:function(){return this._minChartHeight(14)<=this.heightValue},_isThereEnoughSpaceForLegend:function(){return this._minChartHeight(3)<=this.heightValue}});</script></body></html>