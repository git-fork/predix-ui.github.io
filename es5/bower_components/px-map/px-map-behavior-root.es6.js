(function(){'use strict';window.PxMapBehavior=window.PxMapBehavior||{},PxMapBehavior.TrackMarkersImpl={properties:{fitToMarkers:{type:Boolean,value:!1,observer:'_fitMapToMarkersIfSet'},fitToMarkersPadding:{type:Number,value:0.15},fitToMarkersZoom:{type:String,value:'max'}},addInst:function(){this.listen(this,'px-map-marker-added','_handleMarkerAdded'),this.listen(this,'px-map-marker-group-features-changed','_handleMarkerGroupUpdated'),this._knownMarkers=this._knownMarkers||new Map,PxMapBehavior.LeafletRootImpl.addInst.call(this)},removeInst:function(){this.unlisten(this,'px-map-marker-added','_handleMarkerAdded'),this.unlisten(this,'px-map-marker-group-features-changed','_handleMarkerGroupUpdated'),this._knownMarkers&&this._knownMarkers instanceof Map&&this._knownMarkers.clear(),this._knownMarkers=null,PxMapBehavior.LeafletRootImpl.removeInst.call(this)},_handleMarkerAdded:function(a){if(this._knownMarkers){var b=Polymer.dom(a);b.rootTarget&&b.rootTarget.elementInst&&b.event.detail.latLng&&(this._knownMarkers.set(b.rootTarget.elementInst,b.event.detail.latLng),this.listen(b.rootTarget,'px-map-marker-removed','_handleMarkerRemoved'),this._fitMapToMarkersIfSet())}},_handleMarkerRemoved:function(a){if(this._knownMarkers){var b=Polymer.dom(a),c=this._knownMarkers.has(b.rootTarget.elementInst||null);c&&(this.unlisten(b.rootTarget,'px-map-marker-removed','_handleMarkerRemoved'),this._knownMarkers.delete(b.rootTarget.elementInst))}},_handleMarkerGroupUpdated:function(a){if(this._knownMarkers){var b=Polymer.dom(a),c=this._knownMarkers.has(b.rootTarget.elementInst||null);b.rootTarget&&b.rootTarget.elementInst&&(!c&&this.listen(b.rootTarget,'px-map-marker-group-removed','_handleMarkerGroupRemoved'),this._knownMarkers.set(b.rootTarget.elementInst,b.event.detail.bounds),this._fitMapToMarkersIfSet())}},_handleMarkerGroupRemoved:function(a){if(this._knownMarkers){var b=Polymer.dom(a),c=this._knownMarkers.has(b.rootTarget.elementInst||null);c&&(this.unlisten(b.rootTarget,'px-map-marker-group-removed','_handleMarkerGroupRemoved'),this._knownMarkers.delete(b.rootTarget.elementInst))}},_fitMapToMarkers:function(){this.debounce('fit-map-to-bounds',function(){if(this._knownMarkers&&this._knownMarkers.size){var a=this._markersToBoundsWithPadding(this._knownMarkers,this.fitToMarkersPadding);if(a&&a.isValid()){var b=a.getCenter(),c=this._getZoomLevelForFit(a,this.fitToMarkersZoom,this.elementInst);this.elementInst.setView(b,c)}}},10)},_markersToBoundsWithPadding:function(a,b){if(a&&a.size){var c=L.latLngBounds();return a.forEach(function(a){(a instanceof L.LatLng||a instanceof L.LatLngBounds)&&c.extend(a)}),c.isValid()&&'number'===typeof b&&(c=c.pad(b)),c}},_getZoomLevelForFit:function(a,b,c){if('min'===b){var d=c.getMinZoom()||0;return d}if('max'===b){var e=c.getBoundsZoom(a,!0)-1;return e}},_fitMapToMarkersIfSet:function(){this.elementInst&&this.fitToMarkers&&this._fitMapToMarkers()},fitMapToMarkers:function(){return this.elementInst&&this._knownMarkers&&this._knownMarkers.size&&(this._fitMapToMarkers(),!0)}},PxMapBehavior.LeafletRootImpl={properties:{crs:{type:Object},lat:{type:Number,value:37.7672375,notify:!0,observer:'shouldUpdateInst'},lng:{type:Number,value:-121.9584131,notify:!0,observer:'shouldUpdateInst'},zoom:{type:Number,value:10,notify:!0,observer:'shouldUpdateInst'},maxZoom:{type:Number,observer:'shouldUpdateInst'},minZoom:{type:Number,observer:'shouldUpdateInst'},maxBounds:{type:Array,observer:'shouldUpdateInst'},disableDragging:{type:Boolean,value:!1,observer:'shouldUpdateInst'},disableScrollZoom:{type:Boolean,value:!1,observer:'shouldUpdateInst'},disableTouchZoom:{type:Boolean,value:!1,observer:'shouldUpdateInst'},disableDoubleClickZoom:{type:Boolean,value:!1,observer:'shouldUpdateInst'},disableAttribution:{type:Boolean,value:!1},attributionPrefix:{type:String,value:'<a href="http://leafletjs.com" title="A JS library for interactive maps">Leaflet</a>',observer:'shouldUpdateInst'},flexToSize:{type:Boolean,reflectToAttribute:!0,value:!1}},attached:function(){var a=this;this.listen(this,'px-map-element-ready-to-add','shouldAddInst'),Polymer.Element?(this._afterFirstRender=!1,Polymer.RenderStatus.afterNextRender(this,function(){a._afterFirstRender=!0,a.canAddInst()&&a.fire('px-map-element-ready-to-add')})):this._afterFirstRender=!0,this.canAddInst()&&this.fire('px-map-element-ready-to-add')},detached:function(){this.unlisten(this,'px-map-element-ready-to-add','shouldAddInst'),this.shouldRemoveInst(),this.removeInst()},shouldAddInst:function(a){Polymer.dom(a).rootTarget!==this||(PxMapBehavior.ElementImpl.shouldAddInst.call(this),this.addInst())},canAddInst:function(){if('undefined'!==typeof this.zoom&&this._canBeNum(this.zoom)&&this._afterFirstRender)return this.latLngIsValid(this.lat,this.lng,!0)},createInst:function(a){var b=Polymer.dom(this.root).querySelector('#map'),c=L.map(b,a);return c.attributionControl.setPrefix(a.attributionPrefix),this.isShadyScoped()&&(c.__addShadyScope=this.scopeSubtree.bind(this)),c},addInst:function(){this.isShadyScoped()&&this.scopeSubtree(this.$.map,!0);var a=this._handleMapMove.bind(this),b=this._handleZoomStart.bind(this),c=this._handleZoomEnd.bind(this);this.bindEvents({moveend:a,zoomstart:b,zoomend:c})},removeInst:function(){this.isShadyScoped()&&this.scopeSubtree(this.$.map,!1)},getInstOptions:function(){var a={zoomControl:!1,crs:this.crs||L.CRS.EPSG3857,center:[this.lat,this.lng],zoom:this.zoom,minZoom:this.minZoom||0,maxZoom:this.maxZoom||18,maxBounds:this.maxBounds||void 0,dragging:!this.disableDragging,scrollWheelZoom:!this.disableScrollZoom,touchZoom:!this.disableTouchZoom,doubleClickZoom:!this.disableDoubleClickZoom,attributionControl:!this.disableAttribution,attributionPrefix:this.attributionPrefix};return a},updateInst:function(a,b){this.latLngIsValid(b.center[0],b.center[1])&&(a.center[0]!==b.center[0]||a.center[1]!==b.center[1]||a.zoom!==b.zoom)&&this._updateMapView(),a.maxZoom===b.maxZoom||isNaN(b.maxZoom)||this.setMaxZoom(b.maxZoom),a.minZoom===b.minZoom||isNaN(b.minZoom)||this.setMinZoom(b.minZoom),a.maxBounds===b.maxBounds||isNaN(b.maxBounds)||this.setMaxBounds(b.maxBounds),!a.dragging&&b.dragging&&this.elementInst.dragging.enable(),a.dragging&&!b.dragging&&this.elementInst.dragging.disable(),!a.scrollWheelZoom&&b.scrollWheelZoom&&this.elementInst.scrollWheelZoom.enable(),a.scrollWheelZoom&&!b.scrollWheelZoom&&this.elementInst.scrollWheelZoom.disable(),!a.touchZoom&&b.touchZoom&&this.elementInst.touchZoom.enable(),a.touchZoom&&!b.touchZoom&&this.elementInst.touchZoom.disable(),!a.doubleClickZoom&&b.doubleClickZoom&&this.elementInst.doubleClickZoom.enable(),a.doubleClickZoom&&!b.doubleClickZoom&&this.elementInst.doubleClickZoom.disable(),a.attributionPrefix!==b.attributionPrefix&&this.elementInst.attributionControl.setPrefix(b.attributionPrefix)},invalidateSize:function(){this.elementInst&&this.elementInst.invalidateSize()},_updateMapView:function(){this.elementInst&&this.debounce('update-map-view',function(){var a=this.elementInst.getCenter(),b=a.lat,c=a.lng,d=this.elementInst.getZoom();(this.lat!==b||this.lng!==c||this.zoom!==d)&&this.elementInst.setView([this.lat,this.lng],this.zoom)})},_canBeNum:function(a){return!isNaN(a)&&''!==a},latLngIsValid:function(a,b,c){var d='undefined'!==typeof a&&this._canBeNum(a)&&'undefined'!==typeof b&&this._canBeNum(b);return!!d||(c||console.log('PX-MAP CONFIGURATION ERROR:\n          You entered an invalid `lat` or `lng` attribute for '+this.is+'. You must pass a valid number.'),!1)},_handleMapMove:function(){return this.__isZooming?void(this.__onZoomEnd=this._handleMapMove.bind(this)):void this.debounce('handle-map-move',function(){var a=this.elementInst.getCenter(),b=this.elementInst.getZoom(),c=this.elementInst.getBounds();(this.lat!==a.lat||this.lng!==a.lng)&&(this.set('lat',a.lat),this.set('lng',a.lng)),this.zoom!==b&&this.set('zoom',b),this.fire('px-map-moved',{lat:a.lat,lng:a.lng,zoom:b,bounds:c})})},_handleZoomStart:function(){this.__isZooming=!0},_handleZoomEnd:function(){this.__isZooming=!1,'function'===typeof this.__onZoomEnd&&(this.__onZoomEnd(),this.__onZoomEnd=null)},getVisibleMarkers:function(){var a=this.elementInst.getBounds(),b=[];return this.elementInst.eachLayer(function(c){c.isMarker&&c.getLatLng&&a.contains(c.getLatLng())&&-1===b.indexOf(c)&&b.push(c),c._markerCluster&&c.eachLayer(function(d){var e=c.getVisibleParent(d);e&&a.contains(e.getLatLng())&&d&&-1===b.indexOf(d)&&b.push(d)})}),b}},PxMapBehavior.LeafletRoot=[PxMapBehavior.Element,PxMapBehavior.ParentLayer,PxMapBehavior.LeafletRootImpl,PxMapBehavior.TrackMarkersImpl]})();