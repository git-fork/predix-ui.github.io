<html><head><link rel="import" href="../polymer/polymer.html"><link rel="import" href="css/px-heatmap-grid-styles.html"><link rel="import" href="../px-tooltip/px-tooltip.html"><link rel="import" href="../px-icon-set/px-icon-set.html"><link rel="import" href="../px-icon-set/px-icon.html"></head><body><dom-module id="px-heatmap-grid-table"><template><style include="px-heatmap-grid-styles"></style><div class="table-container flex flex--row"><template is="dom-if" if="{{!hideRowHeader}}"><div class$="u-pl- u-pr- table-row-header flex flex--col flex--justify {{disabledHeader}}"><template is="dom-if" if="{{showAggregation}}"><div class="row-header"><div class="row-header-text"><span>{{aggregationType}}</span></div></div></template><template is="dom-repeat" items="{{rows}}" as="row"><div class="row-header flex flex--row flex--middle flex--justify" on-click="_sortRow"><div class="row-header-text" id="row-header-{{index}}">{{_getHeader("row", index, rows)}}</div><px-icon class="actionable actionable--select u-ml-" icon="px-utl:chevron-left" hidden$="{{_sortingIcon(index,'row','up', heatmapData)}}"></px-icon><px-icon class="actionable actionable--select u-ml-" icon="px-utl:chevron-right" hidden$="{{_sortingIcon(index,'row','down', heatmapData)}}"></px-icon><px-tooltip smart-orientation="true" orientation="right" for="row-header-{{index}}" delay="100" tooltip-message="{{_getHeader('row', index, rows)}}"></px-tooltip></div></template></div></template><div class="table-container flex flex--row flex--left flex--top"><template is="dom-if" if="{{showRowAggregation}}"><div class="table-column"><div class="u-pr-- u-pb-- u-pl-- col-header" hidden$="{{hideColHeader}}"><div class="col-header-text">{{aggregationType}}</div></div><div class="u-p-- table-empty-cell" hidden$="{{!showColAggregation}}"><span>&nbsp;</span></div><template is="dom-repeat" items="{{rowAggregatedData}}"><div class="u-p-- table-cell"><span>{{item}}</span></div></template></div></template><template is="dom-repeat" items="{{heatmapData}}" as="items" id="heatmapDataRepeat"><div class="table-column"><template is="dom-if" if="{{!hideColHeader}}"><div class="u-pr-- u-pb-- u-pl-- col-header flex flex--row flex--middle flex--justify" on-click="_sortCol"><div class="col-header-text" id="col-header-{{index}}">{{_getHeader("col", index, cols)}}</div><px-icon class="actionable actionable--select u-ml-" icon="px-utl:chevron-up" hidden$="{{_sortingIcon(index,'col','up',heatmapData)}}"></px-icon><px-icon class="actionable actionable--select u-ml-" icon="px-utl:chevron" hidden$="{{_sortingIcon(index,'col','down',heatmapData)}}"></px-icon><px-tooltip smart-orientation="true" orientation="bottom" for="col-header-{{index}}" delay="100" tooltip-message="{{_getHeader('col', index, cols)}}"></px-tooltip></div></template><template is="dom-if" if="{{showColAggregation}}"><div class="u-p-- table-cell"><span>{{_getColAggregation(index, colAggregatedData)}}</span></div></template><template is="dom-repeat" items="{{items}}" as="item"><div class="u-p-- table-cell cell-values" style$="[[item.color]]"><span hidden$="{{hideValues}}">{{item.value}}</span><template is="dom-if" if="{{hideValues}}"><px-tooltip smart-orientation="true" orientation="bottom" delay="100" tooltip-message="{{item.value}}"></px-tooltip></template></div></template></div></template></div></div></template></dom-module><script>Polymer({is:'px-heatmap-grid-table',properties:{data:{type:Array,value:function(){return[]},notify:!0,observer:'_dataChanged'},heatmapData:{type:Array,value:function(){return[]}},config:{type:Object,value:function(){return{minValue:0,maxValue:0,startColor:[],endColor:[],factors:[]}},observer:'_configChanged'},scale:{type:Array,value:function(){return[0,100]},observer:'_scaleChanged'},hideColHeader:{type:Boolean,value:!1,observer:'_hideColHeaderChanged',notify:!0},hideRowHeader:{type:Boolean,value:!1,observer:'_hideRowHeaderChanged'},hideValues:{type:Boolean,value:!1},aggregationType:{type:String,value:'',observer:'_calculateAggregation'},showAggregation:{type:Boolean,value:!1,observer:'_showAggregationChanged'},availableAggregations:{type:Array,value:['AVERAGE','MAX','MIN','SUM','COUNT','STD']},scaleColorFrom:{type:String,observer:'_scaleColorFromChanged'},scaleColorTo:{type:String,observer:'_scaleColorToChanged'}},attached:function(){this._dataChanged(this.data,[]),this._configChanged(this.config,{})},ready:function(){this.addEventListener('px-tooltip-request-show',this._hideTooltip)},detached:function(){this.removeEventListener('px-tooltip-request-show',this._hideTooltip)},_dataChanged:function(a,b){if(a!=b&&a&&a.length&&null!==a[0]){var c=[],d=[],e=[],f={};Array.isArray(a[0])?e=this._processNewDataArray(a):'object'!==babelHelpers.typeof(a[0])&&'string'!==typeof a[0]?e=this._processNewDataNumber(a):'object'===babelHelpers.typeof(a[0])&&a[0].values?(f=this._processNewDataObject(a),e=f.tableData,c=f.rows,d=f.cols):'string'!==typeof a[0]&&(f=this._processNewDataFullObject(a),e=f.tableData,c=f.rows,d=f.cols),c.length=Object.keys(c).length,d.length=Object.keys(d).length,this.set('heatmapData',[]),this.set('rows',c),this.set('cols',d),this.set('heatmapData',e),this._calculateAggregation(this.aggregationType,''),this._hideColHeaderChanged(!1,!0),this._hideRowHeaderChanged(!1,!0),this._initializeRowsOrdering(),this._initializeColsOrdering()}},_processNewDataArray:function(a){for(var b=[],c=[],d=a.length,e=0;e<d;e++)for(var f,g=a[e],h=g.length,i=0;i<h;i++)f=g[i],c[i]||c.push([]),b=void 0==this.config?[255,255,255]:this._calculateColor(f),c[i][e]={value:f,color:b?'background-color: rgb('+b[0]+','+b[1]+','+b[2]+');':''};return c},_processNewDataObject:function(a){for(var b=[],c=-1,d=-1,e=[],f=[],g=[],h=a.length,k=0;k<h;k++){var i=a[k],l=i.values.length;c=i.row?Object.keys(f).indexOf(i.row):-2,d=i.col?Object.keys(g).indexOf(i.col):-2,-2===d&&(f[i.row]=i.row),-2===c&&(g[i.col]=i.col);for(var m,n=0;n<l;n++)m=i.values[n],b=void 0==this.config?[255,255,255]:this._calculateColor(m),-2===d?(0===k&&e.push([]),e[n].push({value:m,color:b?'background-color: rgb('+b[0]+','+b[1]+','+b[2]+');':''})):(0===n&&e.push([]),e[k].push({value:m,color:b?'background-color: rgb('+b[0]+','+b[1]+','+b[2]+');':''}))}return{tableData:e,rows:f,cols:g}},_processNewDataNumber:function(a){for(var b,c=[],d=[],e=a.length,f=0;f<e;f++)b=a[f],c=void 0==this.config?[255,255,255]:this._calculateColor(b),d.push([{value:b,color:c?'background-color: rgb('+c[0]+','+c[1]+','+c[2]+');':''}]);return d},_processNewDataFullObject:function(a){for(var b,c=[],d=-1,e=-1,f=[],g=[],h=[],j=a.length,k=0;k<j;k++)b=a[k],b&&(d=Object.keys(g).indexOf(b.row),e=Object.keys(h).indexOf(b.col),-1===e&&(h[b.col]=b.col,f.push([]),e=Object.keys(h).length-1),-1===d&&(g[b.row]=b.row,d=Object.keys(g).length-1),c=void 0==this.config?[255,255,255]:this._calculateColor(b.value),f[e][d]={value:b.value,color:c?'background-color: rgb('+c[0]+','+c[1]+','+c[2]+');':''});return{tableData:f,rows:g,cols:h}},_initializeRowsOrdering:function(){var a=[],b=this.rows.length;if(this.rows&&b){for(var c=0;c<b;c++)a.push({index:c,value:Object.keys(this.rows)[c]});this.initialRowsOrder=a}else if(this.heatmapData&&this.heatmapData.length){b=this.heatmapData[0].length;for(var c=0;c<b;c++)a.push({index:c,value:this.heatmapData[0][c].value});this.initialRowsOrder=a}},_initializeColsOrdering:function(){var a=[],b=this.cols.length;if(this.cols&&b){for(var c=0;c<b;c++)a.push({index:c,value:Object.keys(this.cols)[c]});this.initialColsOrder=a}else if(this.heatmapData&&this.heatmapData.length){b=this.heatmapData.length;for(var c=0;c<b;c++)a.push({index:c,value:this.heatmapData[c][0].value});this.initialColsOrder=a}},_calculateColor:function(a){var b=this.config,c=[];if(a<b.minValue||a>b.maxValue)c=null;else for(var d=b.factors.length,e=0;e<d;e++)c.push(Math.round(b.factors[e]*(a-b.minValue))+b.startColor[e]);return c},_configChanged:function(a,b){if(a!==b&&a){var c,d,e,f,g=this.config;if(this.scaleColorFrom){c=this.scaleColorFrom.replace(/[^\d,]/g,'').split(','),g.startColor=[],d=c.length;for(var h=0;h<d;h++)g.startColor.push(+c[h])}if(this.scaleColorTo){c=this.scaleColorTo.replace(/[^\d,]/g,'').split(','),g.endColor=[],d=c.length;for(var h=0;h<d;h++)g.endColor.push(+c[h])}e=g.maxValue-g.minValue,d=g.endColor.length,g.factors=[];for(var h=0;h<d;h++)g.factors.push((g.endColor[h]-g.startColor[h])/e);f=[].concat(this.data),this.set('data',f)}},_scaleChanged:function(a,b){a!==b&&a&&2===a.length&&(this.set('config.minValue',a[0]),this.set('config.maxValue',a[1]),this._configChanged(this.config,{}))},_getHeader:function(a,b){if('col'===a)return this.cols[Object.keys(this.cols)[b]];return'row'===a?this.rows[Object.keys(this.rows)[b]]:void 0},_hideTooltip:function(a){var b=a.detail.target,c=b.parentElement.querySelector('div');c.scrollWidth<=c.clientWidth&&''!=b.for&&b._hide()},_hideColHeaderChanged:function(a,b){a!==void 0&&a!==b&&(!1===a?this.disabledHeader='':this.disabledHeader='disable-col-header'),a===void 0||!1!==a||a===b||!this.cols||this.cols.length&&Object.keys(this.cols)[0]||(this.set('hideColHeader',void 0),this.set('hideColHeader',!0))},_sortCol:function(a){var b,c,d,e,f,g,h,k=a.model.index,l=0,m=this;if(this.sortColOrder&&this.sortColOrder.index===k&&2!==this.sortColOrder.order&&(l=++this.sortColOrder.order),this.sortColOrder={index:k,order:l},2>l){b=[],g=this.heatmapData[k].length;for(var n,o=0;o<g;o++)n=this.heatmapData[k][o],b.push({index:o,value:n?'number'===typeof n.value?n.value:-Infinity:-Infinity});b.sort(function(c,a){return l?a.value-c.value:c.value-a.value})}else if(b=[],this.rows&&this.rows.length&&Object.keys(this.rows)[0]){g=this.initialRowsOrder.length;for(var p,o=0;o<g;o++)p=this.initialRowsOrder[o],b.push({index:Object.keys(m.rows).indexOf(p.value)})}else{g=this.heatmapData[0].length,f=[];for(var o=0;o<g;o++)f.push(this.heatmapData[0][o].value);g=this.initialRowsOrder.length;for(var p,o=0;o<g;o++)p=this.initialRowsOrder[o],b.push({index:f.indexOf(p.value)})}g=this.heatmapData.length,h=b.length,c=[];for(var q,o=0;o<g;o++){q=[];for(var r=0;r<h;r++)q.push(this.heatmapData[o][b[r].index]);c.push(q)}if(d=this.rows,e=[],g=b.length,d.length){for(var o=0;o<g;o++)e[Object.keys(d)[b[o].index]]=d[Object.keys(d)[b[o].index]];e.length=Object.keys(e).length}this.set('heatmapData',[]),this.set('rows',[]),this.set('heatmapData',c),this.set('rows',e)},_sortRow:function(a){var b,c,d,e,f,g,h,j=a.model.index,k=0,l=this;if(this.sortRowOrder&&this.sortRowOrder.index===j&&2!==this.sortRowOrder.order&&(k=++this.sortRowOrder.order),this.sortRowOrder={index:j,order:k},2>k){h=this.heatmapData.length,b=[];for(var m,n=0;n<h;n++)m=this.heatmapData[n][j],b.push({index:n,value:m?'number'===typeof m.value?m.value:-Infinity:-Infinity});b.sort(function(c,a){return k?a.value-c.value:c.value-a.value})}else if(b=[],this.cols&&this.cols.length&&Object.keys(this.cols)[0]){h=this.initialColsOrder.length;for(var o,n=0;n<h;n++)o=this.initialColsOrder[n],b.push({index:Object.keys(l.cols).indexOf(o.value)})}else{h=this.heatmapData.length,g=[];for(var n=0;n<h;n++)g.push(this.heatmapData[n][0].value);h=this.initialColsOrder.length;for(var o,n=0;n<h;n++)o=this.initialColsOrder[n],b.push({index:g.indexOf(o.value)})}c=this.heatmapData,h=b.length,d=[];for(var n=0;n<h;n++)d.push(c[b[n].index]);if(e=this.cols,f=[],e.length){h=b.length;for(var n=0;n<h;n++)f[Object.keys(e)[b[n].index]]=e[Object.keys(e)[b[n].index]];f.length=Object.keys(f).length}this.set('cols',[]),this.set('heatmapData',[]),this.set('cols',f),this.set('heatmapData',d)},_sortingIcon:function(a,b,c){var d=!0;return this.sortColOrder&&'col'===b.toLowerCase()&&this.sortColOrder.index===a?'up'===c.toLowerCase()&&0===this.sortColOrder.order?d=!1:'down'===c.toLowerCase()&&1===this.sortColOrder.order&&(d=!1):this.sortRowOrder&&'row'===b.toLowerCase()&&this.sortRowOrder.index===a&&('up'===c.toLowerCase()&&0===this.sortRowOrder.order?d=!1:'down'===c.toLowerCase()&&1===this.sortRowOrder.order&&(d=!1)),d},_calculateAggregation:function(a,b){var d=Math.sqrt,c=Math.pow;if(this.aggregationType&&null!=this.aggregationType&&a&&a!==b&&this.availableAggregations&&-1!==this.availableAggregations.indexOf(a.toUpperCase())&&0<this.heatmapData.length){this.set('showAggregation',!0);var e=[],f=[],g=[],h=[],j=[];switch(g=this.heatmapData.map(function(a){return a.map(function(a){return a.value})}),h=g.map(function(a){return a.map(function(b){if(b&&'number'===typeof b){var c=(b+'').split('.');return c=c[1]?c[1].length:0,c}return 0}).reduce(function(c,a,b){return 0===b?a:c>a?a:c})}),j=g[0].map(function(a,b){return g.map(function(c){if(c[b]&&'number'===typeof c[b]){var a=(c[b]+'').split('.');return a=a[1]?a[1].length:0,a}return 0}).reduce(function(c,a,b){return 0===b?a:c>a?a:c})}),this.set('rowAggregatedData',[]),this.set('colAggregatedData',[]),a.toUpperCase()){case'SUM':e=g[0].map(function(a,c){return g.reduce(function(d,a){return d+(a[c]&&'number'===typeof a[c]?a[c]:0)},0)}),f=g.map(function(a){return a.reduce(function(c,a){return c+(a&&'number'===typeof a?a:0)},0)});break;case'AVERAGE':e=g[0].map(function(a,c){return g.reduce(function(d,a){return d+(a[c]&&'number'===typeof a[c]?a[c]:0)},0)/g.reduce(function(d,a){return d+(a[c]&&'number'===typeof a[c]?1:0)},0)}),f=g.map(function(a,b){return a.reduce(function(c,a){return c+(a&&'number'===typeof a?a:0)},0)/g[b].reduce(function(c,a){return c+(a&&'number'===typeof a?1:0)},0)});break;case'STD':e=g[0].map(function(a,c){return g.reduce(function(d,a){return d+(a[c]&&'number'===typeof a[c]?a[c]:0)},0)/g.reduce(function(d,a){return d+(a[c]&&'number'===typeof a[c]?1:0)},0)}),e=g[0].map(function(a,f){return d(g.reduce(function(d,a){return d+(a[f]&&'number'===typeof a[f]?c(a[f]-e[f],2):0)},0)/g.reduce(function(c,a){return c+(a[f]&&'number'===typeof a[f]?1:0)},0))}),f=g.map(function(a,b){return a.reduce(function(c,a){return c+(a&&'number'===typeof a?a:0)},0)/g[b].reduce(function(c,a){return c+(a&&'number'===typeof a?1:0)},0)}),f=g.map(function(a,e){return d(a.reduce(function(d,a){return d+(a&&'number'===typeof a?c(a-f[e],2):0)},0)/g[e].reduce(function(c,a){return c+(a&&'number'===typeof a?1:0)},0))});break;case'MAX':e=g[0].map(function(a,c){return g.reduce(function(d,a){return'number'===typeof a[c]?d>a[c]?d:a[c]:d},-Infinity)}),f=g.map(function(a){return a.reduce(function(c,a){return'number'===typeof a?c>a?c:a:c},-Infinity)});break;case'MIN':e=g[0].map(function(a,c){return g.reduce(function(d,a){return'number'===typeof a[c]?d<a[c]?d:a[c]:d},Infinity)}),f=g.map(function(a){return a.reduce(function(c,a){return'number'===typeof a?c<a?c:a:c},Infinity)});break;default:e=g[0].map(function(a,c){return g.reduce(function(d,a){return d+(a[c]&&'number'===typeof a[c]?1:0)},0)}),f=g.map(function(a,b){return g[b].reduce(function(c,a){return c+(a&&'number'===typeof a?1:0)},0)});}f=f.map(function(a,b){return(a+'').substr(0,(a+'').split('.')[0].length+2+h[b])}),e=e.map(function(a,b){return(a+'').substr(0,(a+'').split('.')[0].length+2+j[b])}),this.set('rowAggregatedData',e),this.set('colAggregatedData',f)}else this.aggregationType&&b&&a&&b!==a&&-1===this.availableAggregations.indexOf(a.toUpperCase())&&(this.set('aggregationType',''),this.set('showAggregation',!1))},_getColAggregation:function(a){return this.colAggregatedData?this.colAggregatedData[a]:''},_scaleColorFromChanged:function(a,b){a&&a!==b&&this._configChanged(this.config,{})},_scaleColorToChanged:function(a,b){a&&a!==b&&this._configChanged(this.config,{})},_hideRowHeaderChanged:function(a,b){this;a===void 0||!1!==a||a===b||!this.rows||this.rows.length&&Object.keys(this.rows)[0]?!a&&b&&(this.hideRowHeader=!1):this.hideRowHeader=!0},_showAggregationChanged:function(a,b){a!==void 0&&a!=b&&(this.set('showRowAggregation',a),this.set('showColAggregation',!1),this.heatmapData[0]&&1<this.heatmapData[0].length&&this.set('showColAggregation',a))}});</script></body></html>