L.TileLayer.Bing=L.TileLayer.extend({options:{bingMapsKey:null,imagerySet:'Aerial',culture:'en-US',minZoom:1,noAttribution:!1},statics:{METADATA_URL:'https://dev.virtualearth.net/REST/v1/Imagery/Metadata/{imagerySet}?key={bingMapsKey}&include=ImageryProviders&uriScheme=https',POINT_METADATA_URL:'https://dev.virtualearth.net/REST/v1/Imagery/Metadata/{imagerySet}/{lat},{lng}?zl={z}&key={bingMapsKey}&uriScheme=https'},VALID_IMAGERY_SETS:['Aerial','AerialWithLabels','Road'],initialize:function(a){if('string'===typeof a&&(a={bingMapsKey:a}),a&&a.BingMapsKey&&(a.bingMapsKey=a.BingMapsKey,console.warn('use options.bingMapsKey instead of options.BingMapsKey')),!a||!a.bingMapsKey)throw new Error('Must supply options.BingMapsKey');if(a=L.setOptions(this,a),-1===this.VALID_IMAGERY_SETS.indexOf(a.imagerySet))throw new Error('\''+a.imagerySet+'\' is an invalid imagerySet');a.minZoom=Math.max(1,a.minZoom),this._initMeta(),L.Browser.android||this.on('tileunload',this._onTileRemove)},setKey:function(a){a&&this.options.bingMapsKey!==a&&(this.options.bingMapsKey=a,this._initMeta().then(function(){this.redraw()}.bind(this)))},setImagery:function(a){if(!a||-1===this.VALID_IMAGERY_SETS.indexOf(a))throw new Error('\''+a+'\' is an invalid imagerySet');this.options.imagerySet!==a&&(this.options.imagerySet=a,this._removeAllAttributions(),this._initMeta().then(function(){this.redraw(),this._updateAttribution()}.bind(this)))},setCulture:function(a){a&&this.options.culture!==a&&(this.options.culture=a,this.redraw())},enableAttribution:function(){this.options.noAttribution&&(this.options.noAttribution=!1,this._updateAttribution())},disableAttribution:function(){this.options.noAttribution||(this.options.noAttribution=!0,this._removeAllAttributions())},getMetaData:function(a,b){if(!this._map&&(!a||!b))return Promise.reject(new Error('If layer is not attached to map, you must provide LatLng and zoom'));a=a||this._map.getCenter(),b=b||this._map.getZoom();var c=L.Util.template(L.TileLayer.Bing.POINT_METADATA_URL,{bingMapsKey:this.options.bingMapsKey,imagerySet:this.options.imagerySet,z:b,lat:a.lat,lng:a.lng});return fetch(c).then(function(a){return a.json()}).catch(console.error.bind(console))},createTile:function(a,b){var c=document.createElement('img');return L.DomEvent.on(c,'load',L.bind(this._tileOnLoad,this,b,c)),L.DomEvent.on(c,'error',L.bind(this._tileOnError,this,b,c)),this.options.crossOrigin&&(c.crossOrigin=''),c.alt='',this._url?c.src=this.getTileUrl(a):this._initMeta().then(function(){c.src=this.getTileUrl(a)}.bind(this)).catch(function(a){console.error(a),b(a)}),c},getTileUrl:function(a){var b=this._toQuadKey(a.x,a.y,a.z);return L.Util.template(this._url,{quadkey:b,subdomain:this._getSubdomain(a),culture:this.options.culture})},onAdd:function(a){a.on('moveend',this._updateAttribution,this),L.TileLayer.prototype.onAdd.call(this,a),this._updateAttribution()},onRemove:function(a){a.off('moveend',this._updateAttribution,this),this._removeAllAttributions(a),L.TileLayer.prototype.onRemove.call(this,a)},_initMeta:function(){var a;if(this._fetchingMeta&&this._fetch)a=this._fetch;else{var b=this._startMetadataFetch.bind(this);a=this._fetch=b()}return a},_startMetadataFetch:function(){this._fetchingMeta=!0,this._url=null,this._imageryProviders=[],this._attributions=[];var a=L.Util.template(L.TileLayer.Bing.METADATA_URL,{bingMapsKey:this.options.bingMapsKey,imagerySet:this.options.imagerySet});return fetch(a).then(function(a){return a.json()}).then(this._handleMetadataLoaded.bind(this)).then(function(){this._fetchingMeta=!1}.bind(this)).catch(console.error.bind(console))},_handleMetadataLoaded:function(a){if(200!==a.statusCode)throw new Error('Bing Imagery Metadata error: \n'+JSON.stringify(a,null,'  '));var b=a.resourceSets[0].resources[0];return this._url=b.imageUrl,this._imageryProviders=this._reduceProviders(b.imageryProviders),this.options.subdomains=b.imageUrlSubdomains,this._updateAttribution(),Promise.resolve()},_reduceProviders:function(b){var c,d,e,f,g,a,h={providers:[],areas:[]};for(e=0,f=b.length;e<f;e++)for(c=b[e],h.providers.push(c),(g=0,a=c.coverageAreas.length);g<a;g++)d={provider:c,bounds:L.latLngBounds([c.coverageAreas[g].bbox[0],c.coverageAreas[g].bbox[1]],[c.coverageAreas[g].bbox[2],c.coverageAreas[g].bbox[3]]),zoomMin:c.coverageAreas[g].zoomMin,zoomMax:c.coverageAreas[g].zoomMax},h.areas.push(d);return h},_updateAttribution:function(){var a=this._map;if(a&&a.attributionControl){var b=a.getZoom(),c=a.getBounds();this._fetchingMeta?this._initMeta().then(this._addAndRemoveAttributions.bind(this,a,c,b)):this._addAndRemoveAttributions(a,c,b)}},_addAndRemoveAttributions:function(a,b,c){var d,e,f=this._getAttributions(b,c),g=this._attributions;for(d=0,e=f.length;d<e;d++)-1===g.indexOf(f[d])&&a.attributionControl.addAttribution(f[d]);for(d=0,e=g.length;d<e;d++)-1===f.indexOf(g[d])&&a.attributionControl.removeAttribution(g[d]);this._attributions=f},_getAttributions:function(a,b){if(this.options.noAttribution||'object'!==babelHelpers.typeof(this._imageryProviders)||!Array.isArray(this._imageryProviders.areas)||!a||!a.isValid()||!b)return[];for(var c=[],d=0,e=this._imageryProviders.areas.length;d<e;d++)(this._imageryProviders.areas[d].bounds||this._imageryProviders.areas[d].bounds.isValid())&&-1===c.indexOf(this._imageryProviders.areas[d].provider.attribution)&&this._imageryProviders.areas[d].bounds.intersects(a)&&b>=this._imageryProviders.areas[d].zoomMin&&b<=this._imageryProviders.areas[d].zoomMax&&c.push(this._imageryProviders.areas[d].provider.attribution);return c},_removeAllAttributions:function(a){if(a=a||this._map,a&&Array.isArray(this._attributions)&&this._attributions.length){for(var b=0,c=this._attributions.length;b<c;b++)a.attributionControl.removeAttribution(this._attributions[b]);this._attributions=[]}},_toQuadKey:function(a,c,d){for(var e='',f=d;0<f;f--){var g=0,b=1<<f-1;0!==(a&b)&&g++,0!==(c&b)&&(g+=2),e+=g.toString()}return e}}),L.tileLayer.bing=function(a){return new L.TileLayer.Bing(a)};