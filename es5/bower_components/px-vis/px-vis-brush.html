<html><head><link rel="import" href="../polymer/polymer.html"><link rel="import" href="px-vis-behavior-common.html"><link rel="import" href="px-vis-behavior-d3.html"><link rel="import" href="css/px-vis-styles.html"></head><body><dom-module id="px-vis-brush"><template><style include="px-vis-styles"></style></template></dom-module><script>Polymer({is:'px-vis-brush',behaviors:[PxVisBehavior.observerCheck,PxVisBehavior.sizing,PxVisBehaviorD3.svg,PxVisBehaviorD3.axis,PxVisBehaviorD3.selectedDomain,PxVisBehavior.commonMethods,PxVisBehaviorD3.domainUpdate,PxVisBehavior.updateStylesOverride],properties:{_brush:{type:Object,value:function(){return{}}},_brushGroup:{type:Object,value:function(){return{}}},_handleGroup:{type:Object,value:function(){return{}}},_center:{type:Object,value:function(){return{}}},_centering:{type:Boolean,value:!1},_brushing:{type:Boolean,value:!1},chartDomain:{type:Object,notify:!0},gradientOverlay:{type:Boolean,value:!1},_preventDomainChange:{type:Boolean,value:!1},_animationFrameDone:{type:Boolean,value:!1},_clipPathId:{type:String}},observers:['drawElement(domainChanged, svg, axis, height, selectedDomain, _animationFrameDone, _stylesUpdated)','_zoomBrush(chartDomain.*)'],detached:function(){this.unlisten(window,'mouseup','_brushMouseUp')},ready:function(){window.requestAnimationFrame(function(){this.set('_animationFrameDone',!0)}.bind(this)),this.set('_clipPathId',this.generateRandomID('navClipPath'))},drawElement:function(){if(!this.hasUndefinedArguments(arguments)&&this._animationFrameDone&&null!==this.domainChanged&&this.height){var a,b=5,c=Math.max(this.height-this.margin.bottom-b,1),d=this.axis.range();if(d[0]>d[1]?(d[0]=this.axis.range()[1],d[1]=this.axis.range()[0]):d[0]===d[1]&&(d[1]+=1),a=[[d[0],0],[d[1],c]],this._isObjEmpty(this._brush)){this._createClipPath([0,c]),this._brush=Px.d3.brushX().extent(a).handleSize(6).on('start',this._brushstart.bind(this)).on('brush',this._brushmove.bind(this)).on('end',this._brushend.bind(this)),this._preventDomainChange=!0,this._brushGroup=this.svg.append('g').attr('class','brush').call(this._brush).call(this._brush.move,d);var e=this._brushGroup.select('rect.selection').attr('y',0).attr('stroke',this._checkThemeVariable('--px-vis-nav-brush-outline-color','rgb(0,0,0)')).attr('stroke-width',1).attr('shape-rendering','crispEdges').attr('clip-path','url(#'+this._clipPathId+')');if(this.gradientOverlay){var f=this.svg.append('defs').append('linearGradient').attr('id','overlayGradient');f.append('stop').attr('offset','0%').attr('stop-color',this._checkThemeVariable('--px-vis-nav-brush-gradient-fill-color','rgb(0,0,0)')).attr('stop-opacity',this._checkThemeVariable('--px-vis-nav-brush-gradient-opacity-1',0.2)),f.append('stop').attr('offset','100%').attr('stop-color',this._checkThemeVariable('--px-vis-nav-brush-gradient-fill-color','rgb(0,0,0)')).attr('stop-opacity',this._checkThemeVariable('--px-vis-nav-brush-gradient-opacity-2',0.8)),e.attr('fill','url(#overlayGradient)').attr('fill-opacity','1.0')}else e.attr('fill',this._checkThemeVariable('--px-vis-nav-brush-fill-color','rgb(0,0,0)')).attr('fill-opacity',this._checkThemeVariable('--px-vis-nav-brush-opacity',0.3));this._drawHandles(b),this._brushGroup.select('rect.overlay').on('mousedown.brush',this._brushcenter.bind(this)).on('touchstart.brush',this._brushcenter.bind(this))}else this._drawClipPath([0,c]),this._brush=this._brush.extent(a),this._brushGroup=this.svg.select('g.brush').call(this._brush),this.selectedDomain&&0<this.selectedDomain.x.length?this._brushGroup.call(this._brush.move,[this.axis(this.selectedDomain.x[0]),this.axis(this.selectedDomain.x[1])]):this._brushGroup.call(this._brush.move,d)}},_createClipPath:function(a){this._clipPathObj=this.svg.append('clipPath').attr('id',this._clipPathId),this._clipPathObj.append('path'),this._drawClipPath(a)},_drawClipPath:function(a){var b=this.axis.range(),c=this.axis.domain(),e=this.selectedDomain.x[0]<c[0],f=this.selectedDomain.x[1]>c[1],g='';a[0]-=5,a[1]+=5,b[0]-=5,b[1]+=5;var d=(a[1]+a[0])/2,h=10,i=5;g='M'+b[0]+','+a[0]+'L'+b[1]+','+a[0],f&&(g+='L'+b[1]+','+(d-h)+'L'+(b[1]-10)+','+(d-i)+'L'+(b[1]+10)+','+(d+i)+'L'+b[1]+','+(d+h)),g+='L'+b[1]+','+a[1]+'L'+b[0]+','+a[1],e&&(g+='L'+b[0]+','+(d+h)+'L'+(b[0]+10)+','+(d+i)+'L'+(b[0]-10)+','+(d-i)+'L'+b[0]+','+(d-h)),g+='Z',this._clipPathObj.select('path').attr('d',g)},_brushstart:function(){this.set('_brushing',!0),this.svg.classed('selecting',!0)},_brushend:function(){this.set('_brushing',!1),this._doesObjHaveValues(this._handleGroup)&&this._handleGroup.dispatch('brushmouseup'),this.svg.classed('selecting',!1)},_brushmove:function(){this.debounce('brushed',function(){var a=Px.d3.brushSelection(this._brushGroup.node());if(a)if(1>Math.abs(a[0]-a[1]))a[0]=0===a[0]?0:a[1]-1,a[1]=0===a[1]?a[0]+1:a[1],this._brushGroup.call(this._brush.move,a);else if(!this._preventDomainChange){var b=a.map(this.axis.invert,this.axis),c=2>this.selectedDomain.x.length||b[0].toString()!==this.selectedDomain.x[0].toString()||b[1].toString()!==this.selectedDomain.x[1].toString();c&&(this.set('selectedDomain',{x:b,y:[]}),this.fire('px-vis-selected-domain-updated',{data:{x:b,y:[]},method:'set',dataVar:'selectedDomain'}))}else this._preventDomainChange=!1},10)},_brushcenter:function(){var a=Px.d3.select(window),b=Px.d3.event.target,c=Px.d3.brushSelection(this._brushGroup.node()),d=c[1]-c[0],e=this.axis.range(),f=e[0]+d/2,g=e[1]-d/2;this._recenter(!0),this._brushcentermove(b,f,g),Px.d3.event.changedTouches?a.on('touchmove.brush',this._brushcentermove.bind(this,b,f,g)).on('touchend.brush',this._brushcenterend.bind(this)):a.on('mousemove.brush',this._brushcentermove.bind(this,b,f,g)).on('mouseup.brush',this._brushcenterend.bind(this))},_brushcentermove:function(a,b,c){Px.d3.event.stopPropagation(),this._center=Math.max(b,Math.min(c,Px.d3.mouse(a)[0])),this._recenter(!1)},_brushcenterend:function(){this._brushmove(),Px.d3.select(window).on('.brush',null)},_recenter:function(a){var b=this;if(!this._centering){if(!a)return void b.tween(1);this._centering=!0;var c=Px.d3.timer(function(){b.tween(0.2),b._centering||c.stop()})}},tween:function(a){var b=Px.d3.brushSelection(this._brushGroup.node()),c=b[1]-b[0],d=this._center*a+(b[0]+b[1])/2*(1-a);this._brushGroup.call(this._brush.move,[d-c/2,d+c/2]),this._centering=Math.abs(d-this._center)>0.01*c},_drawHandles:function(){this._handleGroup=this._brushGroup.selectAll('.handle').on('brushmouseup',this._handleGroupMouseUp.bind(this)).on('mousedown.handle',this._handleGroupMouseDown.bind(this)).on('mouseenter.handle',this._handleGroupMouseEnter.bind(this)).on('mouseleave.handle',this._handleGroupMouseLeave.bind(this)),this._handleGroup.attr('clip-path','url(#'+this._clipPathId+')').attr('stroke',this._checkThemeVariable('--px-vis-nav-brush-handle-lines-color','rgb(0,0,0)')).attr('fill',this._checkThemeVariable('--px-vis-nav-brush-handle-fill-color','rgb(255,255,255)')).attr('shape-rendering','crispEdges')},_handleGroupMouseDown:function(a,b){var c=Px.d3.select(this._handleGroup.nodes()[b]);c.on('mouseleave.handle',null),c.attr('stroke',this._checkThemeVariable('--px-vis-nav-brush-handle-lines-color-press','rgb(0,0,0)')).attr('fill',this._checkThemeVariable('--px-vis-nav-brush-handle-fill-color-press','rgb(50,50,50)'))},_handleGroupMouseUp:function(a,b){var c=Px.d3.select(this._handleGroup.nodes()[b]);c.on('mouseleave.handle',this._handleGroupMouseLeave.bind(this,a,b)),c.attr('stroke',this._checkThemeVariable('--px-vis-nav-brush-handle-lines-color','rgb(0,0,0)')).attr('fill',this._checkThemeVariable('--px-vis-nav-brush-handle-fill-color','rgb(255,255,255)'))},_handleGroupMouseLeave:function(a,b){var c=Px.d3.select(this._handleGroup.nodes()[b]);c.attr('stroke',this._checkThemeVariable('--px-vis-nav-brush-handle-lines-color','rgb(0,0,0)')).attr('fill',this._checkThemeVariable('--px-vis-nav-brush-handle-fill-color','rgb(255,255,255)'))},_handleGroupMouseEnter:function(a,b){var c=Px.d3.select(this._handleGroup.nodes()[b]);c.attr('stroke',this._checkThemeVariable('--px-vis-nav-brush-handle-lines-color-hover','rgb(0,0,0)')).attr('fill',this._checkThemeVariable('--px-vis-nav-brush-handle-fill-color-hover','rgb(150,150,150)'))},_zoomBrush:function(){if(!this.hasUndefinedArguments(arguments)&&!this._brushing&&!this._centering&&0<this.chartDomain.length&&this._doesObjHaveValues(this._brush)&&this._doesObjHaveValues(this._brushGroup)&&this._doesObjHaveValues(this.axis)&&Px.d3.brushSelection(this._brushGroup.node())){var a=Px.d3.brushSelection(this._brushGroup.node()),b=[this.axis(this.chartDomain[0]),this.axis(this.chartDomain[1])];a[0]===b[0]&&a[1]===b[1]||(this._preventDomainChange=!0,this._brushGroup.call(this._brush.move,b))}}});</script></body></html>