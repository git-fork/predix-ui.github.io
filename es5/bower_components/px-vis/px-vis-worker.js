var dataMapping={},quadtrees={};quadtreeBuilt=!1;function reply(a){postMessage({data:a})}function updateData(a){dataMapping[a.chartId]=a.data.chartData,reply(null)}function deleteData(a){delete dataMapping[a.chartId],delete quadtrees[a.chartId],reply(null)}function recreateD3Scale(a){var b;return b='time'===a.type?d3.scaleUtc().nice().range(a.range).domain(a.domain):'timeLocal'===a.type?d3.scaleTime().nice().range(a.range).domain(a.domain):'linear'===a.type?d3.scaleLinear().nice().range(a.range).domain(a.domain):'log'===a.type?d3.scaleLog().nice().base(a.logBase).range(a.range).domain(a.domain):'scaleBand'===a.type?d3.scaleBand().range(a.range).domain(a.domain).round(!0).paddingInner(0.5):d3.scalePoint().range(a.range).domain(a.domain).padding(0.5),b}function getMultiScale(a){for(var b,c,d={},e=0;e<a.keys.length;e++)b=a.keys[e],c=a.isMultiY?a.completeSeriesConfig[b].axis.id:'defaultAxis',d[c]||(d[c]=recreateD3Scale(a.y[c]));return d}function createDataStub(){return{time:null,timeSeriesKey:null,series:[],rawData:[],timeStamps:[],timeStampsTracker:{},additionalPoints:[]}}function flattenData(a,b,c,d,e,f){for(var g=0;g<a.keys.length;g++)if(!(a.hardMute&&a.mutedSeries[a.keys[g]])){var h={},i=a.keys[g],j=a.completeSeriesConfig[i].axis?a.completeSeriesConfig[i].axis.id:'default';if(h.i=e,h.k=i,a.radial){var k=calcPixelCoordForRadial(b[a.completeSeriesConfig[i].x],b[a.completeSeriesConfig[i].y],j,a);h.px=~~k[0],h.py=~~k[1]}else h.px=~~c(b[a.completeSeriesConfig[i].x],j),h.py=~~d(b[a.completeSeriesConfig[i].y],j);f.push(h)}return f}function buildQuadtreeHelperObj(a,b,c){var e={},f=a.completeSeriesConfig[b].axis?a.completeSeriesConfig[b].axis.id:null;if(e.xKey=a.completeSeriesConfig[b].x,e.yKey=a.completeSeriesConfig[b].y,a.radial){var g=function(b){return calcPixelCoordForRadial(b[e.xKey],b[e.yKey],f,a)};e.xScale=function(a){return g(a)[0]},e.yScale=function(a){return g(a)[1]},e.yScale.index=c}else e.yScale=recreateD3Scale(a.y[f]),e.yScale.index=c,e.xScale=recreateD3Scale(a.x);return e}function adjustAngleForPolarChart(a,b,c){var d=Math.PI,e=b?180:d;return(!c.counterClockwise&&!b||c.counterClockwise&&b)&&(a*=-1),c.useDegrees?b?a+e:2*(a/360)*d+e:b?360*(a/(2*d))+e:a+e}function calcPixelCoordForRadial(a,b,c,d){var e=d.y[c].range[1]-d.y[c].range[0],f=d.y[c].domain[1]-d.y[c].domain[0],g=e*(b-d.y[c].domain[0])/f;return a=adjustAngleForPolarChart(a,!1,d),[Math.sin(a)*g,Math.cos(a)*g]}function calcXScale(a){if(!a.radial){var b=recreateD3Scale(a.x);return function(a){return b(a)}}}function calcYScale(a){if(!a.radial){var b=getMultiScale(a);return function(a,c){return b[c](a)}}}function createSingleQuadtree(a){var b,c=a.data,d=dataMapping[a.chartId],e=calcXScale(c),f=calcYScale(c);if(d){b=d3.quadtree().extent(c.extents).x(function(a){return a.px}).y(function(a){return a.py});for(var g=[],h=0;h<d.length;h++)flattenData(c,d[h],e,f,h,g);return b.addAll(g),b}return null}function createSeriesQuadtree(a){var b,c=a.data,d=dataMapping[a.chartId],e={},f=function(a){return c.radial?this.xScale(a):this.xScale(a[this.xKey])},g=function(a){return c.radial?this.yScale(a):this.yScale(a[this.yKey])};if(d){for(var h=0;h<c.keys.length;h++)if(b=c.keys[h],!(c.hardMute&&c.mutedSeries[b])){var i=buildQuadtreeHelperObj(c,b,h);e[b]=d3.quadtree().extent(c.extents).x(f.bind(i)).y(g.bind(i)).addAll(d)}return e}return null}function createQuadtree(a){quadtreeBuilt=!1,quadtrees[a.chartId]='pointPerSeries'===a.data.searchType?createSeriesQuadtree(a):createSingleQuadtree(a),quadtreeBuilt=!0,reply(null,null)}function _getPixelSpaceVal(a,b,c,d){return d?b[d](a[c]):b(a[c])}function calcValueQuadtree(a,b,c){var d={};return d[b]=a[b],d[c]=a[c],d}function calcCoordQuadtree(b,c,d,e,f,g,h){var i=[];return g.radial?i=calcPixelCoordForRadial(b[c],b[d],h,g):(i[0]=e(b[c]),i[1]=f(b[d])),i}function calcDataSeriesQuadtree(a,b,c,d,e,f){var g=e.completeSeriesConfig[b].x,h=e.completeSeriesConfig[b].y;return{coord:calcCoordQuadtree(a,g,h,c,d,e,f),name:b,value:calcValueQuadtree(a,g,h)}}function calcClosestPoint(a,b,c,d){var e=c.coord[0],f=c.coord[1],g=(e-=a[0])*e+(f-=a[1])*f;return!b||b.dist>g?{dist:g,time:d,key:c.name}:b}function calcDataSingleQuadtree(a,b,c){var d=c.completeSeriesConfig[b].x,e=c.completeSeriesConfig[b].y,f=c.completeSeriesConfig[b].axis?c.completeSeriesConfig[b].axis.id:'default',g=calcValueQuadtree(a,d,e);return{coord:c.radial?calcPixelCoordForRadial(g[d],g[e],f,c):[c.xScale(g[d]),c.yScale[f](g[e])],name:b,value:g}}function addCrosshairDataQuadtree(a,b,c){return c&&!a.timeStampsTracker[b[c]]?(a.rawData.push(b),a.timeStamps.push(b[c]),a.timeStampsTracker[b[c]]=!0):!c&&a.rawData.push(b),a}function constructDataObj(a,b,c,d,e,f){if(!a||d.hardMute&&d.mutedSeries[c]||'point'===d.searchFor&&a.k!==c&&'pointPerSeries'!==d.searchType)b.series.push(emptySeries(c));else if(e){var g=this.dataMapping[d.chartId][a.i];b.series.push(calcDataSingleQuadtree(g,c,d)),d.calcCrosshair&&'allInArea'!==d.searchType&&(b=addCrosshairDataQuadtree(b,g,d.timeData))}else{var h=d.completeSeriesConfig[c].axis.id,i=recreateD3Scale(d.y[h]),j=calcDataSeriesQuadtree(a,c,f,i,d,h);b.series.push(j),d.timeData&&(b.closest=calcClosestPoint(d.mousePos,b.closest,j,a[d.timeData])),d.calcCrosshair&&(b=addCrosshairDataQuadtree(b,a,d.timeData))}return b}function calcBoxSize(a){var b=a.mousePos[0]-a.radius,c=a.mousePos[0]+a.radius,d=a.mousePos[1]-a.radius,e=a.mousePos[1]+a.radius;return{x0:b,x1:c,y0:d,y1:e}}function calcPolygonExtents(a){var b=d3.extent(a,function(a){return a[0]}),c=d3.extent(a,function(a){return a[1]});return{x0:b[0],x1:b[1],y0:c[0],y1:c[1]}}function searchPolygonQuadtree(a,b,c){var e=calcPolygonExtents(a.polygon),f=0,g=0;return a.polygon.length&&c.visit(function(c,h,i,j,k){if(!c.length){do{var l=c.data;f++,d3.polygonContains(a.polygon,[l.px,l.py])&&(b=addCrosshairDataQuadtree(b,this.dataMapping[a.chartId][c.data.i],a.timeData),g++)}while(c=c.next);return!0}return h>=e.x1||i>=e.y1||j<e.x0||k<e.y0}),b}function searchAreaBoxQuadtree(a,b,c){var e=calcBoxSize(b);return a.visit(function(a,f,g,h,i){if(!a.length)do{var j=a.data;j.px>=e.x0&&j.px<e.x1&&j.py>=e.y0&&j.py<e.y1&&(c=addCrosshairDataQuadtree(c,j.data,b.timeData))}while(a=a.next);return f>=e.x1||g>=e.y1||h<e.x0||i<e.y0}),c}function searchAreaRadiusQuadtree(a,b,c){var d=b.radius*b.radius,e=calcBoxSize(b);return a.visit(function(a,f,g,h,i){var j=Math.pow;if(!a.length)do b.hardMute&&b.mutedSeries[a.data.k]||!(j(a.data.px-b.mousePos[0],2)+j(a.data.py-b.mousePos[1],2)<=d)||(c=addCrosshairDataQuadtree(c,this.dataMapping[b.chartId][a.data.i],b.timeData));while(a=a.next);return f>=e.x1||g>=e.y1||h<e.x0||i<e.y0}),c}function searchAreaQuadtree(a,b,c){return b.radius?searchAreaRadiusQuadtree(a,b,c):searchAreaBoxQuadtree(a,b,c)}function buildQtSingleDataObj(a,b,c){for(var d=0;d<a.keys.length;d++)b=constructDataObj(c,b,a.keys[d],a,!0,null);return c&&(b.time=dataMapping[a.chartId][c.i][a.timeData],b.timeSeriesKey='point'===a.searchFor?c.k:''),b}function findAllAtPoint(a,b){var c=[];return a.visit(function(a,e,f,g,h){if(!a.length)do{var i=a.data;i.px===b.px&&i.py===b.py&&c.push(i)}while(a=a.next);return e>b.px||f>b.py||g<b.px||h<b.py}),c}function buildAdditionalPoints(a,b,c){var d,e=[],f={};f[c.i]=!0;for(var g=0;g<b.length;g++)(b[g].i!==c.i||b[g].k!==c.k)&&('point'!==a.searchFor&&f[b[g].i]||(d=createDataStub(),d=buildQtSingleDataObj(a,d,b[g]),f[b[g].i]=!0,e.push(d)));return e}function returnAllAtPoint(a,b,c,d){var e=findAllAtPoint(a,c,b);return 1<e.length&&(d.additionalPoints=buildAdditionalPoints(b,e,c)),d}function searchQuadtreeSingle(a,b,c){var d=a.radius?a.radius:Infinity,e=c.find(a.mousePos[0],a.mousePos[1],d);return b=buildQtSingleDataObj(a,b,e),e&&(b=returnAllAtPoint(c,a,e,b)),a.calcCrosshair&&'allInArea'===a.searchType&&(b=searchAreaRadiusQuadtree(c,a,b)),b}function searchQuadtreeSeries(a,b,c){for(var d,e,f=a.radius?a.radius:Infinity,g=a.radial?null:recreateD3Scale(a.x),h=0;h<a.keys.length;h++)e=a.keys[h],!c[e]||a.hardMute&&a.mutedSeries[e]||(d=c[e].find(a.mousePos[0],a.mousePos[1],f),b=constructDataObj(d,b,e,a,!1,g));return b.closest&&(b.time=b.closest.time,b.timeSeriesKey=b.closest.key,delete b.closest),b}function returnClosestsQuadtreePoints(a){var b=a.data,c=createDataStub(),d=quadtrees[a.chartId];d&&(b.chartId=a.chartId,b.xScale=recreateD3Scale(b.x),b.yScale=getMultiScale(b),c='pointPerSeries'===b.searchType?searchQuadtreeSeries(b,c,d):'lasso'===b.searchType?searchPolygonQuadtree(b,c,d):searchQuadtreeSingle(b,c,d)),delete c.timeStampsTracker,reply(c)}function returnQuadtreePointsInArea(a){var b=a.data,c=quadtrees[a.chartId],d=createDataStub();c&&(b.chartId=a.chartId,b.xScale=recreateD3Scale(b.x),b.yScale=getMultiScale(b),d=searchAreaBoxQuadtree(c,b,d)),reply(d)}function emptySeries(a){return{coord:[],name:a,value:{}}}function addCrosshairData(a,b){return this.timeData&&!a.timeStampsTracker[b[this.timeData]]?(a.rawData.push(b),a.timeStamps.push(b[this.timeData]),a.timeStampsTracker[b[this.timeData]]=!0):!this.timeData&&a.rawData.push(b),a}function determineExtents(a){var b=a.data,c=null;extentCalc.xAxisType=b.xAxisType,extentCalc.yAxisType=b.yAxisType,extentCalc.completeSeriesConfig=b.completeSeriesConfig,extentCalc.chartExtents=b.chartExtents,extentCalc.dataExtents=b.dataExtents,extentCalc.axes=b.axes,extentCalc.seriesToAxes=b.seriesToAxes,extentCalc.isYAxisObject=b.isYAxisObject,extentCalc.mutedSeries=b.mutedSeries,extentCalc.hardMute=b.hardMute,dataMapping[a.chartId]&&(c=extentCalc.determineExtents(dataMapping[a.chartId])),reply(c)}onmessage=function(a){switch(a.data.action){case'registerCustomScript':a.data.data.url&&importScripts(a.data.data.url),reply(null);break;case'runCustomFunction':var b,c,d=this[a.data.data.objectName];if(!d)throw'Couldn\'t run custom function '+a.data.data.functionName+' on custom Object '+a.data.data.objectName+' because the specified Object doesn\'t exist. Make sure you have loaded your custom script defining the custom object.';else if(b=d[a.data.data.functionName],b)c=b(a.data.data.data,a.data.chartId);else throw'Couldn\'t run custom function '+a.data.data.functionName+' on custom Object '+a.data.data.objectName+' because the specified function doesn\'t exist on the specified Object.';reply(c);break;case'updateData':updateData(a.data);break;case'createQuadtree':createQuadtree(a.data);break;case'findQuadtreePoints':quadtreeBuilt?returnClosestsQuadtreePoints(a.data):reply(null);break;case'findQuadtreePointsInArea':quadtreeBuilt?returnQuadtreePointsInArea(a.data):reply(null);break;case'returnQuadtreeData':quadtreeBuilt?reply(quadtrees[a.data.chartId]):reply(null);break;case'determineExtents':determineExtents(a.data);break;case'unregisterChart':deleteData(a.data);break;default:reply(null);}};