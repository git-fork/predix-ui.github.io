<html><head><link rel="import" href="../polymer/polymer.html"><link rel="import" href="px-vis-behavior-common.html"><link rel="import" href="px-vis-behavior-d3.html"><link rel="import" href="css/px-vis-styles.html"></head><body><dom-module id="px-vis-line-canvas"><template><style include="px-vis-styles"></style></template></dom-module><script>Polymer({is:'px-vis-line-canvas',behaviors:[PxVisBehaviorD3.canvasContext,PxVisBehaviorD3.lineShared,PxVisBehaviorD3.axes,PxVisBehavior.sizing,PxVisBehavior.dataset,PxVisBehavior.mutedSeries,PxVisBehavior.commonMethods,PxVisBehavior.completeSeriesConfig,PxVisBehavior.categories,PxVisBehaviorD3.selectedDomain,PxVisBehavior.serieToRedrawOnTop,PxVisBehaviorD3.domainUpdate,PxVisBehavior.preventInitialDrawing,PxVisBehavior.isAttached,PxVisBehavior.polarData,PxVisBehavior.rendererType,PxVisBehaviorD3.clipPathBoolean,PxVisBehavior.dynamicConfigProperties],properties:{mutedOpacity:{type:Number,value:0.3},_clipData:{type:Array},strokeWidth:{type:Number,value:1},_currentDrawingOptions:{type:Object,value:function(){return{}}}},observers:['_priorityChanged(priority)'],ready:function(){this._watchConfigProperty('priority',0)},attached:function(){this.fire('px-vis-renderer-register',{type:'line',renderMode:'canvas',rendererType:this.rendererType,priority:this.priority})},detached:function(){this.fire('px-vis-renderer-unregister',{renderMode:'canvas',rendererType:this.rendererType})},_priorityChanged:function(){this.fire('px-vis-renderer-update-target-props',{propertyName:'priority',propertyValue:this.priority,rendererType:this.rendererType})},initializeDrawingSession:function(){this.parallelCoordinates?this._defineMultiLine(!0):this.radialLine?this._defineRadialLine(!0,this.multiPath,this.counterClockwise,this.useDegrees):this._defineSingleLine(!0),this._currentDrawingOptions.mutedOpacity=this.completeSeriesConfig[this.seriesId].mutedOpacity||0===this.completeSeriesConfig[this.seriesId].mutedOpacity?this.completeSeriesConfig[this.seriesId].mutedOpacity:this.mutedOpacity,this._currentDrawingOptions.strokeWidth=this.strokeWidth,this._currentDrawingOptions.lastPointRenderedIndex=null,this._currentDrawingOptions.currentBatchStartIndex=0,this.gradientLine?this._currentDrawingOptions.getColorValue=function(a){var b=this._isSerieMuted(a)?this._currentDrawingOptions.mutedOpacity:this._opacityLine(a);return 0===b?null:this._canvasLineColor(a,b)}.bind(this):this.categoryKey&&(this._currentDrawingOptions.getColorValue=function(a){var b=this._isSerieMuted(a)?this._currentDrawingOptions.mutedOpacity:1;return 0===b?null:this._canvasLineColor(a,b)}.bind(this))},drawClipPath:function(){this.chartData&&0<this.chartData.length&&0<this.completeSeriesConfig[this.seriesId].x.length&&(this.radialLine?this._drawRadarClipPath():this._drawRectClipPath())},_drawRadarClipPath:function(){this._generateRadarClipData(),this.canvasContext.beginPath(),this.line(this._clipData[0]),this.line(this._clipData[1]),this.canvasContext.clip('evenodd')},_drawRectClipPath:function(){var a=Math.max;this.canvasContext.beginPath();var b=a(this.width-this.margin.left-this.margin.right,0),c=a(this.height-this.margin.top-this.margin.bottom,0);this.canvasContext.rect(0,0,b,c),this.canvasContext.clip()},_generateRadarClipData:function(){for(var a=[{},{}],b=0;b<this.completeSeriesConfig[this.seriesId].x.length;b++)a[0][this.completeSeriesConfig[this.seriesId].x[b]]=this.y.domain()[0],a[1][this.completeSeriesConfig[this.seriesId].x[b]]=this.y.domain()[1];this._clipData=a},renderOneBatch:function(a,b){var c;if(this.canvasContext.lineWidth=this._currentDrawingOptions.strokeWidth,this.canvasContext.lineCap='square',this.canvasContext.save(),this.clipPath&&this.drawClipPath(),this._currentDrawingOptions.currentBatchStartIndex=this._currentDrawingOptions.lastPointRenderedIndex,this.multiPath||(a=this._currentDrawingOptions.lastPointRenderedIndex,c=this.chartData.slice(a,b)),this.gradientLine||this.categoryKey)for(var d,e=a;e<b;e++)d=this._currentDrawingOptions.getColorValue(this.chartData[e]),d&&(this.canvasContext.beginPath(),this.canvasContext.strokeStyle=d,this.line(this.chartData[e]),this.canvasContext.stroke());else{if(this.canvasContext.beginPath(),!this.multiPath)opacity=this._isSerieMuted(c)?this._currentDrawingOptions.mutedOpacity:1,0!==opacity&&this.line(c);else for(var e=a;e<b;e++)opacity=this._isSerieMuted(this.chartData[e])?this._currentDrawingOptions.mutedOpacity:1,0!==opacity&&this.line(this.chartData[e]);var f=this.completeSeriesConfig[this.seriesId]&&this.completeSeriesConfig[this.seriesId].dashPattern?this.completeSeriesConfig[this.seriesId].dashPattern:'';f=JSON.parse('['+f+']'),this.canvasContext.setLineDash(f),this.canvasContext.strokeStyle=this.rgbToRgba(this.completeSeriesConfig[this.seriesId].color,opacity),this.canvasContext.stroke()}this.canvasContext.restore()},_isSerieMuted:function(a){return this.multiPath?!!this.mutedSeries[a[this.seriesId]]:!!this.mutedSeries[this.seriesId]},_canvasLineColor:function(a,b){var c=this.categoryKey?a[this.categoryKey]:this.seriesId;return this._colorArr[c]?'rgba('+this._colorArr[c].r+','+this._colorArr[c].g+','+this._colorArr[c].b+','+b+')':null},rgbToRgba:function(a,b){var c=a.slice(0,a.length-1);return c='rgba'+c.slice(3),c+','+b+')'}});</script></body></html>