<html><head><link rel="import" href="../polymer/polymer.html"><link rel="import" href="px-vis-behavior-common.html"><link rel="import" href="px-vis-behavior-d3.html"><script>var PxVisBehaviorScale=PxVisBehaviorScale||{};PxVisBehaviorScale.scale=[{properties:{_extents:{type:Array,value:function(){return[[],[]]}},_chartDataHasChanged:{type:Number,value:0},_calculatingDomain:{type:Boolean,value:!1},_defaultScaleValue:{type:Object,value:function(){return{x:[Infinity,-Infinity],y:[Infinity,-Infinity]}}},disableDynamicUpdate:{type:Boolean,value:!1},_runOnce:{type:Boolean,value:!1},chartId:{type:String},logBase:{type:String,value:10}},listeners:{"px-vis-request-pixel-for-data":"_pixelRequest"},_recreateScales:function(a,b,c){this._calculatingDomain=!0,this.x&&this._internalSetXScale(a,c,!0),this.y&&(this.isMultiY?this._internalSetMultiYScale(b,c,this.axes,!0):this._internalSetYScale(b,c,!0)),this._calculatingDomain=!1},_setXScale:function(a,b){this.hasUndefinedArguments(arguments)||this._internalSetXScale(a,b,!1)},_internalSetXScale:function(a,b,c){var d=Math.max(a-b.left-b.right,0);this.x&&this.x._scaleType===this.xAxisType&&!c?(this.x.range([0,d]),null!==this.domainChanged&&this.set("domainChanged",!this.domainChanged)):this.set("x",this._setScale(this.xAxisType,[0,d],this.x))},_setYScale:function(a,b){this.hasUndefinedArguments(arguments)||this._internalSetYScale(a,b,!1)},_internalSetYScale:function(a,b,c){var d=Math.max(a-b.top-b.bottom,0);this.y&&this.y._scaleType===this.yAxisType&&!c?(this.y.range([d,0]),null!==this.domainChanged&&this.set("domainChanged",!this.domainChanged)):this.set("y",this._setScale(this.yAxisType,[d,0],this.y))},_setMultiYScale:function(a,b,c){this.hasUndefinedArguments(arguments)||this._internalSetMultiYScale(a,b,c,!1)},_internalSetMultiYScale:function(a,b,c,d){var e,f,g=Math.max(a-b.top-b.bottom,0),h=!1,j=!1;f=this.y?this.y:{};for(var k=0;k<this.axes.length;k++)f[this.axes[k]]&&f[this.axes[k]]._scaleType===this.yAxisType&&!d?(f[this.axes[k]].range([g,0]),h=!0):(e=this._setScale(this.yAxisType,[g,0],f,!0,this.axes[k]),f[this.axes[k]]=e,j=!0);j&&this.set("y",f),h&&null!==this.domainChanged&&this.set("domainChanged",!this.domainChanged)},_setScale:function(a,b,c,d,e){var f,d=d||!1;return"time"===a?(f=Px.d3.scaleUtc().nice().range(b),f._scaleType="time"):"timeLocal"===a?(f=Px.d3.scaleTime().nice().range(b),f._scaleType="timeLocal"):"linear"===a?(f=Px.d3.scaleLinear().nice().range(b),f._scaleType="linear"):"log"===a?(f=Px.d3.scaleLog().nice().base(this.logBase).range(b),f._scaleType="log"):"scaleBand"===a?(f=Px.d3.scaleBand().range(b).round(!0).paddingInner(0.5),f._scaleType="scaleBand"):(f=Px.d3.scalePoint().range(b).padding(0.5),f._scaleType="ordinal"),c&&d&&c[e]?f.domain(c[e].domain()):c&&!d&&f.domain(c.domain()),f},_setDomain:function(){this.hasUndefinedArguments(arguments)||this.debounce("_setDomain",function(){if(!(this._calculatingDomain||this._isObjEmpty(this.chartData)||!this.x||!this.y||this._isObjEmpty(this.completeSeriesConfig))){if(this._calculatingDomain=!0,!this.chartId||this.preventWebWorkerSynchronization){var a=this._determineExtents();return void this._applyExtents(a)}var b={};b.xAxisType=this.xAxisType,b.yAxisType=this.yAxisType,b.completeSeriesConfig=this.completeSeriesConfig,b.chartExtents=this.chartExtents,b.dataExtents=this.dataExtents,b.axes=this.axes,b.seriesToAxes=this.seriesToAxes,b.isYAxisObject="object"===babelHelpers.typeof(this.y),b.hardMute=this.hardMute,b.mutedSeries=this.mutedSeries,Px.vis.scheduler.process({action:"determineExtents",originatorName:this.nodeName,chartId:this.chartId,data:b,successCallback:function(a){a.data&&this._applyExtents(a.data)}.bind(this)})}}.bind(this),10)},_applyExtents:function(a){if("object"===babelHelpers.typeof(this.y)){for(var b=0;b<this.axes.length;b++)if(this.y[this.axes[b]])if("log"===this.yAxisType&&(a.y[this.axes[b]]=this._fixLogExt(a.y[this.axes[b]])),this.matchTicks&&!this.singleDomain){var c=10*Math.floor(a.y[this.axes[b]][0]/10),d=10*Math.ceil(a.y[this.axes[b]][1]/10);this.y[this.axes[b]].domain([c,d])}else this.y[this.axes[b]].domain(a.y[this.axes[b]]);}else"log"===this.yAxisType&&(a.y=this._fixLogExt(a.y)),this.y.domain(a.y);"log"===this.xAxisType&&(a.x=this._fixLogExt(a.x)),this.disableDynamicUpdate?!this.runOnce&&(this.x.domain(a.x),this.set("domainChanged",!(null!==this.domainChanged)||!this.domainChanged),this.runOnce=!0):(this.x.domain(a.x),this.set("domainChanged",!(null!==this.domainChanged)||!this.domainChanged)),this._calculatingDomain=!1},_determineExtents:function(){var a="ordinal"===this.xAxisType||"scaleBand"===this.xAxisType,b="ordinal"===this.yAxisType||"scaleBand"===this.yAxisType,c="time"===this.xAxisType||"timeLocal"===this.xAxisType,d=!c,e=!0,f=Object.keys(this.completeSeriesConfig),g={x:[],y:[]};if(g.x=this._checkForExtents(a,this.chartExtents,this.dataExtents,"x"),g.y="object"===babelHelpers.typeof(this.y)?this._calcMultiAxisExtents():this._checkForExtents(b,this.chartExtents,this.dataExtents,"y"),0<g.x.length&&g.x[0]!==Infinity&&g.x[1]!==-Infinity&&(c=!1,d=!1),(!Array.isArray(g.y)||0<g.y.length&&g.y[0]!==Infinity&&g.y[1]!==-Infinity)&&(e=!1),0===this.chartData.length&&(c=!1,d=!1,e=!1),(d||e||c)&&this._findMinMax(this.chartData,d,e,a,b,c,g,f),this._chartDataHasChanged=0,g.x[0]===Infinity&&(g.x[0]=0),g.x[1]===-Infinity&&(g.x[1]=1),Array.isArray(g.y)&&g.y[0]===Infinity&&(g.y[0]=0),Array.isArray(g.y)&&g.y[1]===-Infinity&&(g.y[1]=1),g.x[1]===g.x[0]&&(g.x[0]-=0.5,g.x[1]+=0.5),Array.isArray(g.y))g.y[1]===g.y[0]&&(g.y[0]-=0.5,g.y[1]+=0.5);else for(var h=Object.keys(g.y),j=0;j<h.length;j++)g.y[h[j]][0]===g.y[h[j]][1]&&(g.y[h[j]][0]-=0.5,g.y[h[j]][1]+=0.5);return g},_checkForExtents:function(a,b,c,d){var e=[];if(a)c&&c[d]&&(e=JSON.parse(JSON.stringify(c[d]))),b&&b[d]&&(e=JSON.parse(JSON.stringify(b[d])));else{var f=!1;e=this._checkChartExtents(b,d),f=!(2!==e.length),e=this._checkDataExtents(c,b,d,f,e),2>e.length&&(e=[this._defaultScaleValue[d][0],this._defaultScaleValue[d][1]])}return e},_checkChartExtents:function(a,b){var c=[];return a&&a[b]&&2===a[b].length&&(c[0]="dynamic"===a[b][0]?Infinity:a[b][0],c[1]="dynamic"===a[b][1]?-Infinity:a[b][1]),c},_checkDataExtents:function(a,b,c,d,e){var e=e||[];return a&&a[c]&&2===a[c].length&&(d?(e[0]="dynamic"===b[c][0]?a[c][0]:b[c][0],e[1]="dynamic"===b[c][1]?a[c][1]:b[c][1]):(e[0]=Math.min(a[c][0],this._defaultScaleValue[c][0]),e[1]=Math.max(a[c][1],this._defaultScaleValue[c][1]))),e},_findMinMax:function(a,b,c,d,e,f,g,h){var i,j,k,l=a.length,m=this.completeSeriesConfig[h[0]].x,n=this.completeSeriesConfig[h[0]].y,o=d||g.x[0]!==Infinity?!1:!0,p=d||g.x[1]!==-Infinity?!1:!0,q=e||g.y[0]!==Infinity?!1:!0,r=e||g.y[1]!==-Infinity?!1:!0;for(f&&this._findTimeMM(g,a,l,m,o,p),i=0;i<l;i++)j=this._getDataExtents(a[i],h,"x"),k=this._getDataExtents(a[i],h,"y"),b&&this._processDataValues(d,g,a,"x",m,i,o,p,j[0],j[1]),c&&this._processDataValues(e,g,a,"y",n,i,q,r,k[0],k[1])},_getDataExtents:function(b,c,d){for(var e,f=[],a=0;a<c.length;a++)if(e=c[a],!this.mutedSeries[c[a]]){var g=b[this.completeSeriesConfig[e][d]];(g||0===g)&&f.push(g)}return[Math.min.apply(null,f),Math.max.apply(null,f)]},_findTimeMM:function(a,b,c,d,e,f){e&&this._setMin(a.x,b[0][d]),f&&this._setMax(a.x,b[c-1][d])},_setMin:function(a,b){(isNaN(a[0])||a[0]>b)&&(a[0]=b)},_setMax:function(a,b){(isNaN(a[1])||a[1]<b)&&(a[1]=b)},_processDataValues:function(a,b,c,d,e,f,g,h,i,j){a?-1===b[d].indexOf(c[f][e])&&b[d].push(c[f][e]):(g&&this._setMin(b[d],i),h&&this._setMax(b[d],j))},_checkInSeriesConfig:function(b,c){for(var a,d=0;d<this.seriesToAxes[c].length;d++)a=this.seriesToAxes[c][d],this.hardMute&&this.mutedSeries[a]||(b[c][0]=this.completeSeriesConfig[a].yMin||0===this.completeSeriesConfig[a].yMin?Math.min(this.completeSeriesConfig[a].yMin,b[c][0]):b[c][0],b[c][1]=this.completeSeriesConfig[a].yMax||0===this.completeSeriesConfig[a].yMax?Math.max(this.completeSeriesConfig[a].yMax,b[c][1]):b[c][1])},_applyChartExtents:function(b,c){var a=this.chartExtents[c]?c:"y";this.chartExtents[a]&&(b[c][0]="dynamic"===this.chartExtents[a][0]?b[c][0]||0===b[c][0]?b[c][0]:Infinity:this.chartExtents[a][0],b[c][1]="dynamic"===this.chartExtents[a][1]?b[c][1]||0===b[c][1]?b[c][1]:-Infinity:this.chartExtents[a][1])},_searchForExtents:function(a,b,c){for(var d=Object.keys(b),e=0;e<c.length;e++)for(var f=0;f<d.length;f++){var g=d[f],h=this.completeSeriesConfig[g].y,i=b[g],j=i.axis;i.min&&(c[e][h]||0===c[e][h])&&(a[j][0]=Math.min(c[e][h],a[j][0])),i.max&&(c[e][h]||0===c[e][h])&&(a[j][1]=Math.max(c[e][h],a[j][1]))}},_calcSeriesToSearch:function(b,c,d){for(var e,f=0;f<this.seriesToAxes[c].length;f++)e=this.seriesToAxes[c][f],this.hardMute&&this.mutedSeries[e]||(d[e]={axis:c,min:b[c][0]===Infinity,max:b[c][1]===-Infinity})},_calcMultiAxisExtents:function(){for(var b,a,c=!1,d={},e={},f=0;f<this.axes.length;f++)b=this.axes[f],d[b]=[],d[b][0]=this._defaultScaleValue.y[0],d[b][1]=this._defaultScaleValue.y[1],this._checkInSeriesConfig(d,b),this.chartExtents&&this._applyChartExtents(d,b),(d[b][0]===Infinity||d[b][1]===-Infinity)&&(c=!0,this._calcSeriesToSearch(d,b,e));c&&this._searchForExtents(d,e,this.chartData),a=Object.keys(d);for(var f=0;f<a.length;f++)(d[a[f]][0]===Infinity||d[a[f]][1]===-Infinity)&&(d[a[f]]=[0,1]);return d},_updateDomain:function(a){if(!this.hasUndefinedArguments(arguments)&&this.x&&this.y)if("reset"===a||"rereset"===a)this._setDomain();else{if(0<a.x.length&&this.x.domain(a.x),"object"===babelHelpers.typeof(this.y)&&!Array.isArray(a.y))for(var b=0;b<this.axes.length;b++)this.y[this.axes[b]].domain(a.y[this.axes[b]]);else"function"===typeof this.y&&0<a.y.length&&this.y.domain(a.y);this.set("domainChanged",!this.domainChanged)}},_chartDataChanged:function(){this.hasUndefinedArguments(arguments)||this.set("_chartDataHasChanged",this._chartDataHasChanged++)},_setAxisScale:function(a,b,c,e){var a=a||[],b=b||[],d=a.concat(b),c=c||50,e=e||50;if(0!==d.length){var f=function(f){return-1===a.indexOf(f)?-1===b.indexOf(f)?void 0:b.indexOf(f)*e:-1*(a.indexOf(f)*c)};return f.domain=function(){return d},f.leftDomain=function(b){return b&&(a=b),a},f.rightDomain=function(a){return a&&(b=a),b},f}},getPixelFromData:function(a,b,c){var d,e,f=c?c:this.margin,g=!1,h=this.y[this.completeSeriesConfig[b].axis.id].domain();return(a[0]<this.x.domain()[0]||a[0]>this.x.domain()[1]||a[1]<h[0]||a[1]>h[1])&&(g=!0),d=this.x(a[0])+ +f.left,e=this.y[this.completeSeriesConfig[b].axis.id](a[1])+f.top,{pixel:[d,e],outOfBounds:g}},getDataFromPixel:function(a,b){var c,d;return c=this.x.invert(a[0]),d=this.y[this.completeSeriesConfig[b].axis.id].invert(a[1]),[c,d]},_pixelRequest:function(a){var b=this.getPixelFromData(a.detail.data,a.detail.series,a.detail.margin);a.detail.callback(b)},_updateLogBase:function(){var a=!1;if("log"===this.xAxisType&&this.x&&this.x.base&&(this.x.base(this.logBase),a=!0),"log"===this.yAxisType&&this.y)if("function"===typeof this.y)this.y.base(this.logBase),a=!0;else if("object"===babelHelpers.typeof(this.y)){for(var b=0;b<this.axes.length;b++)this.y[this.axes[b]]&&this.y[this.axes[b]].base&&this.y[this.axes[b]].base(this.logBase);a=!0}a&&null!==this.domainChanged&&this.set("domainChanged",!this.domainChanged)},_fixLogExt:function(a){var b=Math.abs;return 0>=a[0]&&0>=a[1]?a[1]=0===a[1]?-1:a[1]:0<=a[0]&&0<=a[1]?a[0]=0===a[0]?1:a[0]:(console.warn("log domain crosses 0, which is invalid"),b(a[0])>b(a[1])?a[1]=0===a[1]?-1:a[1]:a[0]=0===a[0]?1:a[0]),a}},PxVisBehavior.sizing,PxVisBehaviorD3.axes,PxVisBehavior.dataset,PxVisBehavior.commonMethods,PxVisBehaviorD3.selectedDomain,PxVisBehavior.axisTypes,PxVisBehavior.completeSeriesConfig,PxVisBehavior.chartExtents,PxVisBehavior.dataExtents,PxVisBehaviorD3.domainUpdateNotify,PxVisBehavior.preventWebWorkerSynchronization,PxVisBehavior.mutedSeries,PxVisBehavior.observerCheck];</script></head><body></body></html>