<html><head><link rel="import" href="../polymer/polymer.html"><link rel="import" href="px-vis-behavior-common.html"><link rel="import" href="px-vis-behavior-d3.html"><link rel="import" href="../px-tooltip/px-tooltip.html"><link rel="import" href="css/px-vis-styles.html"></head><body><dom-module id="px-vis-axis"><template><style include="px-vis-styles"></style><template id="tooltipTemplate" is="dom-if" if="[[_titleTruncated]]"><px-tooltip id="tooltip" delay="500">{{title}} {{_currentUnits}}</px-tooltip></template></template></dom-module><script>Polymer({is:'px-vis-axis',behaviors:[PxVisBehavior.observerCheck,PxVisBehaviorD3.svg,PxVisBehavior.sizing,PxVisBehaviorD3.axis,PxVisBehavior.completeSeriesConfig,PxVisBehavior.commonMethods,PxVisBehaviorD3.axisConfig,PxVisBehavior.truncating,PxVisBehaviorD3.domainUpdate,PxVisBehavior.preventInitialDrawing,PxVisBehavior.isAttached,PxVisBehavior.updateStylesOverride,PxVisBehavior.titleTruncation],properties:{_axis:{type:Object,value:function(){return{}}},_axisGroup:{type:Object},axisId:{type:String,value:'',reflectToAttribute:!0},displayedTitle:{type:String,notify:!0},appendUnitInTitle:{type:Boolean,value:!1},preventSeriesBar:{type:Boolean,value:!1},titleDrawn:{type:Boolean,value:null},seriesId:{type:String},_currentUnits:{type:String,value:'',computed:'_computeUnits(appendUnitInTitle, title, unit)'},_titleTruncated:{type:Boolean,value:!1},tickFormat:{type:String},axisType:{type:String,value:'linear'},rotation:{type:Number},offset:{type:Array,value:[0,0]},disableTicks:{type:Boolean,value:!1},_titleGroup:{type:Object},_animationFrameDone:{type:Boolean,value:!1},seriesOnAxis:{type:Array,value:function(){return[]}},rebuildOnDraw:{type:Boolean,value:!1},_removingAxis:{type:Boolean,value:!1},_tooltipElem:{type:HTMLElement},_axisDrawn:{type:Number,value:0},unit:{type:String,value:''}},observers:['drawElement(domainChanged, svg, axis, margin, width, height, disableTicks, _animationFrameDone, preventInitialDrawing, _isAttached, _stylesUpdated)','_calcDrawnTicks(domainChanged)','drawSeriesBars(completeSeriesConfig.*, titleDrawn)','_muteSeriesBars(mutedSeries.*)','_updateTicks(ticks)','_updateTicks(tickFormat)','_updateTicks(tickValues)','_titleChanged(displayedTitle, _axisDrawn, titleLocation.*)','_truncateTitle(title, truncationLength, appendUnitInTitle, completeSeriesConfig, _currentUnits)','_orientationChanged(orientation)'],detached:function(){this.removeAll(),this.drawnTickValues&&0<this.drawnTickValues.length&&(this.set('drawnTickValues',[]),this.fire('px-vis-axis-drawn-tick-values-changed',{drawnTickValues:[]}))},ready:function(){window.requestAnimationFrame(function(){this.set('_animationFrameDone',!0)}.bind(this)),this.axisId||this.set('axisId',this.generateRandomID('axis_'))},attached:function(){this._axisGroup&&this.fire('px-axis-done')},defineAxis:function(){var a=Math.max;switch(this.orientation){case'bottom':this._axis=Px.d3.axisBottom(this.axis);var b=a(this.height-this.margin.bottom-this.margin.top,0);this.translateAmt=[this.offset[0],this.offset[1]+b];break;case'top':this._axis=Px.d3.axisTop(this.axis),this.translateAmt=[this.offset[0],this.offset[1]];break;case'right':this._axis=Px.d3.axisRight(this.axis);var c=a(this.width-this.margin.left-this.margin.right,0);this.translateAmt=[this.offset[0]+c,this.offset[1]];break;default:this._axis=Px.d3.axisLeft(this.axis),this.translateAmt=[this.offset[0],this.offset[1]];}this._processTicks()},_processTicks:function(){this.ticks&&'ordinal'!==this.axisType&&('number'!==typeof this.ticks&&isNaN(parseInt(this.ticks))?'function'===typeof this.ticks?this._axis.ticks(this.ticks):'object'===babelHelpers.typeof(this.ticks)&&this.ticks.interval&&this.ticks.format?this._axis.ticks(this.ticks.interval,this.ticks.format):'object'===babelHelpers.typeof(this.ticks)&&this.ticks.interval&&'time'!==this.axisType||'timeLocal'!==this.axisType?this._axis.ticks(this.ticks.interval):'object'===babelHelpers.typeof(this.ticks)&&this.ticks.format&&'time'!==this.axisType||'timeLocal'!==this.axisType?this._axis.ticks(10,this.ticks.format):console.error('Cannot interpret axis ticks'):this._axis.ticks(this.ticks)),this.tickFormat&&'ordinal'!==this.axisType&&('function'===typeof this.tickFormat?this._axis.tickFormat(this.tickFormat):'time'===this.axisType?this._axis.tickFormat(Px.d3.utcFormat(this.tickFormat)):'timeLocal'===this.axisType?this._axis.tickFormat(Px.d3.timeFormat(this.tickFormat)):'linear'===this.axisType&&this._axis.tickFormat(Px.d3.format(this.tickFormat))),this.tickValues&&0<this.tickValues.length&&'ordinal'!==this.axisType&&!isNaN(this.axis.domain()[0])&&!isNaN(this.axis.domain()[1])&&this._axis.tickValues(this.tickValues),this._axis.tickSizeOuter(this.outerTickSize),this.disableTicks&&this._axis.ticks(0),'inline'===this.labelPosition?this._axis.tickSizeInner(0):'center'!==this.labelPosition&&this._axis.tickSizeInner(this.labelTypeSize)},removeAll:function(){this.removeTitle(),this.removeAxis()},removeAxis:function(){this._removingAxis=!0,this._axisDrawn=0,this._axisGroup&&(this._axisGroup.remove(),this._axisGroup=null),this._removingAxis=!1},removeTitle:function(){this._titleGroup&&(this._titleGroup.remove(),this._titleGroup=null)},drawElement:function(){this.hasUndefinedArguments(arguments)||babelHelpers.typeof(this.preventInitialDrawing)!==void 0&&!1===this.preventInitialDrawing&&this.debounce('drawaxis',function(){this._isAttached&&this._animationFrameDone&&this._doesD3HaveValues(this.svg)&&null!==this.domainChanged&&this.orientation&&this.axis&&(this.rebuildOnDraw&&this.removeAxis(),this.defineAxis(),this._axisGroup?this._updateAxis():this._buildAxis(),this._axisDrawn+=1,this.fire('px-axis-done'))},10)},_updateAxis:function(){this._axisGroup.attr('transform',function(){return this.rotation?'rotate('+ +this.rotation+') translate('+this.translateAmt.join(',')+')':'translate('+this.translateAmt.join(',')+')'}.bind(this)).call(this._axis),this._setLineStyles(this._axisGroup,'line,path'),this._setLabelStyles(this._axisGroup),this._calcDrawnTicks()},_buildAxis:function(){var a=this.svg.append('g').attr('class','axis').attr('axis-id',this.axisId).attr('transform',function(){return this.rotation?'rotate('+ +this.rotation+') translate('+this.translateAmt.join(',')+')':'translate('+this.translateAmt.join(',')+')'}.bind(this)).call(this._axis);a.select('path.domain').attr('stroke',this.axisColor?this.axisColor:this._checkThemeVariable('--px-vis-axis-color','black')),this.set('_axisGroup',a),this._setLineStyles(this._axisGroup,'line,path'),this._setLabelStyles(this._axisGroup),this._calcDrawnTicks()},_updateTicks:function(){this.hasUndefinedArguments(arguments)||this._doesObjHaveValues(this._axis)&&this.axis&&this.margin&&this.height&&'undefined'!==typeof this.disableTicks&&this.drawElement()},_calcDrawnTicks:function(){this.hasUndefinedArguments(arguments)||'ordinal'!==this.axisType&&this._axis&&this._axis.scale&&this.debounce('drawnTicks',function(){this.ticks&&'number'===typeof this.ticks?this.set('drawnTickValues',this._axis.scale().ticks(this.ticks)):this.set('drawnTickValues',this._axis.scale().ticks()),this.fire('px-vis-axis-drawn-tick-values-changed',{drawnTickValues:this.drawnTickValues})},1)},setLabelDims:function(){var a={};if('inline'===this.labelPosition)return'left'===this.orientation||'right'===this.orientation?(a.x=0,a.y=0,a.anchor='middle'):(a.x=0,a.y=-this.labelTypeSize/3,a.anchor='middle'),a;switch(this.orientation){case'bottom':a.x=5,a.y=this.labelTypeSize/4,a.anchor='after'===this.labelPosition?'start':'end';break;case'top':a.x=5,a.y=this.labelTypeSize/-4,a.anchor='after'===this.labelPosition?'start':'end';break;case'left':a.x=-2*this.labelTypeSize/3,a.y='after'===this.labelPosition?-2*this.labelTypeSize/3:2*this.labelTypeSize/3,a.anchor='end';break;case'right':a.x=2*this.labelTypeSize/3,a.y='after'===this.labelPosition?-2*this.labelTypeSize/3:2*this.labelTypeSize/3,a.anchor='start';}return a},_setLabelStyles:function(a){if(a.selectAll('text').attr('font-size',this.labelTypeSize+'px').style('font-family',this._checkThemeVariable('--px-vis-font-family','Comic Sans MS')).attr('font-style',this._checkThemeVariable('--px-vis-font-family','Comic Sans MS')),'inline'!==this.labelPosition&&(a.selectAll('text').attr('fill',this.axisColor?this.axisColor:this._checkThemeVariable('--px-vis-axis-color','black')),a.selectAll('g.tick').selectAll('line').attr('stroke',this.axisColor?this.axisColor:this._checkThemeVariable('--px-vis-axis-color','black'))),'center'!==this.labelPosition){var b=this.setLabelDims();a.selectAll('text').attr('y',b.y).attr('x',b.x).attr('text-anchor',b.anchor).style('text-anchor',b.anchor).attr('transform','rotate('+this.labelRotation+') translate('+this.labelTranslation.join(',')+')')}if('inline'===this.labelPosition){var c=a.selectAll('g.tick'),e=c.select('text');c.selectAll('rect').remove(),c.insert('rect','text').attr('x',function(a,b){return e.nodes()[b].getBoundingClientRect().width/-2-3}).attr('y',-0.5*this.labelTypeSize-2).attr('width',function(a,b){return e.nodes()[b].getBoundingClientRect().width+6}).attr('height',this.labelTypeSize+4).attr('fill',this.axisColor?this.axisColor:this._checkThemeVariable('--px-vis-axis-inline-box-color','black')).attr('transform','rotate('+this.labelRotation+')'),e.attr('fill',this._checkThemeVariable('--px-vis-axis-inline-type-color','rbg(255,255,255)'))}},_setLineStyles:function(a,b){var c='inline'===this.labelPosition?'--px-vis-axis-inline-box-color':'--px-vis-axis-color';a.selectAll(b).attr('fill','none').attr('stroke',this.axisColor?this.axisColor:this._checkThemeVariable(c,'black')).attr('shape-rendering','crispEdges').attr('stroke-width',this.strokeWidth)},_getAxisGroupSize:function(){var a;try{a=this._axisGroup.node().getBBox()}catch(b){a=this._axisGroup.node().getBoundingClientRect()}return a},_calcTopBottomLabelSize:function(){return'center'===this.labelPosition?this.labelTypeSize:0},_calcLeftRightLabelSize:function(){var a=Math.max,b=0;if('time'===this.axisType||'timeLocal'===this.axisType||'ordinal'===this.axisType)b=parseFloat(this._getAxisGroupSize().width);else{var c=null;this.ticks&&'number'===typeof this.ticks?c=this.ticks:this.ticks&&'object'===babelHelpers.typeof(this.ticks)&&this.ticks.interval&&(c=this.ticks.interval);var d=0,e=this.tickValues?this.tickValues:this.axis.ticks(c),f=this.tickFormat?this._axis.tickFormat():this.axis.tickFormat(),g=f(e[0]),h=f(e[e.length-1]);d=a(g.length,d),d=a(h.length,d),b=0.5*(d*this.labelTypeSize)+0.5*this.labelTypeSize}return b},drawTitle:function(){this.removeTitle();var a,b,c,d,e={},f=this._doesObjHaveValues(this.titleLocation)?'custom':this.orientation;'bottom'===f?(e.width=(this.axis.range()[1]-this.axis.range()[0])/2,e.height=this.labelRotation?parseFloat(this._getAxisGroupSize().height):this._axis.tickSizeInner()+this._calcTopBottomLabelSize()+this.labelTranslation[1]+this.titleTypeSize+5,a=e.width+this.translateAmt[0],b=e.height+this.translateAmt[1],c=0,d='middle'):'top'===f?(e.width=(this.axis.range()[1]-this.axis.range()[0])/2,e.height=this.labelRotation?parseFloat(this._getAxisGroupSize().height):this._axis.tickSizeInner()+this._calcTopBottomLabelSize()+this.labelTranslation[1]+5,a=e.width+this.translateAmt[0],b=-e.height+this.translateAmt[1],c=0,d='middle'):'left'===f?(e.width=this.labelRotation?-1*parseFloat(this._getAxisGroupSize().width):this._axis.tickSizeInner()+this._calcLeftRightLabelSize()+this.labelTranslation[0]+5,e.height=(this.axis.range()[1]-this.axis.range()[0])/2,a=-e.width+this.translateAmt[0],b=-e.height+this.translateAmt[1],c=-90,d='middle'):'right'===f?(e.width=this.labelRotation?parseFloat(this._getAxisGroupSize().width):this._axis.tickSizeInner()+this._calcLeftRightLabelSize()+this.labelTranslation[0]+this.titleTypeSize,e.height=(this.axis.range()[1]-this.axis.range()[0])/2,a=e.width+this.translateAmt[0],b=-e.height+this.translateAmt[1],c=-90,d='middle'):'custom'===f?(a=this.titleLocation.x,b=this.titleLocation.y,c=this.titleLocation.r,d=this.titleLocation.anchor):void 0;this._titleGroup=this.svg.append('g').attr('class','title-group').attr('for',this.axisId).attr('transform','translate('+a+','+b+')');var g='inline'===this.labelPosition?'--px-vis-axis-inline-title-color':'--px-vis-axis-title-color';this._titleGroup.append('text').attr('class','axis-title').attr('fill',this.axisColor?this.axisColor:this._checkThemeVariable(g,'black')).attr('font-size',this.titleTypeSize+'px').style('font-family',this._checkThemeVariable('--px-vis-font-family','Comic Sans MS')).attr('font-style',this._checkThemeVariable('--px-vis-font-family','Comic Sans MS')).text(this.displayedTitle).attr('text-anchor',d).style('text-anchor',d).attr('transform','rotate('+c+')'),this._processTooltip(),this.set('titleDrawn',!(null!==this.titleDrawn)||!this.titleDrawn)},drawSeriesBars:function(){if(!this.hasUndefinedArguments(arguments)&&!this.preventSeriesBar&&this._doesObjHaveValues(this.completeSeriesConfig)&&this._axisGroup&&this._titleGroup){var a,b=0<this.seriesOnAxis.length?this.seriesOnAxis:Object.keys(this.completeSeriesConfig),c=b.length;for(a=0;a<c;a++)this.completeSeriesConfig[b[a]]&&this._drawBar(this._titleGroup,b[a],this.completeSeriesConfig[b[a]].color,a,this.completeSeriesConfig[b[a]].dashPattern)}},_muteSeriesBars:function(){if(!this.hasUndefinedArguments(arguments)&&this._doesD3HaveValues(this._titleGroup)&&!this.preventSeriesBar)for(var a,b=Object.keys(this.mutedSeries),c=0;c<b.length;c++)a=this._titleGroup.select('[series-bar-id=bar_'+this._escapeCssSelector(b[c])+']'),this.mutedSeries[b[c]]?a.attr('opacity',0.5):a.attr('opacity',1)},_drawBar:function(a,b,c,d,e){var f=a.select('.axis-title').node().getComputedTextLength(),g=this.mutedSeries&&this.mutedSeries[b]?0.5:1;a.append('line').attr('x1',0).attr('x2',15).attr('y1',0).attr('y2',0).attr('stroke',c).attr('stroke-width',3).attr('stroke-dasharray',e).attr('series-bar-id','bar_'+b).attr('transform','translate(-12,'+(-f/2-10-8*d)+')').attr('opacity',g)},_computeUnits:function(a){if(void 0!==a){var b='';return a&&this.unit&&(b=' ['+this.unit+']'),b}},_truncateTitle:function(a,b){this.hasUndefinedArguments(arguments)||this.debounce('_truncateTitle',function(){var c,d=this.displayedTitle;this.titleTruncation&&2<a.length&&a.length>this.truncationLength?(c=this._truncateName(a,b)+this._currentUnits,this.set('_titleTruncated',!0)):(c=a+this._currentUnits,this.set('_titleTruncated',!1)),c!==d&&(this._processTooltip(),this.fire('px-vis-axis-displayed-title-changed',{displayedTitle:c,title:this.title,id:this.seriesId}),this.set('displayedTitle',c))},5)},_titleChanged:function(){this.hasUndefinedArguments(arguments)||!this._removingAxis&&this._axisDrawn&&this.drawTitle()},_processTooltip:function(){this._titleTruncated?(!this._tooltipElem&&(this._tooltipElem=this.$$('px-tooltip')),this._tooltipElem&&this._titleGroup&&this._tooltipElem.for!==this._titleGroup.node()&&(this._tooltipElem.for=this._titleGroup.node())):this._tooltipElem&&(this._tooltipElem.for=null)},_orientationChanged:function(){this.hasUndefinedArguments(arguments)||(this.removeAxis(),this.drawElement())}});</script></body></html>